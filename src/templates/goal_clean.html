{% extends 'base/base.html' %}

{% block title %} {{ title }} {% endblock %}

{% block herotitle %} Definir objetivos {% endblock %}
{% block herosubtitle %} {% endblock %}
{% block contenttitle %} {% endblock %}
{% block contentsubtitle %} {% endblock %}

{% block content %}

    {% from "_macro.html" import render_field %}
    <div>
        <!-- Mensaje -->
        {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-danger alert-dismissable" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                    <p class="mb-0">{{ message }}</p>
                </div>
            {% endfor %}
        {% endif %}
        {% endwith %}
        <!-- END Mensaje -->
    </div>

    <!-- Sección de Objetivos Manuales -->
    <div class="block block-rounded">
        <div class="block-header block-header-default">
            <h3 class="block-title">
                <i class="fa fa-fw fa-edit text-primary mr-1"></i>
                Objetivos Manuales
            </h3>
        </div>
        <div class="block-content block-content-full">
            <form name="sentMessage" id="plannerForm" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="row push">
                    <div class="col-lg-2">
                        <p class="font-size-sm text-muted">
                        </p>
                    </div>
                    <div class="col-lg-8 col-xl-10">
                        <div class="form-row">
                            <div class="form-group col-md-12 font-size-sm">
                                <label>Apellido y nombre:</label>
                                {{ render_field(form.nameuser, class='form-control', id='nameuser-select') }}
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6 font-size-sm">
                                <label>Índice de masa magra corporal deseada: </label>
                                {{ render_field(form.goalimmc, class='form-control', value=defgoalimmc, id='goalimmc-input') }}  
                            </div>
                            <div class="form-group col-md-6 font-size-sm">
                                <label>Porcentaje de grasa corporal deseada: </label>
                                {{ render_field(form.goalbf, class='form-control', value=defgoalbf, id='goalbf-input') }}  
                            </div>
                        </div>
                        <div id="success" class="form-group row justify-content-center mb-0">
                            <div class="col-md-6 col-xl-5">
                                <button type="submit" class="btn btn-block btn-primary">
                                    <i class="fa fa-fw fa-calendar-check mr-1"></i> Guardar Objetivos
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Sección de Objetivos Automáticos -->
    <div class="block block-rounded" id="objetivos-automaticos-section" style="display: none;">
        <div class="block-header block-header-default">
            <h3 class="block-title">
                <i class="fa fa-fw fa-calculator text-primary mr-1"></i>
                Objetivos Automáticos - Límite Genético
            </h3>
        </div>
        <div class="block-content" id="objetivos-automaticos-content">
            <div class="row text-center" id="loading-objetivos">
                <div class="col-12">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Cargando...</span>
                    </div>
                    <p class="mt-2 text-muted">Calculando objetivos automáticos...</p>
                </div>
            </div>
            <div id="objetivos-automaticos-data" style="display: none;">
                <!-- Datos Actuales -->
                <div class="row">
                    <div class="col-lg-6">
                        <div class="block block-rounded block-bordered">
                            <div class="block-header block-header-default bg-primary-light">
                                <h3 class="block-title text-primary">
                                    <i class="fa fa-fw fa-user mr-1"></i>
                                    Estado Actual
                                </h3>
                            </div>
                            <div class="block-content">
                                <div class="row font-size-sm">
                                    <div class="col-6">
                                        <strong>Peso:</strong><br>
                                        <span id="peso-actual" class="font-weight-bold text-dark">-</span> kg
                                    </div>
                                    <div class="col-6">
                                        <strong>% Grasa:</strong><br>
                                        <span id="bf-actual" class="font-weight-bold text-dark">-</span>%
                                    </div>
                                    <div class="col-6 mt-2">
                                        <strong>FFMI:</strong><br>
                                        <span id="ffmi-actual" class="font-weight-bold text-dark">-</span>
                                    </div>
                                    <div class="col-6 mt-2">
                                        <strong>Peso Magro:</strong><br>
                                        <span id="peso-magro-actual" class="font-weight-bold text-dark">-</span> kg
                                    </div>
                                    <div class="col-6 mt-2">
                                        <strong>Peso Graso:</strong><br>
                                        <span id="peso-graso-actual" class="font-weight-bold text-dark">-</span> kg
                                    </div>
                                    <div class="col-6 mt-2" id="medida-actual-container">
                                        <strong id="medida-actual-label">Abdomen:</strong><br>
                                        <span id="medida-actual-valor" class="font-weight-bold text-dark">-</span> cm
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="block block-rounded block-bordered">
                            <div class="block-header block-header-default bg-success-light">
                                <h3 class="block-title text-success">
                                    <i class="fa fa-fw fa-trophy mr-1"></i>
                                    Objetivo Genético
                                </h3>
                            </div>
                            <div class="block-content">
                                <div class="row font-size-sm">
                                    <div class="col-6">
                                        <strong>Peso Objetivo:</strong><br>
                                        <span id="peso-objetivo" class="font-weight-bold text-success">-</span> kg
                                    </div>
                                    <div class="col-6">
                                        <strong>% Grasa Límite:</strong><br>
                                        <span id="bf-objetivo" class="font-weight-bold text-success">-</span>%
                                    </div>
                                    <div class="col-6 mt-2">
                                        <strong>FFMI Límite:</strong><br>
                                        <span id="ffmi-objetivo" class="font-weight-bold text-success">-</span>
                                    </div>
                                    <div class="col-6 mt-2">
                                        <strong>Peso Magro Obj.:</strong><br>
                                        <span id="peso-magro-objetivo" class="font-weight-bold text-success">-</span> kg
                                    </div>
                                    <div class="col-6 mt-2">
                                        <strong>Peso Graso Obj.:</strong><br>
                                        <span id="peso-graso-objetivo" class="font-weight-bold text-success">-</span> kg
                                    </div>
                                    <div class="col-6 mt-2" id="medida-objetivo-container">
                                        <strong id="medida-objetivo-label">Abdomen Obj.:</strong><br>
                                        <span id="medida-objetivo-valor" class="font-weight-bold text-success">-</span> cm
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cambios Necesarios -->
                <div class="row">
                    <div class="col-lg-6">
                        <div class="block block-rounded block-bordered">
                            <div class="block-header block-header-default bg-warning-light">
                                <h3 class="block-title text-warning">
                                    <i class="fa fa-fw fa-exchange-alt mr-1"></i>
                                    Cambios Necesarios
                                </h3>
                            </div>
                            <div class="block-content">
                                <div class="row font-size-sm">
                                    <div class="col-6">
                                        <strong>Peso:</strong><br>
                                        <span id="cambio-peso" class="font-weight-bold">-</span> kg
                                    </div>
                                    <div class="col-6">
                                        <strong>Peso Magro:</strong><br>
                                        <span id="cambio-peso-magro" class="font-weight-bold text-success">-</span> kg
                                    </div>
                                    <div class="col-6 mt-2">
                                        <strong>Peso Graso:</strong><br>
                                        <span id="cambio-peso-graso" class="font-weight-bold text-danger">-</span> kg
                                    </div>
                                    <div class="col-6 mt-2" id="cambio-medida-container">
                                        <strong id="cambio-medida-label">Abdomen:</strong><br>
                                        <span id="cambio-medida-valor" class="font-weight-bold">-</span> cm
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="block block-rounded block-bordered">
                            <div class="block-header block-header-default bg-info-light">
                                <h3 class="block-title text-info">
                                    <i class="fa fa-fw fa-clock mr-1"></i>
                                    Tiempo Estimado
                                </h3>
                            </div>
                            <div class="block-content">
                                <div class="row font-size-sm">
                                    <div class="col-6">
                                        <strong>Meses:</strong><br>
                                        <span id="tiempo-meses" class="font-weight-bold text-info">-</span>
                                    </div>
                                    <div class="col-6">
                                        <strong>Años:</strong><br>
                                        <span id="tiempo-años" class="font-weight-bold text-info">-</span>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="fa fa-info-circle mr-1"></i>
                                        Estimación basada en tasas de progreso naturales y seguras.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Objetivos Parciales Progresivos -->
                <div class="row">
                    <div class="col-12">
                        <div class="block block-rounded block-bordered">
                            <div class="block-header block-header-default bg-primary-light">
                                <h3 class="block-title text-primary">
                                    <i class="fa fa-fw fa-stairs mr-1"></i>
                                    Objetivos Parciales Progresivos
                                </h3>
                            </div>
                            <div class="block-content">
                                <div id="objetivos-parciales-list">
                                    <!-- Los objetivos parciales se cargarán aquí -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botón para usar objetivos automáticos -->
                <div class="row">
                    <div class="col-12 text-center">
                        <button type="button" class="btn btn-success" id="usar-objetivos-automaticos">
                            <i class="fa fa-fw fa-magic mr-1"></i>
                            Usar Objetivo Final Automático
                        </button>
                        <small class="d-block text-muted mt-2">
                            Los valores se copiarán automáticamente en el formulario manual
                        </small>
                    </div>
                </div>
            </div>
            <div id="objetivos-automaticos-error" class="text-center" style="display: none;">
                <div class="alert alert-warning">
                    <i class="fa fa-exclamation-triangle mr-1"></i>
                    <span id="error-message">Error al cargar los objetivos automáticos</span>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const nameUserSelect = document.getElementById('nameuser-select');
        const objetivosAutomaticosSection = document.getElementById('objetivos-automaticos-section');
        const loadingObjetivos = document.getElementById('loading-objetivos');
        const objetivosAutomaticosData = document.getElementById('objetivos-automaticos-data');
        const objetivosAutomaticosError = document.getElementById('objetivos-automaticos-error');
        const usarObjetivosBtn = document.getElementById('usar-objetivos-automaticos');
        const goalimmcInput = document.getElementById('goalimmc-input');
        const goalbfInput = document.getElementById('goalbf-input');

        let datosObjetivosActuales = null;

        // Función para mostrar objetivos parciales
        function mostrarObjetivosParciales(objetivos, sexo) {
            const container = document.getElementById('objetivos-parciales-list');
            
            if (!objetivos || objetivos.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No hay objetivos parciales recomendados para este usuario.</p>';
                return;
            }

            let html = '<ul class="timeline timeline-alt py-0">';
            
            objetivos.forEach((objetivo, index) => {
                // Determinar colores según tipo y prioridad
                const bgColor = objetivo.tipo === 'definicion' ? 'bg-danger' : 'bg-success';
                const iconoFa = objetivo.tipo === 'definicion' ? 'fa-fire' : 'fa-dumbbell';
                
                let medidaTexto = '';
                if (sexo === 'M') {
                    medidaTexto = `Abdomen: <a class="font-w600">${objetivo.medida_abdomen}cm</a>`;
                } else {
                    medidaTexto = `Cintura: <a class="font-w600">${objetivo.medida_cintura_cadera.cintura}cm</a>, Cadera: <a class="font-w600">${objetivo.medida_cintura_cadera.cadera}cm</a>`;
                }

                const cambioMusculoColor = objetivo.cambio_musculo > 0 ? 'text-success' : 'text-danger';
                const cambioGrasaColor = objetivo.cambio_grasa > 0 ? 'text-danger' : 'text-success';

                html += `
                    <li class="timeline-event">
                        <div class="timeline-event-icon ${bgColor}">
                            <i class="fa ${iconoFa}"></i>
                        </div>
                        <div class="timeline-event-block block js-appear-enabled animated fadeIn" data-toggle="appear">
                            <div class="block-header">
                                <h3 class="block-title">${objetivo.descripcion}</h3>
                                <div class="block-options">
                                    <div class="timeline-event-time block-options-item font-size-sm">
                                        <span class="badge badge-primary">${objetivo.categoria}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="block-content">
                                <p class="font-w600 mb-2">
                                    <i class="fa fa-info-circle text-info mr-1"></i>${objetivo.fase}
                                </p>
                                
                                <div class="row mb-2">
                                    <div class="col-sm-6">
                                        <p class="mb-1">
                                            Tu peso será de <a class="font-w600">${objetivo.peso_objetivo} kg</a>
                                            (cambio: <a class="font-w600 ${objetivo.cambio_peso > 0 ? 'text-success' : 'text-danger'}">${objetivo.cambio_peso > 0 ? '+' : ''}${objetivo.cambio_peso} kg</a>)
                                        </p>
                                    </div>
                                    <div class="col-sm-6">
                                        <p class="mb-1">
                                            Grasa corporal: <a class="font-w600">${objetivo.bf_objetivo}%</a>
                                        </p>
                                    </div>
                                </div>

                                <div class="row mb-2">
                                    <div class="col-sm-6">
                                        <p class="mb-1">
                                            FFMI: <a class="font-w600">${objetivo.ffmi_objetivo}</a> 
                                            <span class="text-muted">(${objetivo.ffmi_categoria})</span>
                                        </p>
                                    </div>
                                    <div class="col-sm-6">
                                        <p class="mb-1">
                                            Tiempo estimado: <a class="font-w600 text-info">${objetivo.tiempo_meses} meses</a>
                                        </p>
                                    </div>
                                </div>

                                <div class="row mb-2">
                                    <div class="col-sm-6">
                                        <p class="mb-1">
                                            <i class="fa fa-muscle ${cambioMusculoColor} mr-1"></i>
                                            Cambio músculo: <a class="font-w600 ${cambioMusculoColor}">${objetivo.cambio_musculo > 0 ? '+' : ''}${objetivo.cambio_musculo} kg</a>
                                        </p>
                                    </div>
                                    <div class="col-sm-6">
                                        <p class="mb-1">
                                            <i class="fa fa-burn ${cambioGrasaColor} mr-1"></i>
                                            Cambio grasa: <a class="font-w600 ${cambioGrasaColor}">${objetivo.cambio_grasa > 0 ? '+' : ''}${objetivo.cambio_grasa} kg</a>
                                        </p>
                                    </div>
                                </div>

                                <p class="font-size-sm text-muted mb-3">
                                    <i class="fa fa-ruler mr-1"></i>${medidaTexto}
                                </p>

                                <button type="button" class="btn btn-sm btn-primary usar-objetivo-parcial" 
                                        data-ffmi="${objetivo.ffmi_objetivo}" 
                                        data-bf="${objetivo.bf_objetivo}"
                                        data-descripcion="${objetivo.descripcion}">
                                    <i class="fa fa-fw fa-check mr-1"></i>
                                    Usar Este Objetivo
                                </button>
                            </div>
                        </div>
                    </li>
                `;
            });
            
            html += '</ul>';
            container.innerHTML = html;

            // Agregar event listeners para los botones de objetivos parciales
            document.querySelectorAll('.usar-objetivo-parcial').forEach(btn => {
                btn.addEventListener('click', function() {
                    const ffmi = this.getAttribute('data-ffmi');
                    const bf = this.getAttribute('data-bf');
                    const descripcion = this.getAttribute('data-descripcion');
                    
                    goalimmcInput.value = ffmi;
                    goalbfInput.value = bf;
                    
                    // Scroll hacia el formulario manual
                    document.querySelector('.block-rounded:first-of-type').scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                    
                    // Resaltar los campos actualizados
                    goalimmcInput.classList.add('border-success');
                    goalbfInput.classList.add('border-success');
                    
                    // Mostrar mensaje de confirmación
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show mt-2';
                    alert.innerHTML = `
                        <strong>Objetivo seleccionado:</strong> ${descripcion}
                        <button type="button" class="close" data-dismiss="alert">
                            <span>&times;</span>
                        </button>
                    `;
                    goalimmcInput.parentNode.appendChild(alert);
                    
                    setTimeout(() => {
                        goalimmcInput.classList.remove('border-success');
                        goalbfInput.classList.remove('border-success');
                        if (alert.parentNode) {
                            alert.parentNode.removeChild(alert);
                        }
                    }, 3000);
                });
            });
        }

        // Función para cargar objetivos automáticos
        function cargarObjetivosAutomaticos(nombreUsuario) {
            if (!nombreUsuario) {
                objetivosAutomaticosSection.style.display = 'none';
                return;
            }

            objetivosAutomaticosSection.style.display = 'block';
            loadingObjetivos.style.display = 'block';
            objetivosAutomaticosData.style.display = 'none';
            objetivosAutomaticosError.style.display = 'none';

            fetch(`/api/goal/objetivos-automaticos/${encodeURIComponent(nombreUsuario)}`)
                .then(response => response.json())
                .then(data => {
                    loadingObjetivos.style.display = 'none';
                    
                    if (data.error) {
                        objetivosAutomaticosError.style.display = 'block';
                        document.getElementById('error-message').textContent = data.error;
                        return;
                    }

                    datosObjetivosActuales = data;
                    
                    // Llenar datos actuales
                    document.getElementById('peso-actual').textContent = data.datos_actuales.peso;
                    document.getElementById('bf-actual').textContent = data.datos_actuales.bf;
                    document.getElementById('ffmi-actual').textContent = data.datos_actuales.ffmi;
                    document.getElementById('peso-magro-actual').textContent = data.datos_actuales.peso_magro;
                    document.getElementById('peso-graso-actual').textContent = data.datos_actuales.peso_graso;

                    // Mostrar medidas según sexo
                    const sexo = data.metadata.sexo;
                    
                    if (sexo === 'M') {
                        // Para hombres - restaurar estructura original y mostrar abdomen
                        document.getElementById('medida-actual-container').innerHTML = `
                            <strong id="medida-actual-label">Abdomen:</strong><br>
                            <span id="medida-actual-valor" class="font-weight-bold text-dark">${data.datos_actuales.circ_abdomen}</span> cm
                        `;
                        document.getElementById('medida-objetivo-container').innerHTML = `
                            <strong id="medida-objetivo-label">Abdomen Obj.:</strong><br>
                            <span id="medida-objetivo-valor" class="font-weight-bold text-success">${data.objetivos_geneticos.circ_abdomen_objetivo || '-'}</span> cm
                        `;
                        const cambioAbdomen = data.cambios_necesarios.abdomen || 0;
                        document.getElementById('cambio-medida-container').innerHTML = `
                            <strong id="cambio-medida-label">Abdomen:</strong><br>
                            <span id="cambio-medida-valor" class="font-weight-bold ${cambioAbdomen < 0 ? 'text-success' : 'text-danger'}">${cambioAbdomen > 0 ? '+' : ''}${cambioAbdomen}</span> cm
                        `;
                    } else {
                        // Para mujeres mostrar cintura y cadera
                        document.getElementById('medida-actual-container').innerHTML = `
                            <div class="col-6">
                                <strong>Cintura:</strong><br>
                                <span class="font-weight-bold text-dark">${data.datos_actuales.circ_cintura || 'N/D'}</span> cm
                            </div>
                            <div class="col-6">
                                <strong>Cadera:</strong><br>
                                <span class="font-weight-bold text-dark">${data.datos_actuales.circ_cadera || 'N/D'}</span> cm
                            </div>
                        `;
                        document.getElementById('medida-objetivo-container').innerHTML = `
                            <div class="col-6">
                                <strong>Cintura Obj.:</strong><br>
                                <span class="font-weight-bold text-success">${data.objetivos_geneticos.circ_cintura_objetivo || '-'}</span> cm
                            </div>
                            <div class="col-6">
                                <strong>Cadera Obj.:</strong><br>
                                <span class="font-weight-bold text-success">${data.objetivos_geneticos.circ_cadera_objetivo || '-'}</span> cm
                            </div>
                        `;
                        document.getElementById('cambio-medida-container').innerHTML = `
                            <div class="col-6">
                                <strong>Cintura:</strong><br>
                                <span class="font-weight-bold ${data.cambios_necesarios.cintura < 0 ? 'text-success' : 'text-danger'}">${data.cambios_necesarios.cintura > 0 ? '+' : ''}${data.cambios_necesarios.cintura || '-'}</span> cm
                            </div>
                            <div class="col-6">
                                <strong>Cadera:</strong><br>
                                <span class="font-weight-bold ${data.cambios_necesarios.cadera < 0 ? 'text-success' : 'text-danger'}">${data.cambios_necesarios.cadera > 0 ? '+' : ''}${data.cambios_necesarios.cadera || '-'}</span> cm
                            </div>
                        `;
                    }

                    // Llenar objetivos genéticos
                    document.getElementById('peso-objetivo').textContent = data.objetivos_geneticos.peso_objetivo;
                    document.getElementById('bf-objetivo').textContent = data.objetivos_geneticos.bf_esencial;
                    document.getElementById('ffmi-objetivo').textContent = data.objetivos_geneticos.ffmi_limite;
                    document.getElementById('peso-magro-objetivo').textContent = data.objetivos_geneticos.peso_magro_objetivo;
                    document.getElementById('peso-graso-objetivo').textContent = data.objetivos_geneticos.peso_graso_objetivo;

                    // Llenar cambios necesarios
                    const cambiopeso = data.cambios_necesarios.peso;
                    document.getElementById('cambio-peso').textContent = (cambiopeso > 0 ? '+' : '') + cambiopeso;
                    document.getElementById('cambio-peso').className = `font-weight-bold ${cambiopeso > 0 ? 'text-success' : 'text-danger'}`;
                    
                    document.getElementById('cambio-peso-magro').textContent = (data.cambios_necesarios.peso_magro > 0 ? '+' : '') + data.cambios_necesarios.peso_magro;
                    document.getElementById('cambio-peso-graso').textContent = (data.cambios_necesarios.peso_graso > 0 ? '+' : '') + data.cambios_necesarios.peso_graso;

                    // Llenar tiempo estimado
                    document.getElementById('tiempo-meses').textContent = data.tiempo_estimado.meses;
                    document.getElementById('tiempo-años').textContent = data.tiempo_estimado.años;

                    // Mostrar objetivos parciales
                    mostrarObjetivosParciales(data.objetivos_parciales, sexo);

                    objetivosAutomaticosData.style.display = 'block';
                })
                .catch(error => {
                    loadingObjetivos.style.display = 'none';
                    objetivosAutomaticosError.style.display = 'block';
                    document.getElementById('error-message').textContent = 'Error de conexión: ' + error.message;
                    console.error('Error:', error);
                });
        }

        // Event listener para cambio de usuario
        nameUserSelect.addEventListener('change', function() {
            cargarObjetivosAutomaticos(this.value);
        });

        // Event listener para usar objetivos automáticos
        usarObjetivosBtn.addEventListener('click', function() {
            if (datosObjetivosActuales) {
                goalimmcInput.value = datosObjetivosActuales.objetivos_geneticos.ffmi_limite;
                goalbfInput.value = datosObjetivosActuales.objetivos_geneticos.bf_esencial;
                
                // Scroll hacia el formulario manual
                document.querySelector('.block-rounded:first-of-type').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
                
                // Resaltar los campos actualizados
                goalimmcInput.classList.add('border-success');
                goalbfInput.classList.add('border-success');
                
                setTimeout(() => {
                    goalimmcInput.classList.remove('border-success');
                    goalbfInput.classList.remove('border-success');
                }, 3000);
            }
        });

        // Cargar objetivos automáticos si ya hay un usuario seleccionado
        if (nameUserSelect.value) {
            cargarObjetivosAutomaticos(nameUserSelect.value);
        }
    });
    </script>

{% endblock %}
