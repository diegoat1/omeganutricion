{% extends "base/base.html" %}

{% block title %}Base de Datos de Fuerza (Admin){% endblock %}

{% block extra_head %}
<!-- Aseguramos que Chart.js se cargue solo una vez -->
<script>
    // Verificamos si Chart.js ya está cargado
    if (typeof Chart === 'undefined') {
        document.write('<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"><\/script>');

    } else {

    }
</script>
<!-- Modal para parametros de optimización -->
<div class="modal fade" id="optimizacionModal" tabindex="-1" aria-labelledby="optimizacionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="optimizacionModalLabel">Parámetros de optimización</h5>
                <button type="button" class="btn-close" onclick="cerrarModal()" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="optimizacionForm">
                    <input type="hidden" id="optimizacionId">
                    <input type="hidden" id="optimizacionCategories">
                    <div class="mb-3">
                        <label for="numeroDias" class="form-label">Número de días</label>
                        <input type="number" class="form-control" id="numeroDias" value="3" min="1" max="7">
                    </div>
                    <div class="mb-3">
                        <label for="numeroEjercicios" class="form-label">Ejercicios por día</label>
                        <input type="number" class="form-control" id="numeroEjercicios" value="3" min="1" max="6">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnEnviarOptimizacion" onclick="procesarOptimizacion()">Optimizar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Campo oculto para el token CSRF -->
<input type="hidden" name="csrf_token" id="csrf_token" value="{{ csrf_token() }}">

<div class="content">
    <div class="block block-rounded">
        <div class="block-header block-header-default d-flex flex-column flex-md-row justify-content-between align-items-center">
            <h3 class="block-title mb-2 mb-md-0">Base de Datos de Análisis de Fuerza (Administrador)</h3>
            <div class="d-flex flex-wrap gap-2">
                <div style="position:relative;width:220px;">
                  <input id="searchInput" type="text" class="form-control form-control-sm" placeholder="Buscar usuario..." autocomplete="off">
                  <div id="userSuggestions" class="autocomplete-suggestions" style="display:none;"></div>
                </div>
            </div>
        </div>
        <div class="block-content" id="registrosContainer">
            {% if registros %}
                {% for registro in registros %}
                    <div class="card mb-2 strengthdata-card {{ registro.score_class | lower | replace(' ', '-') if registro.score_class else 'default' }}" data-username="{{ registro.username | lower }}" data-search="{{ registro.id }} {{ registro.username }} {{ registro.fecha_analisis }} {{ registro.total_score }} {{ registro.score_class }}">
                        <div class="card-header py-2 px-3 d-flex flex-row justify-content-between align-items-center">
                            <div class="d-flex flex-column flex-md-row align-items-md-center gap-2">
                                <span class="badge bg-primary">ID: {{ registro.id }}</span>
                                <span class="ms-md-2"><i class="fa fa-user me-1"></i> <strong>{{ registro.username }}</strong></span>
                                <span class="ms-md-2"><i class="fa fa-calendar me-1"></i> {{ registro.fecha_analisis.split('.')[0] if registro.fecha_analisis else 'N/A' }}</span>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="fw-bold text-nowrap">Score: {{ registro.total_score | round(1) if registro.total_score is not none else 'N/A' }}</span>
                                <span class="badge bg-light text-dark">{{ registro.score_class if registro.score_class else 'N/A' }}</span>
                                <button class="btn btn-danger btn-sm ms-2" onclick="eliminarRegistro('{{ registro.id }}')"><i class="fa fa-trash"></i></button>
                                <button class="btn btn-info btn-sm ms-1 btn-optimizar" data-id="{{ registro.id }}" data-categories='{{ registro.categories_results_json | tojson if registro.categories_results_json else "{}" }}' data-bs-toggle="tooltip" title="Optimizar entrenamiento"><i class="fa fa-cogs"></i></button>
                                <button class="btn btn-link btn-sm" data-bs-toggle="collapse" data-bs-target="#collapseAdminStrength-{{ registro.id }}" role="button" aria-expanded="false" aria-controls="collapseAdminStrength-{{ registro.id }}">
                                    <i class="fa fa-chevron-down"></i>
                                </button>
                            </div>
                        </div>
                        <div id="collapseAdminStrength-{{ registro.id }}" class="collapse collapse-admin-strengthdata" aria-labelledby="heading-{{ loop.index }}">
                            <div class="card-body py-2 px-3">
                                <div class="row">
                                    <!-- Fila 1: Score principal y categorías | Últimos levantamientos -->
                                    <div class="col-md-6 mb-4">
                                        <!-- Puntaje principal y por categoría -->
                                        {% set score_class_bg = '#009688' %} <!-- Default intermediate color -->
                                        {% if registro.score_class|lower == 'subpar' %}
                                            {% set score_class_bg = '#e91e63' %}
                                        {% elif registro.score_class|lower == 'untrained' %}
                                            {% set score_class_bg = '#673ab7' %}
                                        {% elif registro.score_class|lower == 'novice' %}
                                            {% set score_class_bg = '#3f51b5' %}
                                        {% elif registro.score_class|lower == 'intermediate' %}
                                            {% set score_class_bg = '#009688' %}
                                        {% elif registro.score_class|lower == 'advanced' %}
                                            {% set score_class_bg = '#cddc39' %}
                                        {% elif registro.score_class|lower == 'proficient' %}
                                            {% set score_class_bg = '#4caf50' %}
                                        {% elif registro.score_class|lower == 'exceptional' %}
                                            {% set score_class_bg = '#ffc107' %}
                                        {% elif registro.score_class|lower == 'elite' %}
                                            {% set score_class_bg = '#ff5722' %}
                                        {% elif registro.score_class|lower == 'world-class' %}
                                            {% set score_class_bg = '#f44336' %}
                                        {% endif %}
                                        <div class="card mb-3 strength-analysis-card {{ registro.score_class|lower|replace(' ', '-') }}">
                                            <div class="card-body p-4">
                                                <div class="row">
                                                    <div class="col-md-8">
                                                        <div class="d-flex flex-column">
                                                            {% if registro.categories_results_json %}
                                                                {% set cat_data = registro.categories_results_json %}
                                                                {% if cat_data %}
                                                                    {% if cat_data.squat is defined and cat_data.squat is number %}
                                                                        <div class="exercise-row">
                                                                            <div class="d-flex justify-content-between align-items-center">
                                                                                <span class="exercise-name">SQUAT</span>
                                                                                <span class="exercise-score">{{ cat_data.squat | round(1) }}</span>
                                                                            </div>
                                                                        </div>
                                                                    {% endif %}
                                                                    {% if cat_data.floorPull is defined and cat_data.floorPull is number %}
                                                                        <div class="exercise-row">
                                                                            <div class="d-flex justify-content-between align-items-center">
                                                                                <span class="exercise-name">FLOOR PULL</span>
                                                                                <span class="exercise-score">{{ cat_data.floorPull | round(1) }}</span>
                                                                            </div>
                                                                        </div>
                                                                    {% endif %}
                                                                    {% if cat_data.horizontalPress is defined and cat_data.horizontalPress is number %}
                                                                        <div class="exercise-row">
                                                                            <div class="d-flex justify-content-between align-items-center">
                                                                                <span class="exercise-name">HORIZONTAL PRESS</span>
                                                                                <span class="exercise-score">{{ cat_data.horizontalPress | round(1) }}</span>
                                                                            </div>
                                                                        </div>
                                                                    {% endif %}
                                                                    {% if cat_data.verticalPress is defined and cat_data.verticalPress is number %}
                                                                        <div class="exercise-row">
                                                                            <div class="d-flex justify-content-between align-items-center">
                                                                                <span class="exercise-name">VERTICAL PRESS</span>
                                                                                <span class="exercise-score">{{ cat_data.verticalPress | round(1) }}</span>
                                                                            </div>
                                                                        </div>
                                                                    {% endif %}
                                                                    {% if cat_data.pullup is defined and cat_data.pullup is number %}
                                                                        <div class="exercise-row">
                                                                            <div class="d-flex justify-content-between align-items-center">
                                                                                <span class="exercise-name">PULL-UP / ROW</span>
                                                                                <span class="exercise-score">{{ cat_data.pullup | round(1) }}</span>
                                                                            </div>
                                                                        </div>
                                                                    {% endif %}
                                                                {% endif %}
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4 d-flex">
                                                        <div class="score-display w-100">
                                                            <div>
                                                                <div class="score-label">Score</div>
                                                                <div class="total-score">{{ registro.total_score | round(1) }}</div>
                                                                <div class="score-classification">{{ registro.score_class }}</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-4">
                                        <!-- Últimos levantamientos registrados -->
                                        <div class="card h-100">
                                            <div class="card-header bg-light">
                                                <h5 class="card-title mb-0">Últimos Levantamientos Registrados</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="latest-lifts">
                                                    <div class="mb-3">
                                                        <small class="text-muted">Registrado el {{ registro.fecha_analisis.split(' ')[0] if registro.fecha_analisis else 'N/A' }}</small>
                                                    </div>
                                                    {% set data_source = registro.lift_fields_json or registro.lifts_json %}
                                                    {% if data_source %}
                                                        <h6 class="mt-3 mb-2">Levantamientos Registrados:</h6>
                                                        <ul class="list-group list-group-flush">
                                                            {% if data_source.backSquat %}
                                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                    Sentadilla Trasera
                                                                    <span class="badge bg-danger rounded-pill">{{ data_source.backSquat.weight | round(1) }} kg x {{ data_source.backSquat.reps }}</span>
                                                                </li>
                                                            {% endif %}
                                                            {% if data_source.frontSquat %}
                                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                    Sentadilla Frontal
                                                                    <span class="badge bg-danger rounded-pill">{{ data_source.frontSquat.weight | round(1) }} kg x {{ data_source.frontSquat.reps }}</span>
                                                                </li>
                                                            {% endif %}
                                                            {% if data_source.deadlift %}
                                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                    Peso Muerto
                                                                    <span class="badge bg-warning text-dark rounded-pill">{{ data_source.deadlift.weight | round(1) }} kg x {{ data_source.deadlift.reps }}</span>
                                                                </li>
                                                            {% endif %}
                                                            {% if data_source.benchPress %}
                                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                    Press de Banca
                                                                    <span class="badge bg-primary rounded-pill">{{ data_source.benchPress.weight | round(1) }} kg x {{ data_source.benchPress.reps }}</span>
                                                                </li>
                                                            {% endif %}
                                                            {% if data_source.overheadPress %}
                                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                    Press Militar
                                                                    <span class="badge bg-info text-dark rounded-pill">{{ data_source.overheadPress.weight | round(1) }} kg x {{ data_source.overheadPress.reps }}</span>
                                                                </li>
                                                            {% endif %}
                                                        </ul>
                                                    {% else %}
                                                        <div class="alert alert-light mt-3" role="alert">
                                                            <small><i class="fas fa-info-circle me-1"></i> No hay datos detallados de levantamientos para este registro.</small>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Fila 2: Detalle de levantamientos | Fortalezas y debilidades (radar) -->
                                <div class="row mt-4">
                                    <div class="col-md-6 mb-4">
                                        <!-- Detalle de levantamientos -->
                                        <div class="card h-100">
                                            <div class="card-header bg-light">
                                                <h5 class="card-title mb-0">Detalle de Levantamientos</h5>
                                            </div>
                                            <div class="card-body">
                                                {% if registro.lifts_results_json %}
                                                    {% set lifts_data = registro.lifts_results_json %}
                                                    {% if lifts_data and (lifts_data is mapping or (lifts_data is iterable and lifts_data is not string)) %}
                                                        <div class="table-responsive">
                                                            <table class="table table-striped table-hover">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Ejercicio</th>
                                                                        <th>Score</th>
                                                                        <th>Peso 1RM</th>
                                                                        <th>Esperado</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                {% if lifts_data is mapping %}
                                                                    {% for key, lift in lifts_data.items() %}
                                                                        {% if lift.userScore is defined and lift.userScore is not none and lift.userScore is number %}
                                                                        <tr>
                                                                             <td>{% if key == 'backSquat' %}Sentadilla Trasera
                                                                                 {% elif key == 'benchPress' %}Press de Banca
                                                                                 {% elif key == 'chinup' %}Dominada Supina
                                                                                 {% elif key == 'deadlift' %}Peso Muerto
                                                                                 {% elif key == 'dip' %}Fondos
                                                                                 {% elif key == 'frontSquat' %}Sentadilla Frontal
                                                                                 {% elif key == 'inclineBenchPress' %}Press Inclinado
                                                                                 {% elif key == 'overheadPress' %}Press Militar
                                                                                 {% elif key == 'pendlayRow' %}Remo Pendlay
                                                                                 {% elif key == 'powerClean' %}Cargada de Potencia
                                                                                 {% elif key == 'pullup' %}Dominada
                                                                                 {% elif key == 'pushPress' %}Push Press
                                                                                 {% elif key == 'snatchPress' %}Press de Arranque
                                                                                 {% elif key == 'sumoDeadlift' %}Peso Muerto Sumo
                                                                                 {% else %}{{ key }}
                                                                                 {% endif %}
                                                                             </td>
                                                                             <td>
                                                                                <div class="d-flex align-items-center">
                                                                                    <span class="me-2">{{ "%.1f"|format(lift.userScore) }}</span>
                                                                                    <div class="progress" style="height: 8px; width: 60px;">
                                                                                        <div class="progress-bar {{ 'bg-danger' if lift.userScore < 30 else ('bg-warning' if lift.userScore < 45 else ('bg-info' if lift.userScore < 60 else ('bg-primary' if lift.userScore < 75 else ('bg-success' if lift.userScore < 87.5 else 'bg-primary')))) }}" style="width: {{ (lift.userScore/125*100)|int }}%" role="progressbar"></div>
                                                                                    </div>
                                                                                </div>
                                                                             </td>
                                                                             <td>{% if lift.user1RM is defined %}{{ lift.user1RM }} kg{% else %}N/A{% endif %}</td>
                                                                             <td>{% if lift.expected is defined %}{{ lift.expected }} kg{% else %}N/A{% endif %}</td>
                                                                        </tr>
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                {% elif lifts_data is iterable %}
                                                                    {% for lift_info in lifts_data %}
                                                                        <tr>
                                                                            <td><strong>{{ lift_info.name }}</strong></td>
                                                                            <td class="fw-bold">{{ lift_info.score | round(1) if lift_info.score is defined and lift_info.score is number and lift_info.score is not none else 'N/A' }}</td>
                                                                            <td>
                                                                                {% set class_text = lift_info.classification | default('N/A') %}
                                                                                {% set class_badge = 'default' %}
                                                                                {% if class_text | lower == 'beginner' or class_text | lower == 'novice' %}
                                                                                    {% set class_badge = 'info' %}
                                                                                {% elif class_text | lower == 'intermediate' %}
                                                                                    {% set class_badge = 'primary' %}
                                                                                {% elif class_text | lower == 'advanced' %}
                                                                                    {% set class_badge = 'success' %}
                                                                                {% endif %}
                                                                                <div class="badge bg-{{ class_badge }}">{{ class_text }}</div>
                                                                            </td>
                                                                        </tr>
                                                                    {% endfor %}
                                                                {% endif %}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    {% else %}
                                                        <p class="alert alert-info">No hay datos detallados de levantamientos o el formato no es reconocido.</p>
                                                        {% if registro.lifts_results_json %}
                                                        <small>Raw data:</small>
                                                        <pre style="font-size: 0.75em; padding: 5px;">{{ registro.lifts_results_json | tojson(indent=2) }}</pre>
                                                        {% endif %}
                                                    {% endif %}
                                                {% else %}
                                                    <p class="alert alert-info">No hay datos detallados de levantamientos.</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-4">
                                        <!-- Fortalezas y debilidades relativas (Radar) -->
                                        <div class="card h-100">
                                            <div class="card-header bg-light">
                                                <h5 class="card-title mb-0">Fortalezas y Debilidades Relativas</h5>
                                            </div>
                                            <div class="card-body d-flex align-items-center justify-content-center">
                                                <div id="adminStrengthChart-{{ registro.id }}" style="min-height: 350px;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Fila 3: Resumen de rendimiento | Gráfico de músculos -->
                                <div class="row mt-4">
                                    <div class="col-md-6 mb-4">
                                        <!-- Resumen de rendimiento -->
                                        <div class="card h-100">
                                            <div class="card-header bg-light">
                                                <h5 class="card-title mb-0">Resumen de Rendimiento</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label class="form-label fw-bold">Wilks (Powerlifting):</label>
                                                            <div class="fs-5">{{ registro.powerlifting_wilks | round(2) if registro.powerlifting_wilks is not none else 'N/A' }}</div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label class="form-label fw-bold">Total (Powerlifting):</label>
                                                            <div class="fs-5">{{ registro.powerlifting_total | round(2) if registro.powerlifting_total is not none else 'N/A' }}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Levantamiento Más Fuerte:</label>
                                                    <div><span class="badge bg-success fs-6">{{ registro.strongest_lift_name if registro.strongest_lift_name else 'N/A' }}</span></div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">Levantamiento Más Débil:</label>
                                                    <div><span class="badge bg-warning text-dark fs-6">{{ registro.weakest_lift_name if registro.weakest_lift_name else 'N/A' }}</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-4">
                                        <!-- Gráfico de músculos -->
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <h5 class="card-title mb-0">Grupos Musculares</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-12 d-flex justify-content-center">
                                                        <canvas id="adminMuscleGroupsChart-{{ registro.id }}" height="350"></canvas>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <label class="form-label fw-bold">Grupos Musculares Más Fuertes:</label>
                                                        <div>
                                                            {% if registro.strongest_muscle_groups_names and registro.strongest_muscle_groups_names is iterable and not registro.strongest_muscle_groups_names is string %}
                                                                {% for grupo in registro.strongest_muscle_groups_names %}
                                                                    <span class="badge bg-success me-1 mb-1">{{ grupo }}</span>
                                                                {% endfor %}
                                                            {% else %}
                                                                <span class="badge bg-secondary">No disponible</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label fw-bold">Grupos Musculares Más Débiles:</label>
                                                        <div>
                                                            {% if registro.weakest_muscle_groups_names and registro.weakest_muscle_groups_names is iterable and not registro.weakest_muscle_groups_names is string %}
                                                                {% for grupo in registro.weakest_muscle_groups_names %}
                                                                    <span class="badge bg-warning text-dark me-1 mb-1">{{ grupo }}</span>
                                                                {% endfor %}
                                                            {% else %}
                                                                <span class="badge bg-secondary">No disponible</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                <div id="paginationControls" class="mt-3 d-flex justify-content-center"></div>
            {% else %}
                <div class="alert alert-info">
                    <i class="fa fa-info-circle me-1"></i> No hay registros de análisis de fuerza para mostrar.
                </div>
            {% endif %}
            <div class="mt-4">
                <a href="{{ url_for('dashboard') }}" class="btn btn-alt-primary">
                    <i class="fa fa-arrow-left me-1"></i> Volver al Dashboard
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// --- Buscador y paginación ---
const registrosPorPagina = 10;
let paginaActual = 1;

function filtrarYPaginar() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const user = document.getElementById('userFilter').value.toLowerCase();
    const cards = Array.from(document.querySelectorAll('.strengthdata-card'));
    let visibles = cards.filter(card => {
        let matchesSearch = card.getAttribute('data-search').toLowerCase().includes(search);
        let matchesUser = !user || card.getAttribute('data-username') === user;
        return matchesSearch && matchesUser;
    });
    // Oculta todos
    cards.forEach(card => card.style.display = 'none');
    // Paginación
    const totalPaginas = Math.ceil(visibles.length / registrosPorPagina) || 1;
    if (paginaActual > totalPaginas) paginaActual = totalPaginas;
    const inicio = (paginaActual - 1) * registrosPorPagina;
    const fin = inicio + registrosPorPagina;
    visibles.slice(inicio, fin).forEach(card => card.style.display = '');
    renderizarPaginacion(totalPaginas);
}

function renderizarPaginacion(totalPaginas) {
    let html = '';
    if (totalPaginas > 1) {
        html += `<nav><ul class="pagination pagination-sm">`;
        for (let i = 1; i <= totalPaginas; i++) {
            html += `<li class="page-item${i === paginaActual ? ' active' : ''}"><a class="page-link" href="#" onclick="cambiarPagina(${i});return false;">${i}</a></li>`;
        }
        html += `</ul></nav>`;
    }
    document.getElementById('paginationControls').innerHTML = html;
}

function cambiarPagina(nuevaPagina) {
    paginaActual = nuevaPagina;
    filtrarYPaginar();
}

// --- Autocomplete de usuarios ---
let selectedUser = '';
const searchInput = document.getElementById('searchInput');
const suggestionsBox = document.getElementById('userSuggestions');

searchInput.addEventListener('input', function(e) {
    const query = this.value.trim();
    paginaActual = 1;
    if (query.length < 2) {
        suggestionsBox.style.display = 'none';
        selectedUser = '';
        filtrarYPaginar();
        return;
    }
    fetch(`/admin/api/buscar_usuarios?q=${encodeURIComponent(query)}`)
        .then(resp => resp.json())
        .then(data => {
            suggestionsBox.innerHTML = '';
            if (data.usuarios && data.usuarios.length > 0) {
                data.usuarios.forEach(usuario => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-suggestion';
                    item.textContent = usuario;
                    item.addEventListener('mousedown', function() {
                        searchInput.value = usuario;
                        selectedUser = usuario.toLowerCase();
                        suggestionsBox.style.display = 'none';
                        filtrarYPaginar();
                    });
                    suggestionsBox.appendChild(item);
                });
                suggestionsBox.style.display = 'block';
            } else {
                suggestionsBox.style.display = 'none';
            }
        });
});

// Ocultar sugerencias si se hace click fuera
searchInput.addEventListener('blur', function() {
    setTimeout(() => suggestionsBox.style.display = 'none', 150);
});

// Filtrado por usuario seleccionado
function filtrarYPaginar() {
    const search = searchInput.value.toLowerCase();
    const user = selectedUser;
    const cards = Array.from(document.querySelectorAll('.strengthdata-card'));
    let visibles = cards.filter(card => {
        let matchesSearch = card.getAttribute('data-search').toLowerCase().includes(search);
        let matchesUser = !user || card.getAttribute('data-username') === user;
        return matchesSearch && matchesUser;
    });
    // Oculta todos
    cards.forEach(card => card.style.display = 'none');
    // Paginación
    const totalPaginas = Math.ceil(visibles.length / registrosPorPagina) || 1;
    if (paginaActual > totalPaginas) paginaActual = totalPaginas;
    const inicio = (paginaActual - 1) * registrosPorPagina;
    const fin = inicio + registrosPorPagina;
    visibles.slice(inicio, fin).forEach(card => card.style.display = '');
    renderizarPaginacion(totalPaginas);
}

// Inicializar al cargar
document.addEventListener('DOMContentLoaded', function() {
    filtrarYPaginar();
    
    // Inicializar tooltips de Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
    
    // Solo un manejador para los botones de optimización
    document.querySelectorAll('.btn-optimizar').forEach(btn => {
        btn.addEventListener('click', function(event) {
            event.preventDefault();
            const id = this.getAttribute('data-id');
            const dataCategoriesAttr = this.getAttribute('data-categories');
            
            // Guardar datos en el modal
            document.getElementById('optimizacionId').value = id;
            document.getElementById('optimizacionCategories').value = dataCategoriesAttr;
            
            // Mostrar el modal
            const optimizacionModal = new bootstrap.Modal(document.getElementById('optimizacionModal'));
            optimizacionModal.show();
        });
    });

    // Manejador para el botón de confirmación en el modal - usamos una función directa 
    const btnOptimizar = document.getElementById('btnEnviarOptimizacion');
    console.log('DEBUG: Botón de optimización encontrado:', btnOptimizar);
    
    if (btnOptimizar) {
        btnOptimizar.onclick = function() {
            console.log('DEBUG: Botón de optimización clickeado');
        const id = document.getElementById('optimizacionId').value;
        const categoriesAttr = document.getElementById('optimizacionCategories').value;
        const numeroDias = document.getElementById('numeroDias').value;
        const numeroEjercicios = document.getElementById('numeroEjercicios').value;
        
        let categoriesData = {};
        
        try {
            // Asegurarnos de que los datos no sean nulos o indefinidos
            if (categoriesAttr && categoriesAttr !== 'null' && categoriesAttr !== 'undefined') {
                // Limpiar cualquier carácter no deseado que pueda causar problemas
                let cleanData = categoriesAttr.trim();
                if (cleanData) {
                    categoriesData = JSON.parse(cleanData);
                }
            }
        } catch (error) {
            console.error('Error parseando data-categories:', error);
            // Si hay error en el parseo, usamos un objeto vacío predeterminado con valores
            categoriesData = {
                squat: 0,
                floorPull: 0,
                horizontalPress: 0,
                verticalPress: 0,
                pullup: 0
            };
            // Alertar al usuario del problema pero permitir continuar
            alert('Hubo un problema al cargar los datos de categorías. Se usarán valores por defecto.');
        }
        
        // Cerrar el modal usando nuestra función segura
        cerrarModal();
        
        // Enviar datos
        optimizarEntrenamiento(id, categoriesData, numeroDias, numeroEjercicios);
        };
    }
});

// Función para cerrar el modal de optimización
function cerrarModal() {
    console.log('Cerrando modal...');
    const modalElement = document.getElementById('optimizacionModal');
    if (modalElement) {
        // Manipular directamente el DOM para cerrar el modal
        modalElement.classList.remove('show');
        modalElement.style.display = 'none';
        
        // Eliminar el backdrop (fondo oscuro)
        const modalBackdrops = document.getElementsByClassName('modal-backdrop');
        while (modalBackdrops.length > 0) {
            modalBackdrops[0].remove();
        }
        
        // Restaurar el body
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }
}

// Función para procesar la optimización desde el modal
function procesarOptimizacion() {
    console.log('Función procesarOptimizacion ejecutada');
    const id = document.getElementById('optimizacionId').value;
    const categoriesAttr = document.getElementById('optimizacionCategories').value;
    const numeroDias = document.getElementById('numeroDias').value;
    const numeroEjercicios = document.getElementById('numeroEjercicios').value;
    
    let categoriesData = {};
    
    try {
        // Asegurarnos de que los datos no sean nulos o indefinidos
        if (categoriesAttr && categoriesAttr !== 'null' && categoriesAttr !== 'undefined') {
            // Limpiar cualquier carácter no deseado que pueda causar problemas
            let cleanData = categoriesAttr.trim();
            if (cleanData) {
                categoriesData = JSON.parse(cleanData);
            }
        }
    } catch (error) {
        console.error('Error parseando data-categories:', error);
        // Si hay error en el parseo, usamos un objeto vacío predeterminado con valores
        categoriesData = {
            squat: 0,
            floorPull: 0,
            horizontalPress: 0,
            verticalPress: 0,
            pullup: 0
        };
        alert('Hubo un problema al cargar los datos de categorías. Se usarán valores por defecto.');
    }
    
    // Cerrar el modal usando nuestra función cerrarModal
    cerrarModal();
    
    // Enviar datos
    optimizarEntrenamiento(id, categoriesData, numeroDias, numeroEjercicios);
}

// --- Eliminar registro ---
function eliminarRegistro(id) {
    if (confirm('¿Estás seguro de que deseas eliminar este registro de análisis de fuerza? Esta acción no se puede deshacer.')) {
        // Obtenemos el token CSRF
        const token = document.getElementById('csrf_token') ? document.getElementById('csrf_token').value : '';
        
        fetch('/eliminar_registro_fuerza/' + id, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': token
            },
            // Añadimos un cuerpo vacío para evitar problemas con algunas implementaciones de Flask
            body: JSON.stringify({})
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Error al eliminar el registro');
        })
        .then(data => {
            if (data.success) {
                const card = document.querySelector(`[data-username][data-search*="${id} "]`);
                if (card) {
                    card.style.opacity = '0.5';
                    card.style.transition = 'opacity 0.3s ease-in-out';
                    setTimeout(() => {
                        card.remove();
                        filtrarYPaginar(); // Actualiza la paginación después de eliminar
                    }, 300);
                }
            } else {
                alert('Error: ' + (data.error || 'No se pudo eliminar el registro'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ocurrió un error al procesar la solicitud.');
        });
    }
}

// --- Optimizar entrenamiento ---
function optimizarEntrenamiento(id, categoriesData, numeroDias = 3, numeroEjercicios = 3) {
    // Mostrar un indicador de carga
    const buttonElement = document.querySelector(`[data-id="${id}"].btn-optimizar`);
    if (buttonElement) {
        buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        buttonElement.disabled = true;
    }
    
    // Verificar y convertir categoriesData a un objeto válido si es necesario
    let dataToSend = categoriesData;
    if (typeof categoriesData !== 'object' || categoriesData === null) {
        console.warn('categoriesData no es un objeto válido, usando objeto vacío');
        dataToSend = {};
    }
    
    // Crear objeto con los datos a enviar
    const dataToSubmit = {
        squat: parseFloat(dataToSend.squat) || 0,
        floorPull: parseFloat(dataToSend.floorPull) || 0,
        horizontalPress: parseFloat(dataToSend.horizontalPress) || 0,
        verticalPress: parseFloat(dataToSend.verticalPress) || 0,
        pullup: parseFloat(dataToSend.pullup) || 0,
        numeroDias: parseInt(numeroDias) || 3,
        numeroEjercicios: parseInt(numeroEjercicios) || 3
    };
    

    const jsonBody = JSON.stringify(dataToSubmit);

    
    // Enviamos los datos al backend para que se impriman allí
    // Obtener el token CSRF de la etiqueta meta
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

    
    fetch('/optimizar_entrenamiento/' + id, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: jsonBody
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Error al procesar la optimización');
    })
    .then(data => {
        // Restaurar el botón
        if (buttonElement) {
            buttonElement.innerHTML = '<i class="fas fa-cogs"></i>';
            buttonElement.disabled = false;
        }
        
        if (data.success) {
            // Mostrar mensaje de éxito
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.setAttribute('role', 'alert');
            
            // Crear un mensaje simple de confirmación
            let alertContent = `<strong>¡Éxito!</strong> Los datos se procesaron correctamente.`;
            
            alertContent += `<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
            alertDiv.innerHTML = alertContent;
            
            // Insertar mensaje después del elemento #top-search o al principio del contenedor principal
            const targetElement = document.getElementById('top-search') || document.querySelector('.content');
            if (targetElement) {
                targetElement.parentNode.insertBefore(alertDiv, targetElement.nextSibling);
                
                // Auto-eliminar mensaje después de 10 segundos (más tiempo para leer los porcentajes)
                setTimeout(() => {
                    alertDiv.remove();
                }, 10000);
            }
        } else {
            alert('Error: ' + (data.error || 'No se pudo procesar la optimización'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ocurrió un error al procesar la solicitud.');
        
        // Restaurar el botón en caso de error
        if (buttonElement) {
            buttonElement.innerHTML = '<i class="fas fa-cogs"></i>';
            buttonElement.disabled = false;
        }
    });
}
</script>
<script src="{{ url_for('static', filename='js/admin_charts.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Chart Initialization ---

    var rawStrengthDataItems = [];
    var rawMuscleGroupDataItems = [];
    var currentItemId;

    {% if registros %}
        {% for registro_item in registros %}
            currentItemId = {{ registro_item.id | tojson | safe }};
            
            // Process lifts_results_json
            var rawJsonLifts = {{ registro_item.lifts_results_json | tojson | safe }};
            var liftsData = {}; // Default to empty object
            if (typeof rawJsonLifts === 'string' && rawJsonLifts.trim() !== '') {
                try {
                    liftsData = JSON.parse(rawJsonLifts);
                } catch (e) {
                    console.error('Failed to parse lifts_results_json for ID ' + currentItemId + ':', rawJsonLifts, e);
                    liftsData = {}; // Ensure it's an object even on parse error
                }
            } else if (rawJsonLifts && typeof rawJsonLifts === 'object') {
                liftsData = rawJsonLifts; // Already an object
            }
            rawStrengthDataItems.push({
                id: currentItemId,
                rawData: liftsData
            });

            // Process muscle_groups_results_json
            var rawJsonMuscleGroups = {{ registro_item.muscle_groups_results_json | tojson | safe }};
            var muscleGroupsData = {}; // Default to empty object
            if (typeof rawJsonMuscleGroups === 'string' && rawJsonMuscleGroups.trim() !== '') {
                try {
                    muscleGroupsData = JSON.parse(rawJsonMuscleGroups);
                } catch (e) {
                    console.error('Failed to parse muscle_groups_results_json for ID ' + currentItemId + ':', rawJsonMuscleGroups, e);
                    muscleGroupsData = {}; // Ensure it's an object even on parse error
                }
            } else if (rawJsonMuscleGroups && typeof rawJsonMuscleGroups === 'object') {
                muscleGroupsData = rawJsonMuscleGroups; // Already an object
            }
            rawMuscleGroupDataItems.push({
                id: currentItemId,
                rawData: muscleGroupsData
            });

        {% endfor %}
    {% endif %}




    if (typeof initializeAdminCharts === 'function') {
        initializeAdminCharts(
            rawStrengthDataItems, 
            rawMuscleGroupDataItems,
            'admin', // chartIdPrefix
            '.collapse-admin-strengthdata' // collapseSelector
        );

    } else {
        console.error('Admin Page - initializeAdminCharts function not found. Ensure admin_charts.js is loaded before this script.');
    }
});
</script>
{% endblock %}

{% block extra_css %}
<style>
.strengthdata-card .card-header {
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
}
.strength-analysis-card {
    border: none;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    overflow: hidden;
    margin-bottom: 1.5rem;
}
.untrained {
    border-left: 4px solid #673ab7;
}
.beginner, .novice {
    border-left: 4px solid #3f51b5;
}
.intermediate {
    border-left: 4px solid #009688;
}
.proficient, .advanced {
    border-left: 4px solid #4caf50;
}
.exceptional, .elite {
    border-left: 4px solid #ff5722;
}
.world-class {
    border-left: 4px solid #f44336;
}
.exercise-row {
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}
.exercise-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}
.exercise-name {
    font-weight: 500;
    font-size: 0.9rem;
    color: #555;
}
.exercise-score {
    font-weight: 700;
    font-size: 0.9rem;
    color: #333;
    padding: 0.15rem 0.5rem;
    border-radius: 4px;
    background-color: #f5f5f5;
}
.bg-purple {
    background-color: #9c27b0 !important;
    color: white !important;
}
.skill-tag {
    display: inline-block;
    padding: 3px 8px;
    margin-right: 5px;
    margin-bottom: 5px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
}
</style>
{% endblock %}
