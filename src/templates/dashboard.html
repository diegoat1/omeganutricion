{% extends 'base/base.html' %}

{% block title %} {{ title }} {% endblock %}

{% block herotitle %} Vista Principal {% endblock %}
{% block herosubtitle %} Bienvenido <a class="font-w600">{{ username }}</a>, todo esta bien. {% endblock %}
{% block contenttitle %} {% endblock %}
{% block contentsubtitle %} {% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='assets/css/gauges.css') }}">
{% endblock %}

{% block content %}

{% if is_admin %}
<!-- Selector de Pacientes (Solo Administrador) -->
<div class="block block-rounded mb-3 bg-primary-light">
    <div class="block-content py-3">
        <div class="row align-items-center">
            <div class="col-md-1 text-center">
                <i class="fa fa-user-shield fa-2x text-primary"></i>
            </div>
            <div class="col-md-5">
                <label class="mb-1 font-w600 text-primary">üëë Administrador - Ver dashboard de paciente:</label>
                <select class="form-control form-control-lg" id="selector_paciente" onchange="cambiarPaciente()">
                    {% for paciente in lista_pacientes %}
                    <option value="{{ paciente }}" {% if paciente == (paciente_seleccionado or username) %}selected{% endif %}>
                        {{ paciente }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <div class="alert alert-info mb-0">
                    <i class="fa fa-info-circle mr-2"></i>
                    <strong>Modo Admin:</strong> Viendo datos de <strong>{{ paciente_seleccionado or username }}</strong>
                    <br>
                    <small>Los botones de ajuste de calor√≠as est√°n activos para realizar cambios.</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function cambiarPaciente() {
    const paciente = document.getElementById('selector_paciente').value;
    window.location.href = `/dashboard?paciente=${encodeURIComponent(paciente)}`;
}
</script>
{% endif %}

<script>
    // Variable global para el sexo del usuario (para los c√°lculos de los gauges)
    window.userSex = '{{ estaticodata[0][4] if estaticodata else "M" }}';
</script>
    <div>
        <!-- Mensaje -->
        {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-danger alert-dismissable" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">√ó</span>
                    </button>
                    <p class="mb-0">{{ message }}</p>
                </div>
            {% endfor %}
        {% endif %}
        {% endwith %}
        <!-- END Mensaje -->
    </div>

    <!-- Overview -->
    <div class="row row-deck">
        <div class="col-sm-6 col-xl-4">
            <!-- Pending Orders -->
            <div class="block block-rounded d-flex flex-column">
                <div class="block-content block-content-full flex-grow-1 d-flex justify-content-between align-items-center">
                    <dl class="mb-0">
                        <dt class="font-size-h2 font-w700">{{ agua }}</dt>
                        <dd class="text-muted mb-0">Litros de agua</dd>
                    </dl>
                    <div class="item item-rounded bg-body">
                        <i class="fa fa-glass-whiskey font-size-h3 text-primary"></i>
                    </div>
                </div>
                <div class="block-content block-content-full block-content-sm bg-body-light font-size-sm">
                    <a class="font-w500 d-flex align-items-center">
                        Cantidad de litros de agua que deber√≠as consumir por d√≠a.
                    </a>
                </div>
            </div>
            <!-- END Pending Orders -->
        </div>
        <div class="col-sm-6 col-xl-4">
            <!-- New Customers -->
            <div class="block block-rounded d-flex flex-column">
                <div class="block-content block-content-full flex-grow-1 d-flex justify-content-between align-items-center">
                    <dl class="mb-0">
                        <dt class="font-size-h2 font-w700">{{ abdomen }}</dt>
                        <dd class="text-muted mb-0">Per√≠metro de Abdomen</dd>
                    </dl>
                    <div class="item item-rounded bg-body">
                        <i class="fa fa-heartbeat font-size-h3 text-primary"></i>
                    </div>
                </div>
                <div class="block-content block-content-full block-content-sm bg-body-light font-size-sm">
                    <a class="font-w500 d-flex align-items-center">
                        {{ abdcatrisk }}
                    </a>
                </div>
            </div>
            <!-- END New Customers -->
        </div>
        <div class="col-sm-6 col-xl-4">
            <!-- Messages -->
            <div class="block block-rounded d-flex flex-column">
                <div class="block-content block-content-full flex-grow-1 d-flex justify-content-between align-items-center">
                    <dl class="mb-0">
                        <dt class="font-size-h2 font-w700">{{ bodyscore }}</dt>
                        <dd class="text-muted mb-0">Puntaje corporal</dd>
                    </dl>
                    <div class="item item-rounded bg-body">
                        <i class="fa fa-user font-size-h3 text-primary"></i>
                    </div>
                </div>
                <div class="block-content block-content-full block-content-sm bg-body-light font-size-sm">
                    <a class="font-w500 d-flex align-items-center">
                        Complexi√≥n f√≠sica: {{ categoria }}
                    </a>
                </div>
            </div>
            <!-- END Messages -->
        </div>
        <div class="col-sm-12">
            <div class="block block-rounded">
                <div class="block-header block-header-default align-items-start flex-column flex-sm-row">
                    <div>
                        <h3 class="block-title mb-1">Reloj de rendimiento</h3>
                        <p class="mb-0 text-muted font-size-sm">Comparativo de fatrate y leanrate seg√∫n el escenario y el periodo seleccionado.</p>
                    </div>
                    <div class="block-options">
                        <span class="badge badge-primary font-size-sm mr-2">Objetivo fatrate: {{ fatrate_target|round(2) }} kg/sem</span>
                        <span class="badge badge-success font-size-sm">Objetivo leanrate: {{ leanrate_target|round(2) }} kg/sem</span>
                    </div>
                </div>
                <div class="block-content block-content-full">
                    <div class="row">
                        <!-- 
    SECCI√ìN DE AN√ÅLISIS COMPLETO DEL RELOJ DE RENDIMIENTO
    Esta secci√≥n debe insertarse ANTES de las 3 columnas del performance_clock en dashboard.html
    
    INSTRUCCIONES:
    1. Buscar en dashboard.html la l√≠nea que dice: <div class="row"> (despu√©s del block-content del Reloj de rendimiento)
    2. Insertar todo este c√≥digo ANTES de esa l√≠nea
-->

<!-- AN√ÅLISIS COMPLETO: TODA LA INFORMACI√ìN DEL PROGRESO -->
{% if analisis_completo.tiene_datos %}

<!-- SECCI√ìN 1: RESUMEN GENERAL - 4 CARDS -->
<div class="bg-light p-4 mb-4">
    <h4 class="font-w700 mb-4 text-primary">
        <i class="fa fa-tachometer-alt mr-2"></i>Resumen General del Progreso
    </h4>
    
    <div class="row">
        <!-- Card 1: Estado Actual -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-primary shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fa fa-user-circle mr-2"></i>Estado Actual</h6>
                </div>
                <div class="card-body font-size-sm">
                    <table class="table table-sm table-borderless mb-0">
                        <tr>
                            <td>Peso:</td>
                            <td class="text-right font-w600">{{ analisis_completo.estado_actual.peso }} kg</td>
                        </tr>
                        <tr>
                            <td>Masa Magra:</td>
                            <td class="text-right font-w600 text-success">{{ analisis_completo.estado_actual.peso_magro }} kg</td>
                        </tr>
                        <tr>
                            <td>Masa Grasa:</td>
                            <td class="text-right font-w600 text-danger">{{ analisis_completo.estado_actual.peso_graso }} kg</td>
                        </tr>
                        <tr>
                            <td>BF%:</td>
                            <td class="text-right font-w600">{{ analisis_completo.estado_actual.bf_porcentaje }}%</td>
                        </tr>
                        <tr>
                            <td>FFMI:</td>
                            <td class="text-right font-w600">{{ analisis_completo.estado_actual.ffmi }}</td>
                        </tr>
                    </table>
                    <hr class="my-2">
                    <div class="font-size-xs text-muted">
                        <div><i class="fa fa-calendar mr-1"></i>√öltimo: {{ analisis_completo.estado_actual.fecha_ultimo_registro }}</div>
                        <div><i class="fa fa-database mr-1"></i>{{ analisis_completo.estado_actual.total_registros }} registros / {{ analisis_completo.estado_actual.dias_monitoreados }} d√≠as</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card 2: Objetivo -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-success shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fa fa-bullseye mr-2"></i>Objetivo Definido</h6>
                </div>
                <div class="card-body font-size-sm">
                    {% if analisis_completo.objetivo_definido.tiene_objetivo %}
                    <table class="table table-sm table-borderless mb-0">
                        <tr>
                            <td>Peso:</td>
                            <td class="text-right font-w600">{{ analisis_completo.objetivo_definido.peso_objetivo }} kg</td>
                        </tr>
                        <tr>
                            <td>Masa Magra:</td>
                            <td class="text-right font-w600 text-success">{{ analisis_completo.objetivo_definido.peso_magro_objetivo }} kg</td>
                        </tr>
                        <tr>
                            <td>Masa Grasa:</td>
                            <td class="text-right font-w600 text-danger">{{ analisis_completo.objetivo_definido.peso_graso_objetivo }} kg</td>
                        </tr>
                        <tr>
                            <td>BF%:</td>
                            <td class="text-right font-w600">{{ analisis_completo.objetivo_definido.bf_objetivo }}%</td>
                        </tr>
                        <tr>
                            <td>FFMI:</td>
                            <td class="text-right font-w600">{{ analisis_completo.objetivo_definido.ffmi_objetivo }}</td>
                        </tr>
                    </table>
                    <hr class="my-2">
                    <span class="badge badge-{{ 'warning' if analisis_completo.diferencias.fase == 'Definici√≥n (P√©rdida de grasa)' else 'info' if analisis_completo.diferencias.fase == 'Volumen (Ganancia muscular)' else 'secondary' }} font-size-xs">
                        {{ analisis_completo.diferencias.fase }}
                    </span>
                    {% else %}
                    <div class="alert alert-warning mb-0 font-size-xs">
                        <i class="fa fa-exclamation-triangle"></i> No has definido objetivos.
                        <a href="/goal" class="alert-link">Definir ahora</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Card 3: Diferencias -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-info shadow-sm h-100">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fa fa-exchange-alt mr-2"></i>Cambios Necesarios</h6>
                </div>
                <div class="card-body font-size-sm">
                    {% if analisis_completo.objetivo_definido.tiene_objetivo %}
                    <table class="table table-sm table-borderless mb-0">
                        <tr>
                            <td>Peso:</td>
                            <td class="text-right font-w600 {{ 'text-danger' if analisis_completo.diferencias.peso < 0 else 'text-success' }}">
                                {{ '%+.2f'|format(analisis_completo.diferencias.peso) }} kg
                            </td>
                        </tr>
                        <tr>
                            <td>Masa Magra:</td>
                            <td class="text-right font-w600 {{ 'text-danger' if analisis_completo.diferencias.peso_magro < 0 else 'text-success' }}">
                                {{ '%+.2f'|format(analisis_completo.diferencias.peso_magro) }} kg
                            </td>
                        </tr>
                        <tr>
                            <td>Masa Grasa:</td>
                            <td class="text-right font-w600 {{ 'text-success' if analisis_completo.diferencias.peso_graso < 0 else 'text-danger' }}">
                                {{ '%+.2f'|format(analisis_completo.diferencias.peso_graso) }} kg
                            </td>
                        </tr>
                        <tr>
                            <td>BF%:</td>
                            <td class="text-right font-w600 {{ 'text-success' if analisis_completo.diferencias.bf < 0 else 'text-danger' }}">
                                {{ '%+.1f'|format(analisis_completo.diferencias.bf) }}%
                            </td>
                        </tr>
                        <tr>
                            <td>FFMI:</td>
                            <td class="text-right font-w600 {{ 'text-danger' if analisis_completo.diferencias.ffmi < 0 else 'text-success' }}">
                                {{ '%+.2f'|format(analisis_completo.diferencias.ffmi) }}
                            </td>
                        </tr>
                    </table>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Card 4: Diagn√≥stico -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-{{ 'danger' if analisis_completo.diagnostico.estado_general == 'alerta_alta' else 'warning' if analisis_completo.diagnostico.estado_general == 'alerta_media' else 'success' }} shadow-sm h-100">
                <div class="card-header bg-{{ 'danger' if analisis_completo.diagnostico.estado_general == 'alerta_alta' else 'warning' if analisis_completo.diagnostico.estado_general == 'alerta_media' else 'success' }} text-white">
                    <h6 class="mb-0">
                        <i class="fa fa-{{ 'exclamation-circle' if analisis_completo.diagnostico.estado_general == 'alerta_alta' else 'exclamation-triangle' if analisis_completo.diagnostico.estado_general == 'alerta_media' else 'check-circle' }} mr-2"></i>
                        Diagn√≥stico
                    </h6>
                </div>
                <div class="card-body font-size-xs">
                    {% if analisis_completo.diagnostico.alertas %}
                        {% for alerta in analisis_completo.diagnostico.alertas %}
                        <div class="alert alert-{{ 'danger' if analisis_completo.diagnostico.estado_general == 'alerta_alta' else 'warning' if analisis_completo.diagnostico.estado_general == 'alerta_media' else 'success' }} py-2 px-2 mb-2">
                            {{ alerta }}
                        </div>
                        {% endfor %}
                    {% else %}
                    <p class="text-muted mb-0">
                        No hay suficientes datos para diagn√≥stico. Contin√∫a registrando.
                    </p>
                    {% endif %}
                    
                    <!-- Botones de ajuste (SOLO ADMIN) o mensaje informativo -->
                    {% if analisis_completo.diagnostico and analisis_completo.diagnostico.estado_general in ['alerta_alta', 'alerta_media'] %}
                    <div class="mt-3 pt-3 border-top">
                        {% if is_admin %}
                            <!-- ADMIN: Mostrar botones de ajuste activos -->
                            <h6 class="font-w600 mb-2 text-primary">
                                <i class="fa fa-wrench mr-1"></i>Ajuste de Calor√≠as (Admin)
                            </h6>
                            <p class="text-muted font-size-sm mb-2">
                                Como administrador, puedes ajustar las calor√≠as del paciente seleccionado.
                            </p>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-success" onclick="ajustarCalorias(100)">
                                    <i class="fa fa-plus-circle mr-1"></i>+100 kcal
                                </button>
                                <button type="button" class="btn btn-success" onclick="ajustarCalorias(150)">
                                    <i class="fa fa-plus-circle mr-1"></i>+150 kcal
                                </button>
                                <button type="button" class="btn btn-warning" onclick="ajustarCalorias(-100)">
                                    <i class="fa fa-minus-circle mr-1"></i>-100 kcal
                                </button>
                                <button type="button" class="btn btn-warning" onclick="ajustarCalorias(-150)">
                                    <i class="fa fa-minus-circle mr-1"></i>-150 kcal
                                </button>
                            </div>
                        {% else %}
                            <!-- USUARIO NORMAL: Solo mensaje informativo -->
                            <div class="alert alert-info mb-0">
                                <i class="fa fa-info-circle mr-2"></i>
                                <strong>Recomendaci√≥n:</strong> Consulta estos resultados con tu nutricionista para realizar ajustes en el plan.
                            </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SECCI√ìN 2: PLANES NUTRICIONALES -->
<div class="p-4 mb-4">
    <h4 class="font-w700 mb-4 text-success">
        <i class="fa fa-utensils mr-2"></i>Planes Nutricionales y Alimentarios
    </h4>
    
    <div class="row">
        <!-- Plan Nutricional (Macros) -->
        <div class="col-lg-6 mb-3">
            <div class="card shadow h-100">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0"><i class="fa fa-calculator mr-2"></i>Plan Nutricional (Macros)</h5>
                </div>
                <div class="card-body">
                    {% if analisis_completo.plan_nutricional.tiene_plan %}
                    <!-- Calor√≠as y Libertad -->
                    <div class="row mb-3">
                        <div class="col-6 text-center">
                            <div class="bg-primary-light p-3 rounded">
                                <h2 class="font-w700 text-primary mb-0">{{ analisis_completo.plan_nutricional.calorias_totales }}</h2>
                                <small class="text-muted">Calor√≠as/d√≠a</small>
                            </div>
                        </div>
                        <div class="col-6 text-center">
                            <div class="bg-success-light p-3 rounded">
                                <h2 class="font-w700 text-success mb-0">{{ analisis_completo.plan_nutricional.libertad_porcentaje }}%</h2>
                                <small class="text-muted">Libertad</small>
                            </div>
                        </div>
                    </div>

                    <!-- Macros Totales -->
                    <h6 class="font-w700 mb-2">Macronutrientes Totales:</h6>
                    <div class="row mb-3">
                        <div class="col-4 text-center">
                            <div class="bg-danger-light p-2 rounded">
                                <strong class="text-danger d-block">{{ analisis_completo.plan_nutricional.proteina_total }}g</strong>
                                <small class="text-muted">Prote√≠na</small>
                            </div>
                        </div>
                        <div class="col-4 text-center">
                            <div class="bg-warning-light p-2 rounded">
                                <strong class="text-warning d-block">{{ analisis_completo.plan_nutricional.grasa_total }}g</strong>
                                <small class="text-muted">Grasa</small>
                            </div>
                        </div>
                        <div class="col-4 text-center">
                            <div class="bg-info-light p-2 rounded">
                                <strong class="text-info d-block">{{ analisis_completo.plan_nutricional.carbohidratos_total }}g</strong>
                                <small class="text-muted">CH</small>
                            </div>
                        </div>
                    </div>

                    <!-- Distribuci√≥n por Comidas -->
                    <h6 class="font-w700 mb-2">Distribuci√≥n por Comidas (%):</h6>
                    <div class="font-size-xs">
                        {% for comida, nombre in [('desayuno', 'Desayuno'), ('media_manana', 'Media Ma√±ana'), ('almuerzo', 'Almuerzo'), ('merienda', 'Merienda'), ('media_tarde', 'Media Tarde'), ('cena', 'Cena')] %}
                        {% set macros = analisis_completo.plan_nutricional.distribucion_comidas[comida] %}
                        {% if macros.proteina > 0 or macros.grasa > 0 or macros.carbohidratos > 0 %}
                        <div class="d-flex justify-content-between align-items-center mb-1 p-2 bg-light rounded">
                            <strong>{{ nombre }}:</strong>
                            <span>
                                <span class="badge badge-danger">P: {{ macros.proteina }}%</span>
                                <span class="badge badge-warning">G: {{ macros.grasa }}%</span>
                                <span class="badge badge-info">CH: {{ macros.carbohidratos }}%</span>
                            </span>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>

                    {% if analisis_completo.plan_nutricional.fecha_creacion %}
                    <hr class="my-2">
                    <div class="font-size-xs text-muted">
                        <div><i class="fa fa-calendar-plus mr-1"></i><strong>Fecha de creaci√≥n:</strong> {{ analisis_completo.plan_nutricional.fecha_creacion }}</div>
                        <div><i class="fa fa-clock mr-1"></i><strong>D√≠as activo:</strong> {{ analisis_completo.plan_nutricional.dias_desde_creacion }} d√≠as</div>
                        {% if analisis_completo.plan_nutricional.estrategia and analisis_completo.plan_nutricional.velocidad_cambio %}
                        <div class="mt-2 p-2 bg-primary text-white rounded">
                            <strong><i class="fa fa-chart-line mr-1"></i>Estrategia:</strong> {{ analisis_completo.plan_nutricional.estrategia }}<br>
                            <strong>Velocidad objetivo:</strong> {{ (analisis_completo.plan_nutricional.velocidad_cambio / 1000)|round(3) }} kg/semana<br>
                            {% if analisis_completo.plan_nutricional.deficit_calorico %}
                            <strong>D√©ficit:</strong> {{ analisis_completo.plan_nutricional.deficit_calorico|int }} kcal/d√≠a<br>
                            {% endif %}
                            {% if analisis_completo.plan_nutricional.disponibilidad_energetica %}
                            <strong>EA:</strong> {{ analisis_completo.plan_nutricional.disponibilidad_energetica|round(1) }} kcal/kg FFM
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="alert alert-warning mb-0">
                        <i class="fa fa-exclamation-triangle mr-2"></i>
                        No tienes plan nutricional. <a href="/planner" class="alert-link">Crear plan</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Plan Alimentario (Recetas) -->
        <div class="col-lg-6 mb-3">
            <div class="card shadow h-100">
                <div class="card-header bg-gradient-success text-white">
                    <h5 class="mb-0"><i class="fa fa-book-open mr-2"></i>Plan Alimentario (Recetas)</h5>
                </div>
                <div class="card-body">
                    {% if analisis_completo.plan_alimentario.tiene_plan %}
                    <div class="alert alert-success mb-3 font-size-sm">
                        <i class="fa fa-check-circle mr-2"></i>
                        <strong>Plan activo</strong> desde hace <strong>{{ analisis_completo.plan_alimentario.dias_desde_inicio }}</strong> d√≠as
                    </div>

                    <div class="row mb-3">
                        <div class="col-6 text-center">
                            <div class="bg-success-light p-3 rounded">
                                <h2 class="font-w700 text-success mb-0">{{ analisis_completo.plan_alimentario.total_recetas }}</h2>
                                <small class="text-muted">Recetas</small>
                            </div>
                        </div>
                        <div class="col-6 text-center">
                            <div class="bg-success-light p-3 rounded">
                                <h2 class="font-w700 text-success mb-0">{{ analisis_completo.plan_alimentario.comidas_configuradas }}</h2>
                                <small class="text-muted">Comidas</small>
                            </div>
                        </div>
                    </div>

                    <div class="font-size-sm">
                        <table class="table table-sm table-borderless mb-3">
                            <tr>
                                <td>Tipo:</td>
                                <td class="text-right font-w600">{{ analisis_completo.plan_alimentario.tipo_plan|capitalize }}</td>
                            </tr>
                            <tr>
                                <td>Inicio:</td>
                                <td class="text-right">{{ analisis_completo.plan_alimentario.fecha_inicio }}</td>
                            </tr>
                            <tr>
                                <td>Actualizaci√≥n:</td>
                                <td class="text-right">{{ analisis_completo.plan_alimentario.fecha_actualizacion or 'N/A' }}</td>
                            </tr>
                            {% if analisis_completo.plan_alimentario.calorias_del_plan %}
                            <tr>
                                <td>Calor√≠as:</td>
                                <td class="text-right font-w600">{{ analisis_completo.plan_alimentario.calorias_del_plan }} kcal</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>

                    <a href="/plan-alimentario" class="btn btn-success btn-block">
                        <i class="fa fa-edit mr-2"></i>Ver/Editar Plan
                    </a>
                    {% else %}
                    <div class="alert alert-info mb-3">
                        <i class="fa fa-info-circle mr-2"></i>
                        No tienes plan alimentario con recetas.
                    </div>
                    <a href="/plan-alimentario" class="btn btn-primary btn-block">
                        <i class="fa fa-plus-circle mr-2"></i>Crear Plan Alimentario
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SECCI√ìN 3: TASAS ESPERADAS VS ACTUALES -->
<div class="bg-light p-4 mb-4">
    <h4 class="font-w700 mb-4 text-warning">
        <i class="fa fa-chart-line mr-2"></i>Comparaci√≥n: Tasas Esperadas vs Actuales
    </h4>

    <div class="row">
        <!-- Tasas Esperadas -->
        <div class="col-lg-6 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fa fa-bullseye mr-2"></i>Tasas Esperadas (Objetivo)</h5>
                </div>
                <div class="card-body">
                    {% if analisis_completo.tasas_esperadas %}
                    <div class="alert alert-info mb-3 font-size-sm">
                        <div><strong>Fase:</strong> {{ analisis_completo.tasas_esperadas.fase|capitalize|upper }}</div>
                        <div><strong>Rango:</strong> {{ analisis_completo.tasas_esperadas.porcentaje_peso_min }} - {{ analisis_completo.tasas_esperadas.porcentaje_peso_max }} del peso/semana</div>
                        {% if analisis_completo.tasas_esperadas.dias_estimados %}
                        <div><strong>Tiempo estimado:</strong> {{ analisis_completo.tasas_esperadas.dias_estimados }} d√≠as ({{ (analisis_completo.tasas_esperadas.dias_estimados / 7)|round(1) }} semanas)</div>
                        {% endif %}
                    </div>

                    <table class="table table-sm table-bordered mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>M√©trica</th>
                                <th class="text-right">Valor (kg/sem)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Peso (rango):</strong></td>
                                <td class="text-right font-w600">
                                    {{ analisis_completo.tasas_esperadas.peso_min_semanal }} a {{ analisis_completo.tasas_esperadas.peso_max_semanal }}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Grasa:</strong></td>
                                <td class="text-right font-w600 {{ 'text-success' if analisis_completo.tasas_esperadas.grasa_semanal <= 0 else 'text-warning' }}">
                                    {{ analisis_completo.tasas_esperadas.grasa_semanal }}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>M√∫sculo:</strong></td>
                                <td class="text-right font-w600 {{ 'text-success' if analisis_completo.tasas_esperadas.musculo_semanal >= 0 else 'text-danger' }}">
                                    {{ analisis_completo.tasas_esperadas.musculo_semanal }}
                                </td>
                            </tr>
                            {% if analisis_completo.tasas_esperadas.fatrate_planner %}
                            <tr class="bg-light">
                                <td colspan="2" class="font-size-xs text-muted">
                                    <strong>F√≥rmulas del Planner:</strong>
                                    {% if analisis_completo.tasas_esperadas.fase == 'definicion' %}
                                    Fat Rate = {{ analisis_completo.tasas_esperadas.fatrate_planner }} kg/sem
                                    {% elif analisis_completo.tasas_esperadas.fase == 'volumen' %}
                                    Lean Rate = {{ analisis_completo.tasas_esperadas.leanrate_planner }} kg/sem
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="alert alert-warning mb-0">Sin datos de objetivos</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tasas Actuales -->
        <div class="col-lg-6 mb-3">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="fa fa-chart-area mr-2"></i>Tasas Actuales (Medidas)</h5>
                </div>
                <div class="card-body">
                    {% if analisis_completo.comparacion_periodos and analisis_completo.comparacion_periodos.fat_rate_actual is not none %}
                    <div class="alert alert-{{ 'info' if analisis_completo.comparacion_periodos.extrapolado else ('success' if analisis_completo.comparacion_periodos.evaluacion and analisis_completo.comparacion_periodos.evaluacion.peso_en_rango else 'warning') }} mb-3 font-size-sm">
                        <div><strong>Periodo:</strong> Desde inicio del plan ({{ analisis_completo.comparacion_periodos.dias_transcurridos }} d√≠as)</div>
                        <div><strong>Pesajes:</strong> {{ analisis_completo.comparacion_periodos.pesajes_periodo }}</div>
                        {% if analisis_completo.comparacion_periodos.extrapolado %}
                        <div class="mt-2"><strong><i class="fa fa-exclamation-circle mr-1"></i>DATOS PRELIMINARES:</strong><br>{{ analisis_completo.comparacion_periodos.mensaje_confiabilidad }}</div>
                        {% elif analisis_completo.comparacion_periodos.evaluacion %}
                        <div><strong>Estado:</strong> 
                            {% if analisis_completo.comparacion_periodos.evaluacion.peso_en_rango %}
                            <span class="text-success font-w600">‚úì En rango</span>
                            {% else %}
                            <span class="text-warning font-w600">‚ö† Fuera de rango</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>

                    <table class="table table-sm table-bordered mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>M√©trica</th>
                                <th class="text-right">Valor</th>
                                <th class="text-right">Œî vs Ideal</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Peso:</strong></td>
                                <td class="text-right font-w600">{{ analisis_completo.comparacion_periodos.peso_rate_actual|default('N/A') }} kg/sem</td>
                                <td class="text-right text-muted font-size-xs">
                                    {% if analisis_completo.comparacion_periodos.evaluacion %}
                                    {{ '%+.3f'|format(analisis_completo.comparacion_periodos.evaluacion.diferencia_peso_vs_ideal) }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Grasa:</strong></td>
                                <td class="text-right font-w600 {{ 'text-success' if (analisis_completo.comparacion_periodos.fat_rate_actual|default(0)) <= 0 else 'text-danger' }}">
                                    {{ analisis_completo.comparacion_periodos.fat_rate_actual|default('N/A') }} kg/sem
                                </td>
                                <td class="text-right text-muted font-size-xs">
                                    {% if analisis_completo.comparacion_periodos.evaluacion %}
                                    {{ '%+.3f'|format(analisis_completo.comparacion_periodos.evaluacion.diferencia_grasa_vs_ideal) }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>M√∫sculo:</strong></td>
                                <td class="text-right font-w600 {{ 'text-success' if (analisis_completo.comparacion_periodos.lean_rate_actual|default(0)) >= 0 else 'text-danger' }}">
                                    {{ analisis_completo.comparacion_periodos.lean_rate_actual|default('N/A') }} kg/sem
                                </td>
                                <td class="text-right text-muted font-size-xs">
                                    {% if analisis_completo.comparacion_periodos.evaluacion %}
                                    {{ '%+.3f'|format(analisis_completo.comparacion_periodos.evaluacion.diferencia_musculo_vs_ideal) }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    {% else %}
                    <div class="alert alert-warning mb-0 font-size-sm">
                        <i class="fa fa-exclamation-triangle mr-2"></i>
                        Necesitas al menos 4 pesajes en 2-3 semanas para calcular tasas.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Pesajes Considerados para el Diagn√≥stico -->
    {% if analisis_completo.tasas_actuales.desde_plan and analisis_completo.tasas_actuales.desde_plan.pesajes_detallados %}
    <div class="card shadow-sm mt-3">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">
                <i class="fa fa-weight mr-2"></i>Pesajes Considerados para el Diagn√≥stico
                <small class="ml-2">({{ analisis_completo.tasas_actuales.desde_plan.pesajes }} pesajes en {{ analisis_completo.tasas_actuales.desde_plan.dias_transcurridos }} d√≠as)</small>
            </h5>
        </div>
        <div class="card-body">
            <p class="text-muted font-size-sm mb-3">
                <i class="fa fa-info-circle mr-1"></i>
                Estos son los pesajes usados para calcular las tasas actuales y generar el diagn√≥stico.
                El <strong>baseline</strong> es el punto de referencia inicial (al inicio del plan) y se compara con el <strong>√∫ltimo pesaje</strong>.
            </p>
            
            <div class="table-responsive">
                <table class="table table-sm table-bordered table-hover mb-0">
                    <thead class="thead-dark">
                        <tr>
                            <th class="text-center" style="width: 15%;">Fecha</th>
                            <th class="text-center" style="width: 15%;">Peso (kg)</th>
                            <th class="text-center" style="width: 17%;">Masa Grasa (kg)</th>
                            <th class="text-center" style="width: 17%;">Masa Magra (kg)</th>
                            <th class="text-center" style="width: 18%;">Œî Masa Grasa</th>
                            <th class="text-center" style="width: 18%;">Œî Masa Magra</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set baseline = analisis_completo.tasas_actuales.desde_plan.pesajes_detallados[0] %}
                        {% for pesaje in analisis_completo.tasas_actuales.desde_plan.pesajes_detallados %}
                        <tr class="{% if pesaje.es_baseline %}table-primary{% elif pesaje.es_ultimo %}table-success{% endif %}">
                            <td class="text-center font-w600">
                                {{ pesaje.fecha }}
                                {% if pesaje.es_baseline %}
                                <span class="badge badge-primary ml-1">BASELINE</span>
                                {% elif pesaje.es_ultimo %}
                                <span class="badge badge-success ml-1">√öLTIMO</span>
                                {% endif %}
                            </td>
                            <td class="text-center">{{ pesaje.peso }}</td>
                            <td class="text-center">{{ pesaje.masa_grasa }}</td>
                            <td class="text-center">{{ pesaje.masa_magra }}</td>
                            <td class="text-center">
                                {% if not pesaje.es_baseline %}
                                    {% set delta_grasa = pesaje.masa_grasa - baseline.masa_grasa %}
                                    <span class="{% if delta_grasa < 0 %}text-success{% elif delta_grasa > 0 %}text-danger{% endif %}">
                                        {{ "%.2f"|format(delta_grasa) }} kg
                                        {% if delta_grasa < 0 %}
                                        <i class="fa fa-arrow-down"></i>
                                        {% elif delta_grasa > 0 %}
                                        <i class="fa fa-arrow-up"></i>
                                        {% endif %}
                                    </span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if not pesaje.es_baseline %}
                                    {% set delta_magra = pesaje.masa_magra - baseline.masa_magra %}
                                    <span class="{% if delta_magra > 0 %}text-success{% elif delta_magra < 0 %}text-danger{% endif %}">
                                        {{ "%.2f"|format(delta_magra) }} kg
                                        {% if delta_magra > 0 %}
                                        <i class="fa fa-arrow-up"></i>
                                        {% elif delta_magra < 0 %}
                                        <i class="fa fa-arrow-down"></i>
                                        {% endif %}
                                    </span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Resumen de cambios -->
            {% set baseline = analisis_completo.tasas_actuales.desde_plan.pesajes_detallados[0] %}
            {% set ultimo = analisis_completo.tasas_actuales.desde_plan.pesajes_detallados[-1] %}
            <div class="row mt-3">
                <div class="col-md-4">
                    <div class="alert alert-primary mb-0">
                        <strong>Cambio Total de Peso:</strong><br>
                        {{ "%.2f"|format(ultimo.peso - baseline.peso) }} kg
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-{{ 'success' if (ultimo.masa_grasa - baseline.masa_grasa) < 0 else 'danger' }} mb-0">
                        <strong>Cambio Masa Grasa:</strong><br>
                        {{ "%.2f"|format(ultimo.masa_grasa - baseline.masa_grasa) }} kg
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-{{ 'success' if (ultimo.masa_magra - baseline.masa_magra) > 0 else 'danger' }} mb-0">
                        <strong>Cambio Masa Magra:</strong><br>
                        {{ "%.2f"|format(ultimo.masa_magra - baseline.masa_magra) }} kg
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Hist√≥rico Completo -->
    <div class="card shadow-sm mt-3">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="fa fa-history mr-2"></i>Hist√≥rico de Tasas por Periodo</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-striped table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>Periodo</th>
                            <th class="text-center">Pesajes</th>
                            <th class="text-center">Fat Rate</th>
                            <th class="text-center">Lean Rate</th>
                            <th class="text-center">Peso Rate</th>
                            <th class="text-center">CV%</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if analisis_completo.tasas_actuales.desde_plan %}
                        {% set datos = analisis_completo.tasas_actuales.desde_plan %}
                        <tr>
                            <td class="font-w600">Desde Plan Nutricional</td>
                            <td class="text-center">
                                <span class="badge badge-{{ 'success' if datos.datos_suficientes else 'info' if datos.pesajes > 0 else 'secondary' }}">
                                    {{ datos.pesajes|default(0) }}
                                </span>
                            </td>
                            <td class="text-center {{ 'text-success font-w600' if datos.fat_rate and datos.fat_rate <= 0 else 'text-danger font-w600' if datos.fat_rate else 'text-muted' }}">
                                {{ datos.fat_rate|round(3) if datos.fat_rate is not none else 'N/D' }}
                            </td>
                            <td class="text-center {{ 'text-success font-w600' if datos.lean_rate and datos.lean_rate >= 0 else 'text-danger font-w600' if datos.lean_rate else 'text-muted' }}">
                                {{ datos.lean_rate|round(3) if datos.lean_rate is not none else 'N/D' }}
                            </td>
                            <td class="text-center font-w600">
                                {{ datos.peso_rate|round(3) if datos.peso_rate is not none else 'N/D' }}
                            </td>
                            <td class="text-center text-muted font-size-xs">
                                {% if datos.extrapolado %}
                                <span class="text-warning">‚ö† Preliminar</span>
                                {% elif datos.cv is not none %}
                                {{ (datos.cv * 100)|round(1) }}%
                                {% else %}
                                N/D
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted">No hay datos disponibles</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            <div class="font-size-xs text-muted mt-2">
                <strong>CV (Coeficiente de Variaci√≥n):</strong> Mide la consistencia de los pesajes. Valores bajos (&lt;2%) indican datos m√°s confiables.
            </div>
        </div>
    </div>
</div>

<hr class="my-4">

<h4 class="font-w700 mb-3 text-secondary">
    <i class="fa fa-table mr-2"></i>Tablas Detalladas de Performance Clock
</h4>

{% endif %}

<!-- FIN DE AN√ÅLISIS COMPLETO - Aqu√≠ empieza el c√≥digo original del performance_clock -->

                        {% for scenario in performance_clock.values() %}
                        <div class="col-lg-4">
                            <h4 class="font-w700 font-size-h5">{{ scenario.label }}</h4>
                            <div class="table-responsive">
                                <table class="table table-sm table-borderless table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th>Periodo</th>
                                            <th>Fatrate</th>
                                            <th>Leanrate</th>
                                            <th>Confianza</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for timeframe in scenario.timeframes.values() %}
                                        <tr>
                                            <td class="font-w600">{{ timeframe.label }}</td>
                                            <td>
                                                {% if timeframe.fat_rate is not none %}
                                                    {% set fat_class = 'text-success' if timeframe.fat_rate <= 0 else 'text-danger' %}
                                                    <span class="font-w600 {{ fat_class }}">{{ timeframe.fat_rate|round(2) }} kg/sem</span>
                                                    {% if timeframe.fat_diff is not none %}
                                                        {% set fat_diff_class = 'text-success' if timeframe.fat_diff >= 0 else 'text-danger' %}
                                                        <div class="font-size-sm {{ fat_diff_class }}">Œî {{ timeframe.fat_diff|abs|round(2) }} vs ideal</div>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">Sin datos suficientes</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if timeframe.lean_rate is not none %}
                                                    {% set lean_class = 'text-success' if timeframe.lean_rate >= 0 else 'text-danger' %}
                                                    <span class="font-w600 {{ lean_class }}">{{ timeframe.lean_rate|round(2) }} kg/sem</span>
                                                    {% if timeframe.lean_diff is not none %}
                                                        {% set lean_diff_class = 'text-success' if timeframe.lean_diff >= 0 else 'text-danger' %}
                                                        <div class="font-size-sm {{ lean_diff_class }}">Œî {{ timeframe.lean_diff|abs|round(2) }} vs ideal</div>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">Sin datos suficientes</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% set confidence = timeframe.confidence %}
                                                {% if confidence.count > 0 %}
                                                    <span class="font-w600">{{ confidence.count }}</span> pesajes
                                                    <div class="text-muted font-size-sm">
                                                        {% if confidence.cv is not none %}
                                                            CV {{ (confidence.cv * 100)|round(1) }}%
                                                        {% else %}
                                                            CV n/d
                                                        {% endif %}
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted">Sin registros</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- END Overview -->

    <!-- Gauges Horizontales -->
    <div class="row row-deck">
        <!-- IMC Gauge -->
        <div class="col-lg-4 col-md-6 col-sm-12">
            <div class="block block-rounded d-flex flex-column">
                <div class="block-content block-content-full flex-grow-1 d-flex justify-content-between align-items-center">
                    <dl class="mb-0">
                        <dt class="font-size-h2 font-w700">
                            {{ imc }}
                            {% if deltaimc>=0 %}
                            <span class="font-size-sm font-w600 text-success ml-2">
                                <i class="fa fa-caret-up"></i> {{ deltaimc }}%
                            </span>
                            {% else %}
                            <span class="font-size-sm font-w600 text-danger ml-2">
                                <i class="fa fa-caret-down"></i> {{ deltaimc }}%
                            </span>
                            {% endif %}
                        </dt>
                        <dd class="text-muted mb-0">√çndice de masa corporal</dd>
                    </dl>
                    <div class="item item-rounded bg-body">
                        <i class="fa fa-weight font-size-h3 text-primary"></i>
                    </div>
                </div>
                <div class="block-content text-center overflow-hidden">
                    <!-- IMC Gauge -->
                    <div class="metric-gauge imc-gauge" data-value="{{ imc }}">
                        <div class="gauge-category bajo-peso"></div>
                        <div class="gauge-category normal"></div>
                        <div class="gauge-category sobrepeso"></div>
                        <div class="gauge-category obesidad"></div>
                    </div>
                </div>
                <div class="block-content block-content-full block-content-sm bg-body-light font-size-sm">
                    <a class="font-w500 d-flex align-items-center">
                        {{ imccat }}
                    </a>
                </div>
            </div>
        </div>
        
        <!-- FFMI Gauge -->
        <div class="col-lg-4 col-md-6 col-sm-12">
            <div class="block block-rounded d-flex flex-column">
                <div class="block-content block-content-full flex-grow-1 d-flex justify-content-between align-items-center">
                    <dl class="mb-0">
                        <dt class="font-size-h2 font-w700">
                            {{ ffmi }}
                            {% if deltaffmi>=0 %}
                            <span class="font-size-sm font-w600 text-success ml-2">
                                <i class="fa fa-caret-up"></i> {{ deltaffmi }}%
                            </span>
                            {% else %}
                            <span class="font-size-sm font-w600 text-danger ml-2">
                                <i class="fa fa-caret-down"></i> {{ deltaffmi }}%
                            </span>
                            {% endif %}
                        </dt>
                        <dd class="text-muted mb-0">√çndice de masa magra corporal</dd>
                    </dl>
                    <div class="item item-rounded bg-body">
                        <i class="fa fa-dumbbell font-size-h3 text-primary"></i>
                    </div>
                </div>
                <div class="block-content text-center overflow-hidden">
                    <!-- FFMI Gauge -->
                    <div class="metric-gauge ffmi-gauge" data-value="{{ ffmi }}">
                        <div class="gauge-category muy-pobre"></div>
                        <div class="gauge-category pobre"></div>
                        <div class="gauge-category bajo"></div>
                        <div class="gauge-category casi-normal"></div>
                        <div class="gauge-category normal"></div>
                        <div class="gauge-category bueno"></div>
                        <div class="gauge-category muy-bueno"></div>
                        <div class="gauge-category excelente"></div>
                        <div class="gauge-category superior"></div>
                    </div>
                </div>
                <div class="block-content block-content-full block-content-sm bg-body-light font-size-sm">
                    <a class="font-w500 d-flex align-items-center">
                        {{ immccat }}
                    </a>
                </div>
            </div>
        </div>
        
        <!-- %BF Gauge -->
        <div class="col-lg-4 col-md-12 col-sm-12">
            <div class="block block-rounded d-flex flex-column">
                <div class="block-content block-content-full flex-grow-1 d-flex justify-content-between align-items-center">
                    <dl class="mb-0">
                        <dt class="font-size-h2 font-w700">
                            {{ bf }}%
                            {% if deltabf<=0 %}
                            <span class="font-size-sm font-w600 text-success ml-2">
                                <i class="fa fa-caret-down"></i> {{ deltabf }}%
                            </span>
                            {% else %}
                            <span class="font-size-sm font-w600 text-danger ml-2">
                                <i class="fa fa-caret-up"></i> {{ deltabf }}%
                            </span>
                            {% endif %}
                        </dt>
                        <dd class="text-muted mb-0">Porcentaje de grasa corporal</dd>
                    </dl>
                    <div class="item item-rounded bg-body">
                        <i class="fa fa-chart-pie font-size-h3 text-primary"></i>
                    </div>
                </div>
                <div class="block-content text-center overflow-hidden">
                    <!-- %BF Gauge -->
                    <div class="metric-gauge bf-gauge" data-value="{{ bf }}">
                        <div class="gauge-category esencial"></div>
                        <div class="gauge-category atletico"></div>
                        <div class="gauge-category fitness"></div>
                        <div class="gauge-category promedio"></div>
                        <div class="gauge-category alto"></div>
                        <div class="gauge-category obesidad"></div>
                    </div>
                </div>
                <div class="block-content block-content-full block-content-sm bg-body-light font-size-sm">
                    <a class="font-w500 d-flex align-items-center">
                        {{ bfcat }}
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- END Gauges Horizontales -->

    <!-- Statistics -->
    <div class="row">
        <div class="col-12">
            <!-- Earnings Summary -->
            <div class="block block-rounded flex-grow-1 d-flex flex-column">
                <div class="block-header block-header-default">
                    <h3 class="block-title">Pesos</h3>
                    <div class="block-options">
                        <button type="button" class="btn-block-option" data-toggle="block-option" data-action="state_toggle" data-action-mode="demo">
                            <i class="si si-refresh"></i>
                        </button>
                    </div>
                </div>
                <div class="block-content block-content-full flex-grow-1 d-flex align-items-center">
                    <!-- Earnings Chart Container -->
                    <!-- Chart.js Chart is initialized in js/pages/be_pages_dashboard.min.js which was auto compiled from _js/pages/be_pages_dashboard.js -->
                    <!-- For more info and examples you can check out http://www.chartjs.org/docs/ -->
                    <div id="chart-weight-apex" style="min-height: 415px;" class="w-100"></div>
                </div>
                <div class="block-content bg-body-light">
                    <div class="row items-push text-center w-100">
                        <div class="col-sm-4">
                            <dl class="mb-0">
                                <dt class="font-size-h3 font-w700">
                                    {% if deltapeso<=0 %}
                                    <i class="fa fa-arrow-down font-size-lg text-danger"></i> {{ deltapeso }} gr.
                                    {% else %}
                                    <i class="fa fa-arrow-up font-size-lg text-success"></i> {{ deltapeso }} gr.
                                    {% endif %}
                                </dt>
                                <dd class="text-muted mb-0">Variaci√≥n de peso</dd>
                            </dl>
                        </div>
                        <div class="col-sm-4">
                            <dl class="mb-0">
                                <dt class="font-size-h3 font-w700">
                                    {% if deltapg<=0 %}
                                    <i class="fa fa-arrow-down font-size-lg text-danger"></i> {{ deltapg }} gr.
                                    {% else %}
                                    <i class="fa fa-arrow-up font-size-lg text-success"></i> {{ deltapg }} gr.
                                    {% endif %}
                                </dt>
                                <dd class="text-muted mb-0">Variaci√≥n en la masa grasa</dd>
                            </dl>
                        </div>
                        <div class="col-sm-4">
                            <dl class="mb-0">
                                <dt class="font-size-h3 font-w700">
                                    {% if deltapm<=0 %}
                                    <i class="fa fa-arrow-down font-size-lg text-danger"></i> {{ deltapm }} gr.
                                    {% else %}
                                    <i class="fa fa-arrow-up font-size-lg text-success"></i> {{ deltapm }} gr.
                                    {% endif %}
                                </dt>
                                <dd class="text-muted mb-0">Variaci√≥n en la masa magra</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END Earnings Summary -->
        </div>
    </div>
    <!-- END Statistics -->

    <!-- Base de datos -->
    <div class="block block-rounded">
        <ul class="nav nav-tabs nav-tabs-alt" data-toggle="tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link" href="#btabs-alt-static-stat">Perfil Est√°tico</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="#btabs-alt-static-dyna">Perfil Din√°mico</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#btabs-alt-static-anal">Analisis</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#btabs-alt-static-goal">Objetivos</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#btabs-alt-static-fore">Pron√≥stico</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#btabs-alt-static-diet">Dieta</a>
            </li>
        </ul>
        <div class="block-content tab-content">
            <div class="tab-pane" id="btabs-alt-static-diet" role="tabpanel">
                <div class="block-content block-content-full">
                    <!-- DataTables init on table by adding .js-dataTable-full-pagination class, functionality is initialized in js/pages/be_tables_datatables.min.js which was auto compiled from _js/pages/be_tables_datatables.js -->
                    <table class="table table-bordered table-striped table-vcenter js-dataTable-full-pagination">
                        <thead>
                            <tr>
                                <th>Calorias</th>
                                <th>Prote√≠na</th>
                                <th class="d-none d-sm-table-cell">Grasa</th>
                                <th class="d-none d-sm-table-cell">Carbohidratos</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dieta in dieta %}
                            <tr>
                                <td class="font-w600 font-size-sm">{{dieta.2}}</td>
                                <td class="font-w600 font-size-sm">{{dieta.3}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dieta.4}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dieta.5}}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane active" id="btabs-alt-static-dyna" role="tabpanel">
                <div class="block-content block-content-full">
                    <!-- DataTables init on table by adding .js-dataTable-full-pagination class, functionality is initialized in js/pages/be_tables_datatables.min.js which was auto compiled from _js/pages/be_tables_datatables.js -->
                    <table class="table-responsive table-bordered table-striped table-vcenter js-dataTable-full-pagination-date">
                        <thead>
                            <tr>
                                <th>Fecha de Registro</th>
                                <th>Peso</th>
                                <th class="d-none d-sm-table-cell">Perimetro de abdomen</th>
                                <th class="d-none d-sm-table-cell">Perimetro de c√≠ntura</th>
                                <th class="d-none d-sm-table-cell">Perimetro de cadera</th>
                                <th>% de grasa corporal</th>
                                <th class="d-none d-sm-table-cell">IMC</th>
                                <th>IMMC</th>
                                <th class="d-none d-sm-table-cell">Peso graso</th>
                                <th class="d-none d-sm-table-cell">Peso magro</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dinamico in dinamico %}
                            <tr>
                                <td class="font-w600 font-size-sm">{{dinamico.2}}</td>
                                <td class="font-w600 font-size-sm">{{dinamico.6}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.5}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.3}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.4}}</td>
                                <td class="font-w600 font-size-sm">{{dinamico.7}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.8}}</td>
                                <td class="font-w600 font-size-sm">{{dinamico.9}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.10}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.11}}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane" id="btabs-alt-static-anal" role="tabpanel">
                <div class="block-content block-content-full">
                    <!-- DataTables init on table by adding .js-dataTable-full-pagination class, functionality is initialized in js/pages/be_tables_datatables.min.js which was auto compiled from _js/pages/be_tables_datatables.js -->
                    <table class="table-responsive table-bordered table-striped table-vcenter js-dataTable-full-pagination-date">
                        <thead>
                            <tr>
                                <th>Fecha de Registro</th>
                                <th class="d-none d-sm-table-cell">Œî de d√≠as</th>
                                <th>Œî de peso</th>
                                <th class="d-none d-sm-table-cell">Categor√≠a Œî Peso </th>
                                <th class="d-none d-sm-table-cell">Œî PG</th>
                                <th class="d-none d-sm-table-cell">Œî PM</th>
                                <th class="d-none d-sm-table-cell">Relaci√≥n de perdida de PM (RPPM)</th>
                                <th>Categor√≠a de (RPPM)</th>
                                <th class="d-none d-sm-table-cell">Relaci√≥n de ganancia de PG (RGPG)</th>
                                <th>Categor√≠a de RGPG</th>
                                <th class="d-none d-sm-table-cell">Puntaje IMMC</th>
                                <th class="d-none d-sm-table-cell">Puntaje BF</th>
                                <th>Puntaje corporal</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dinamico in dinamico %}
                            <tr>
                                <td class="font-w600 font-size-sm">{{dinamico.2}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.12}}</td>
                                <td class="font-w600 font-size-sm">{{dinamico.13}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.19}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.15}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.17}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.20}}</td>
                                <td class="font-w600 font-size-sm">{{dinamico.21}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.22}}</td>
                                <td class="font-w600 font-size-sm">{{dinamico.23}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.24}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.25}}</td>
                                <td class="font-w600 font-size-sm">{{dinamico.26}}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane" id="btabs-alt-static-fore" role="tabpanel">
                <div class="block-content block-content-full">
                    <!-- DataTables init on table by adding .js-dataTable-full-pagination class, functionality is initialized in js/pages/be_tables_datatables.min.js which was auto compiled from _js/pages/be_tables_datatables.js -->
                    <table class="table-responsive table-bordered table-striped table-vcenter js-dataTable-full-pagination-date">
                        <thead>
                            <tr>
                                <th>Fecha de Registro</th>
                                <th class="d-none d-sm-table-cell">Peso objetivo</th>
                                <th class="d-none d-sm-table-cell">Peso magro objetivo</th>
                                <th class="d-none d-sm-table-cell">Peso graso objetivo</th>
                                <th class="d-none d-sm-table-cell">Per√≠metro de abdomen</th>
                                <th class="d-none d-sm-table-cell">Per√≠metro de cintura</th>
                                <th class="d-none d-sm-table-cell">Per√≠metro de cadera</th>
                                <th class="d-none d-sm-table-cell">D√≠as de aumento de peso</th>
                                <th class="d-none d-sm-table-cell">D√≠as de descenso de peso</th>
                                <th>D√≠as para llegar al objetivo</th>
                                <th class="d-none d-sm-table-cell">Categoria</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dinamico in dinamico %}
                            <tr>
                                <td class="font-w600 font-size-sm">{{dinamico.2}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.30}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.31}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.32}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.33}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.34}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.35}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.27}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.28}}</td>
                                <td class="font-w600 font-size-sm">{{dinamico.29}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{dinamico.36}}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane" id="btabs-alt-static-stat" role="tabpanel">
                <div class="block-content block-content-full">
                    <!-- DataTables init on table by adding .js-dataTable-full-pagination class, functionality is initialized in js/pages/be_tables_datatables.min.js which was auto compiled from _js/pages/be_tables_datatables.js -->
                    <table class="table table-bordered table-striped table-vcenter js-dataTable-full-pagination">
                        <thead>
                            <tr>
                                <th>Nombre y apellido</th>
                                <th class="d-none d-sm-table-cell">DNI</th>
                                <th class="d-none d-sm-table-cell">N√∫mero de Telefono</th>
                                <th class="d-none d-sm-table-cell">Email</th>
                                <th class="d-none d-sm-table-cell">Sexo</th>
                                <th class="d-none d-sm-table-cell">Fecha de Nacimiento</th>
                                <th class="d-none d-sm-table-cell">Altura</th>
                                <th class="d-none d-sm-table-cell">Cuello</th>
                                <th class="d-none d-sm-table-cell">Mu√±eca</th>
                                <th class="d-none d-sm-table-cell">Tobillo</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for estatico in estatico %}
                            <tr>
                                <td class="font-w600 font-size-sm">{{estatico.0}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{estatico.1}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{estatico.2}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{estatico.3}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{estatico.4}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{estatico.5}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{estatico.6}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{estatico.7}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{estatico.8}}</td>
                                <td class="d-none d-sm-table-cell font-w600 font-size-sm">{{estatico.9}}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane" id="btabs-alt-static-goal" role="tabpanel">
                <div class="block-content block-content-full">
                    <!-- DataTables init on table by adding .js-dataTable-full-pagination class, functionality is initialized in js/pages/be_tables_datatables.min.js which was auto compiled from _js/pages/be_tables_datatables.js -->
                    <table class="table table-bordered table-striped table-vcenter js-dataTable-full-pagination">
                        <thead>
                            <tr>
                                <th>IMMC objetivo</th>
                                <th>BF objetivo</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for objetivo in objetivo %}
                            <tr>
                                <td class="font-w600 font-size-sm">{{objetivo.1}}</td>
                                <td class="font-w600 font-size-sm">{{objetivo.2}}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- END Base de datos -->

{% endblock %}

{% block customscripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.1.0/chart.min.js"></script>
<!--Plugin CSS file with desired skin-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/css/ion.rangeSlider.min.css"/>

<!--Plugin JavaScript file-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/js/ion.rangeSlider.min.js"></script>   
<script>
    jQuery(function(){
        // Set Global Chart.js configuration
        Chart.defaults.color                                = '#999';
        Chart.defaults.scale.grid.color                     = 'transparent';
        Chart.defaults.scale.grid.zeroLineColor             = 'transparent';
        Chart.defaults.elements.line.borderWidth            = 2;
        Chart.defaults.elements.point.radius                = 4;
        Chart.defaults.elements.point.hoverRadius           = 6;
        Chart.defaults.plugins.tooltip.radius               = 4;
        Chart.defaults.plugins.legend.display               = true;

        // Prepare data for ApexCharts
        var dinamicoData = {{ dinamico|tojson }};
        var dates = [];
        var weights = [];
        var fatMassKg = []; // Array para Kilos Grasos

        if (dinamicoData && dinamicoData.length > 0) {
            dinamicoData.forEach(function(entry) {
                dates.push(entry[2]); // FECHA_REGISTRO
                var currentWeight = parseFloat(entry[6]); // PESO_ACTUAL
                var bodyFatPercentage = parseFloat(entry[10]); // PORCENTAJE_GRASA_CORPORAL_NUM
                
                weights.push(currentWeight);
                
                // Calcular Kilos Grasos: Peso * (%Grasa / 100)
                var currentFatMass = currentWeight * (bodyFatPercentage / 100.0);
                fatMassKg.push(currentFatMass.toFixed(1)); // Guardar con 1 decimal
            });
        }

        var today = new Date();
        var oneYearAgo = new Date(new Date().setFullYear(today.getFullYear() - 1));

        var optionsApexWeight = {
          series: [{
            name: 'Peso (Kg)',
            data: weights
          }, {
            name: 'Kilos Grasos (Kg)',
            data: fatMassKg
          }],
          colors: ['#808080', '#e56767'], // Gris para Peso Total, color #e56767 para Kilos Grasos
          chart: {
            height: 400, // Aumentada la altura
            type: 'line',
            width: '100%',
            zoom: {
              enabled: true
            },
            toolbar: {
              show: true
            }
          },
          dataLabels: {
            enabled: false
          },
          stroke: {
            curve: 'smooth',
            width: [2, 2]
          },
          title: {
            text: 'Evoluci√≥n del Peso y Kilos Grasos',
            align: 'left'
          },
          markers: {
            size: 3
          },
          xaxis: {
            type: 'datetime',
            min: oneYearAgo.getTime(),
            max: today.getTime(),
            categories: dates,
            title: {
              text: 'Fecha'
            },
            labels: {
              datetimeUTC: false,
              format: 'dd MMM yy'
            }
          },
          yaxis: { // Configuraci√≥n para un √∫nico eje Y
            title: {
              text: 'Kilogramos (Kg)'
            },
            labels: {
              formatter: function (val) { 
                return val !== null && val !== undefined ? val.toFixed(1) + " Kg" : ""; 
              }
            }
          },
          tooltip: {
            x: {
              format: 'dd MMM yyyy'
            },
            y: [
                {
                    formatter: function(value) {
                        return value !== null && value !== undefined ? value.toFixed(1) + " Kg" : "";
                    }
                },
                {
                    formatter: function(value) {
                        return value !== null && value !== undefined ? parseFloat(value).toFixed(1) + " Kg" : "";
                    }
                }
            ]
          },
          legend: {
            position: 'top',
            horizontalAlign: 'right',
            floating: true,
            offsetY: -25,
            offsetX: -5
          },
          noData: {
            text: 'No hay datos disponibles.',
            align: 'center',
            verticalAlign: 'middle',
            offsetX: 0,
            offsetY: 0,
            style: {
              fontSize: '14px'
            }
          }
        };

        var chartElement = document.querySelector("#chart-weight-apex");
        if (chartElement) {
            var chartApexWeight = new ApexCharts(chartElement, optionsApexWeight);
            chartApexWeight.render();
        } else {
            console.error("Element #chart-weight-apex not found for ApexCharts.");
        }
    });
</script>
<!-- Gauges JavaScript -->
<script src="{{ url_for('static', filename='assets/js/gauges.js') }}"></script>

<!-- JavaScript para Ajuste de Calor√≠as -->
<script>
function ajustarCalorias(ajuste) {
    const paciente = '{{ paciente_seleccionado or username }}';
    const signo = ajuste > 0 ? '+' : '';
    const accion = ajuste > 0 ? 'aumentar' : 'reducir';
    if (!confirm(`¬øConfirmar ajuste de ${signo}${ajuste} kcal para ${paciente}?\n\nSe recalcular√° autom√°ticamente:\n- Calor√≠as totales (${accion})\n- Macronutrientes (f√≥rmulas del planner)\n- Disponibilidad energ√©tica\n- Factor de actividad\n\nEl d√©ficit y velocidad objetivo se mantendr√°n.`)) {
        return;
    }
    
    // Deshabilitar botones durante la petici√≥n
    const botones = document.querySelectorAll('.btn-group button');
    botones.forEach(btn => {
        btn.disabled = true;
        btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Procesando...';
    });
    
    fetch('/api/plan-nutricional/ajustar-calorias', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ ajuste: ajuste, paciente: paciente })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Mostrar resultado
            alert(`‚úÖ ${data.message}\n\nNuevos valores:\n` +
                  `Calor√≠as: ${data.datos_nuevos.calorias} kcal\n` +
                  `Prote√≠na: ${data.datos_nuevos.proteina}g\n` +
                  `Grasa: ${data.datos_nuevos.grasa}g\n` +
                  `CH: ${data.datos_nuevos.carbohidratos}g\n` +
                  `D√©ficit: ${data.datos_nuevos.deficit} kcal (IGUAL)\n` +
                  `EA: ${data.datos_nuevos.ea} kcal/kg FFM\n\n` +
                  `Velocidad objetivo: ${data.datos_nuevos.velocidad_objetivo} kg/sem (MANTENIDA)\n\n` +
                  `üèãÔ∏è Factor de Actividad Recalculado:\n` +
                  `TMB: ${data.datos_nuevos.tmb} kcal\n` +
                  `TDEE: ${data.datos_nuevos.tdee} kcal\n` +
                  `Factor: ${data.datos_nuevos.factor_actividad}\n` +
                  `(Se usar√° este valor en pr√≥ximos planes)`);
            
            // Recargar p√°gina para ver cambios
            location.reload();
        } else {
            alert(`‚ùå Error: ${data.message}`);
            botones.forEach(btn => {
                btn.disabled = false;
                btn.innerHTML = btn.innerHTML.replace('Procesando...', '');
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error al ajustar calor√≠as. Ver consola para detalles.');
        botones.forEach(btn => {
            btn.disabled = false;
            btn.innerHTML = btn.innerHTML.replace('Procesando...', '');
        });
    });
}
</script>

{% endblock %}

