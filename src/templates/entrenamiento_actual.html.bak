{% extends "base/base.html" %}
{% block title %}{{ title }} | OmegaNutrición{% endblock %}

{% block extra_head %}
<!-- Incluir CSS personalizado para entrenamiento -->
<link rel="stylesheet" href="{{ url_for('static', filename='assets/css/training.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<!-- Pasar datos del ejercicio como JSON para procesamiento en JavaScript -->
<!-- Los datos de ejercicios se pasan como atributo data en formato seguro -->
<div id="ejercicios-data" data-ejercicios='{{ ejercicios|tojson }}'></div>
<script>
    // Esta función se ejecutará cuando el DOM esté cargado
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // Obtener los datos desde el atributo data
            const ejerciciosRaw = document.getElementById('ejercicios-data').dataset.ejercicios;
            const ejerciciosArray = JSON.parse(ejerciciosRaw);
            
            // Procesar los datos en formato adecuado
            window.ejerciciosData = ejerciciosArray.map(function(item) {
                const partes = item.split(':');
                const nombre = partes[0].trim();
                const esTest = item.includes('TEST');
                
                let descripcion = '';
                let peso = '0 kg';
                let pesoValor = 0;
                let seriesBruto = '';
                
                if (partes.length > 1) {
                    const infoParts = partes[1].split('-');
                    
                    if (infoParts.length > 0) {
                        seriesBruto = infoParts[0].trim();
                        descripcion = infoParts[0].trim();
                    }
                    
                    if (infoParts.length > 1) {
                        peso = infoParts[1].trim();
                        if (peso.includes('kg')) {
                            pesoValor = parseFloat(peso.replace('kg', '').trim());
                        }
                    }
                }
                
                return {
                    nombre: nombre,
                    esTest: esTest,
                    descripcion: descripcion,
                    peso: peso,
                    pesoValor: pesoValor,
                    seriesBruto: seriesBruto
                };
            });
            
            console.log('Ejercicios procesados correctamente:', window.ejerciciosData);
        } catch (error) {
            console.error('Error al procesar los datos de ejercicios:', error);
        }
    });
</script>
{% endblock %}

{% block content %}
<div class="content">
    <!-- Título de la página -->
    <div class="block block-rounded">
        <div class="block-header block-header-default">
            <h3 class="block-title"><i class="fa fa-dumbbell mr-2"></i>{{ titulo_entrenamiento }}</h3>
            <div class="block-options">
                <button type="button" class="btn-block-option" data-toggle="block-option" data-action="fullscreen_toggle"><i class="si si-size-fullscreen"></i></button>
            </div>
        </div>

        <div class="block-content">
            {% if ejercicios %}
                <!-- Formulario para enviar datos de entrenamiento al servidor -->
                <form id="entrenamiento-form" method="POST" action="{{ url_for('entrenamiento_completado') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <!-- Timer compartido para todos los ejercicios -->
                <div class="row mb-4">
                    <div class="col-md-6 mx-auto">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h4 class="mb-3"><i class="fa fa-clock mr-2"></i>Timer de descanso</h4>
                                <div class="timer-display" id="timer-display">00:00</div>
                                <div class="timer-buttons">
                                    <button class="btn btn-success btn-sm mr-2" id="start-timer">
                                        <i class="fa fa-play mr-1"></i>Iniciar
                                    </button>
                                    <button class="btn btn-info btn-sm mr-2" id="pause-timer">
                                        <i class="fa fa-pause mr-1"></i>Pausar
                                    </button>
                                    <button class="btn btn-danger btn-sm mr-2" id="reset-timer">
                                        <i class="fa fa-undo mr-1"></i>Reiniciar
                                    </button>
                                    <button class="btn btn-warning btn-sm" id="add30s-timer">
                                        <i class="fa fa-plus mr-1"></i>30s
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Contenedor para los ejercicios -->
                <div class="row" id="exercise-container">
                    <!-- Los ejercicios se generarán dinámicamente mediante JavaScript -->
                    <!-- Esto garantiza mejor consistencia entre datos y presentación -->
                </div>
                
                <!-- Template HTML para ejercicios (no se muestra directamente) -->
                <template id="exercise-template">
                    <div class="col-md-6 mb-4">
                        <div class="exercise-card" id="">
                            <div class="exercise-header">
                                <h4 class="exercise-name"></h4>
                                <span class="exercise-badge"></span>
                            </div>
                            <div class="exercise-content">
                                <!-- Indicador de peso -->
                                <div class="weight-info" data-weight="">
                                    <i class="fa fa-weight-hanging weight-icon"></i> <span class="weight-value"></span>
                                </div>
                                
                                <!-- Descripción del ejercicio -->
                                <div class="exercise-prescription mt-2 mb-2">
                                    <i class="fa fa-clipboard-list text-muted mr-1"></i>
                                    <span class="prescription-text"></span>
                                </div>
                                
                                <!-- Series efectivas -->
                                <div class="series-section">
                                    <h6 class="mt-3 mb-2">
                                        <i class="fa fa-list-ol text-primary mr-1"></i> 
                                        Series efectivas:
                                    </h6>
                                    <div class="sets-container"></div>
                                </div>
                                
                                <!-- Series de calentamiento -->
                                <div class="warmup-section mt-3" style="display:none">
                                    <h6 class="warmup-title">
                                        <i class="fa fa-fire text-warning mr-1"></i> Series de calentamiento
                                        <i class="fa fa-question-circle text-info ml-1" data-toggle="tooltip"
                                           title="Realiza estas series antes de las principales para preparar los músculos"></i>
                                    </h6>
                                    <div class="warmup-sets"></div>
                                </div>
                                
                                <!-- Botón para generar series de calentamiento -->
                                <button class="btn btn-sm btn-outline-warning mt-2 generate-warmup">
                                    <i class="fa fa-fire mr-1"></i> Generar series de calentamiento
                                </button>
                                    
                                <!-- Contenedor para series de calentamiento antiguo (ya no necesario) -->
                                <div class="warmup-container mt-3" style="display: none;"></div>
                                {% endif %}
                                
                                <!-- Para ejercicios de TEST -->
                                {% if es_test %}
                                <div class="alert alert-warning">
                                    <i class="fa fa-info-circle mr-2"></i>Realiza UNA SOLA SERIE al fallo
                                </div>
                                <div class="test-fields" data-ejercicio="{{ nombre_ejercicio }}">
                                    <div class="form-group">
                                        <label>
                                            Repeticiones logradas:
                                            <i class="fa fa-question-circle tooltip-icon" data-toggle="tooltip" 
                                               title="Indica cuántas repeticiones pudiste realizar en tu serie al fallo"></i>
                                        </label>
                                        <select class="form-control form-control-sm test-reps">
                                            {% for i in range(1, 11) %}
                                            <option value="{{ i }}" {% if i == 5 %}selected{% endif %}>{{ i }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="form-group mt-1 incremento-peso-container" style="display: none;">
                                        <label>
                                            Incremento de peso (kg):
                                            <i class="fa fa-question-circle tooltip-icon" data-toggle="tooltip" 
                                               title="Si lograste 10 repeticiones, puedes incrementar el peso para el próximo ciclo"></i>
                                        </label>
                                        <select class="form-control form-control-sm test-peso-incremento">
                                            <option value="0" selected>Sin cambio</option>
                                            <option value="2.5">+2.5 kg</option>
                                            <option value="5">+5 kg</option>
                                            <option value="7.5">+7.5 kg</option>
                                            <option value="10">+10 kg</option>
                                        </select>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Checkbox para marcar ejercicio como completado -->
                                <div class="form-check mt-3">
                                    <input class="form-check-input ejercicio-checkbox" type="checkbox" 
                                           id="ejercicio-{{ loop.index }}" data-ejercicio="{{ ejercicio }}">
                                    <label class="form-check-label" for="ejercicio-{{ loop.index }}">
                                        Marcar ejercicio como completado
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-12">
                        <button id="avanzar-dia-btn" class="btn btn-lg btn-primary btn-block">
                            <i class="fa fa-check-circle mr-2"></i> Completar y Avanzar al Siguiente Día
                        </button>
                        <div class="text-center text-muted mt-2">
                            <small>
                                <i class="fa fa-info-circle mr-1"></i>
                                Al hacer clic en este botón, se registrará tu progreso y avanzarás al siguiente día de entrenamiento
                            </small>
                        </div>
                    </div>
                </div>
                </form>
            {% else %}
                <div class="alert alert-info">
                    <p>No tienes un entrenamiento programado para hoy. Asegúrate de tener un plan de entrenamiento activo.</p>
                    <a href="/trainingplanner" class="btn btn-info">Ir al Planificador</a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Incluir el script JS personalizado para el entrenamiento -->
<script src="{{ url_for('static', filename='assets/js/training.js') }}"></script>

<!-- Script para debugging -->
<script>
    // Mostrar un indicador de que la página ha cargado correctamente
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Página de entrenamiento cargada correctamente');
        console.log('Datos de ejercicios:', ejerciciosData);
    });
</script>
{% endblock %}
