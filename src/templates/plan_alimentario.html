{% extends "base/base.html" %}

{% block title %}Plan Alimentario{% endblock %}

{% block herotitle %}Plan Alimentario{% endblock %}
{% block herosubtitle %}Personaliza tu alimentaci√≥n con {{ (paciente_seleccionado or username) }}{% endblock %}

{% block contenttitle %}Plan Alimentario Personalizado{% endblock %}
{% block contentsubtitle %}Selecciona tu tipo de plan preferido y configura tus comidas{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Bot√≥n de regreso -->
    <div class="row mb-4">
        <div class="col-12">
            <a href="/dashboard" class="btn btn-outline-primary">
                <i class="fa fa-arrow-left me-2"></i>Volver al Dashboard
            </a>
        </div>
    </div>

    {% if is_admin %}
    <!-- Selector de Pacientes (Solo Administrador) -->
    <div class="block block-rounded mb-3 bg-primary-light">
        <div class="block-content py-3">
            <div class="row align-items-center">
                <div class="col-md-1 text-center">
                    <i class="fa fa-user-shield fa-2x text-primary"></i>
                </div>
                <div class="col-md-5">
                    <label class="mb-1 font-w600 text-primary">üëë Administrador - Ver plan alimentario de paciente:</label>
                    <select class="form-control form-control-lg" id="selector_paciente_plan" onchange="cambiarPacientePlan()">
                        {% for paciente in lista_pacientes %}
                        <option value="{{ paciente }}" {% if paciente == (paciente_seleccionado or username) %}selected{% endif %}>{{ paciente }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-info mb-0">
                        <i class="fa fa-info-circle mr-2"></i>
                        <strong>Modo Admin:</strong> Viendo plan de <strong>{{ paciente_seleccionado or username }}</strong>
                        <br>
                        <small>Edici√≥n deshabilitada al visualizar otro paciente.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
    function cambiarPacientePlan() {
        const paciente = document.getElementById('selector_paciente_plan').value;
        window.location.href = `/plan-alimentario?paciente=${encodeURIComponent(paciente)}`;
    }
    </script>
    {% endif %}

    <script>
    // Contexto admin/paciente para construir URLs de API
    const ES_ADMIN = {{ 'true' if is_admin else 'false' }};
    const PACIENTE_SELECCIONADO = '{{ (paciente_seleccionado or username) | replace("'", "\'") }}';
    const USUARIO_ACTUAL = '{{ username | replace("'", "\'") }}';
    function apiUrl(path) {
        // Propaga ?paciente= si el admin est√° viendo otro paciente
        const viendoOtro = ES_ADMIN && PACIENTE_SELECCIONADO && (PACIENTE_SELECCIONADO !== USUARIO_ACTUAL);
        if (viendoOtro) {
            const sep = path.indexOf('?') >= 0 ? '&' : '?';
            return `${path}${sep}paciente=${encodeURIComponent(PACIENTE_SELECCIONADO)}`;
        }
        return path;
    }
    // Deshabilitar acciones de edici√≥n si el admin ve a otro paciente
    document.addEventListener('DOMContentLoaded', function() {
        const viendoOtro = ES_ADMIN && PACIENTE_SELECCIONADO && (PACIENTE_SELECCIONADO !== USUARIO_ACTUAL);
        if (viendoOtro) {
            const btnMod = document.getElementById('modificar-plan-btn');
            if (btnMod) { btnMod.disabled = true; btnMod.title = 'Solo se puede editar el propio plan'; }
            const btnGuardar = document.getElementById('guardar-plan-recetas');
            if (btnGuardar) { btnGuardar.disabled = true; btnGuardar.title = 'Solo se puede editar el propio plan'; }
            const btnLista = document.getElementById('generar-lista-compras-guardado');
            if (btnLista) { btnLista.disabled = true; btnLista.title = 'Disponible solo para el usuario due√±o del plan'; }
        }
    });
    </script>

    <!-- Selector de tipo de plan -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-gradient-primary text-white py-3">
                    <h4 class="card-title mb-0">
                        <i class="fa fa-cog me-2"></i>Tipo de Plan Alimentario
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card h-100 plan-selector" data-plan="recetas">
                                <div class="card-body text-center">
                                    <i class="fa fa-utensils fa-3x text-primary mb-3"></i>
                                    <h5 class="text-primary">Plan con Recetas</h5>
                                    <p class="text-muted">Selecciona recetas espec√≠ficas para cada comida del d√≠a</p>
                                    <ul class="list-unstyled text-start mt-3">
                                        <li><i class="fa fa-check text-success me-2"></i>Recetas personalizadas</li>
                                        <li><i class="fa fa-check text-success me-2"></i>C√°lculos precisos de porciones</li>
                                        <li><i class="fa fa-check text-success me-2"></i>Lista de compras detallada</li>
                                    </ul>
                                    <button class="btn btn-primary btn-selector mt-3">Usar Recetas</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 plan-selector" data-plan="simplificado">
                                <div class="card-body text-center">
                                    <i class="fa fa-layer-group fa-3x text-success mb-3"></i>
                                    <h5 class="text-success">Plan Simplificado</h5>
                                    <p class="text-muted">Usa grupos de alimentos para planes m√°s flexibles</p>
                                    <ul class="list-unstyled text-start mt-3">
                                        <li><i class="fa fa-check text-success me-2"></i>Grupos alimentarios</li>
                                        <li><i class="fa fa-check text-success me-2"></i>Mayor flexibilidad</li>
                                        <li><i class="fa fa-check text-success me-2"></i>M√°s f√°cil de seguir</li>
                                    </ul>
                                    <button class="btn btn-success btn-selector mt-3">Usar Simplificado</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de Plan Guardado (se muestra primero si existe) -->
    <div id="panel-plan-guardado" class="plan-panel" style="display: none;">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm border-success">
                    <div class="card-header bg-gradient-success text-white py-3">
                        <h4 class="card-title mb-0">
                            <i class="fa fa-check-circle me-2"></i>Tu Plan Alimentario Activo
                        </h4>
                    </div>
                    <div class="card-body">
                        <div id="plan-guardado-content">
                            <!-- Se llenar√° con el plan calculado -->
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <button class="btn btn-warning btn-block" id="modificar-plan-btn">
                                    <i class="fa fa-edit me-2"></i>Modificar Plan
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-info btn-block" id="generar-lista-compras-guardado">
                                    <i class="fa fa-shopping-cart me-2"></i>Generar Lista de Compras
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de Plan con Recetas (para crear/modificar) -->
    <div id="panel-recetas" class="plan-panel" style="display: none;">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-gradient-primary text-white py-3 d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">
                            <i class="fa fa-utensils me-2"></i>Crear/Modificar Plan con Recetas
                        </h4>
                        <button class="btn btn-sm btn-light" id="cancelar-modificacion-btn" style="display: none;">
                            <i class="fa fa-times me-2"></i>Cancelar
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Informaci√≥n del plan nutricional -->
                        <div class="alert alert-info" id="plan-info">
                            <h6><i class="fa fa-info-circle me-2"></i>Informaci√≥n del Plan</h6>
                            <div id="plan-details">
                                <p class="mb-0">Cargando informaci√≥n del plan nutricional...</p>
                            </div>
                        </div>

                        <!-- Comidas del d√≠a -->
                        <div class="row" id="comidas-container">
                            <!-- Se llenar√° din√°micamente -->
                        </div>

                        <!-- Botones de acci√≥n -->
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <button class="btn btn-success btn-block" id="guardar-plan-recetas">
                                    <i class="fa fa-save me-2"></i>Guardar Plan
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-info btn-block" id="generar-lista-compras">
                                    <i class="fa fa-shopping-cart me-2"></i>Generar Lista de Compras
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de Plan Simplificado con Bloques -->
    <div id="panel-simplificado" class="plan-panel" style="display: none;">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-gradient-success text-white py-3">
                        <h4 class="card-title mb-0">
                            <i class="fa fa-cubes me-2"></i>Plan Simplificado con Bloques
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Selector de Nivel de Complejidad -->
                        <div class="card mb-4 border-2">
                            <div class="card-body">
                                <h6 class="mb-3"><i class="fa fa-sliders-h me-2"></i>Nivel de Complejidad</h6>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="complexityMode" id="modeCompleto" value="completo" checked>
                                    <label class="btn btn-outline-primary" for="modeCompleto">
                                        <i class="fa fa-list me-1"></i>Completo<br><small class="text-muted">(P¬∑G¬∑C)</small>
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="complexityMode" id="modeProteina" value="proteina">
                                    <label class="btn btn-outline-success" for="modeProteina">
                                        <i class="fa fa-drumstick-bite me-1"></i>Prote√≠na<br><small class="text-muted">(P+E)</small>
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="complexityMode" id="modeCalorias" value="calorias">
                                    <label class="btn btn-outline-warning" for="modeCalorias">
                                        <i class="fa fa-fire me-1"></i>Calor√≠as<br><small class="text-muted">(E)</small>
                                    </label>
                                </div>
                                <small class="text-muted d-block mt-2 text-center">
                                    <strong>E = Energ√≠a:</strong> 1E = 100 kcal | Elige el nivel que mejor se adapte a tus necesidades
                                </small>
                            </div>
                        </div>
                        
                        <!-- Informaci√≥n del sistema de bloques -->
                        <div class="alert alert-info mb-4" id="bloquesInfo">
                            <h6><i class="fa fa-info-circle me-2"></i>Sistema de Bloques Nutricionales</h6>
                            <p class="mb-2" id="bloquesDescripcion">Memoriza tu plan usando bloques simples en lugar de gramos espec√≠ficos:</p>
                            <div class="row text-center mt-3" id="bloquesBadges">
                                <div class="col-md-3" id="badgeProteina">
                                    <div class="badge bg-danger fs-6 p-2 w-100">1P = 20g Prote√≠na</div>
                                </div>
                                <div class="col-md-3" id="badgeGrasa">
                                    <div class="badge bg-warning fs-6 p-2 w-100">1G = 10g Grasa</div>
                                </div>
                                <div class="col-md-3" id="badgeCarbohidratos">
                                    <div class="badge bg-primary fs-6 p-2 w-100">1C = 25g Carbohidratos</div>
                                </div>
                                <div class="col-md-3" id="badgeEnergia">
                                    <div class="badge bg-success fs-6 p-2 w-100">1E = 100 kcal</div>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#tablaReferenciaBloques" aria-expanded="false">
                                    <i class="fa fa-table me-1"></i>Ver Tabla de Referencia de Alimentos
                                </button>
                            </div>
                        </div>

                        <!-- Tabla de Referencia de Bloques (Colapsable) -->
                        <div class="collapse mb-4" id="tablaReferenciaBloques">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0"><i class="fa fa-book me-2"></i>Tabla de Referencia: Bloques por Grupo Alimentario</h6>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-light active" data-filter="all">
                                                Todos
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-light" data-filter="P">
                                                <i class="fa fa-drumstick-bite"></i> P
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-light" data-filter="G">
                                                <i class="fa fa-cheese"></i> G
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-light" data-filter="C">
                                                <i class="fa fa-bread-slice"></i> C
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover table-sm mb-0" id="foodBlocksTable">
                                            <thead class="table-light sticky-top">
                                                <tr>
                                                    <th>Grupo Alimentario</th>
                                                    <th>Porci√≥n de Referencia</th>
                                                    <th class="text-center text-danger">P</th>
                                                    <th class="text-center text-warning">G</th>
                                                    <th class="text-center text-primary">C</th>
                                                    <th class="text-center">Momento</th>
                                                </tr>
                                            </thead>
                                            <tbody id="foodBlocksTableBody">
                                                <!-- Se llenar√° din√°micamente -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="card-footer bg-light small text-muted">
                                    <i class="fa fa-lightbulb me-1"></i>
                                    <strong>Tip:</strong> Usa esta tabla para armar tus comidas mentalmente. 
                                    Ejemplo: Desayuno de 2P¬∑1G¬∑1C = Huevo (0.5P¬∑0.5G) √ó 2 + Leche (0.5P¬∑0.5C)
                                    <span class="ms-3"><i class="fa fa-info-circle"></i> Bloques redondeados a pasos de 0.5</span>
                                </div>
                            </div>
                        </div>

                        <!-- Bloques por comida -->
                        <div id="bloques-comidas-container" class="row">
                            <!-- Se llenar√° din√°micamente con JavaScript -->
                        </div>

                        <!-- Widget de ajustes r√°pidos -->
                        <div class="card bg-light mt-4" id="ajustes-rapidos-card">
                            <div class="card-body">
                                <h6 class="mb-3"><i class="fa fa-sliders-h me-2"></i>Ajustes R√°pidos</h6>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Comida</label>
                                        <select class="form-select" id="ajuste-comida-select">
                                            <option value="">Selecciona una comida...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-8 mb-3">
                                        <label class="form-label">Ajuste</label>
                                        <div class="btn-group w-100" role="group">
                                            <button type="button" class="btn btn-outline-danger" data-ajuste="proteina" data-valor="-1">
                                                -1P
                                            </button>
                                            <button type="button" class="btn btn-outline-danger" data-ajuste="proteina" data-valor="+1">
                                                +1P
                                            </button>
                                            <button type="button" class="btn btn-outline-warning" data-ajuste="grasa" data-valor="-1">
                                                -1G
                                            </button>
                                            <button type="button" class="btn btn-outline-warning" data-ajuste="grasa" data-valor="+1">
                                                +1G
                                            </button>
                                            <button type="button" class="btn btn-outline-primary" data-ajuste="carbohidratos" data-valor="-1">
                                                -1C
                                            </button>
                                            <button type="button" class="btn btn-outline-primary" data-ajuste="carbohidratos" data-valor="+1">
                                                +1C
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div id="ajuste-resultado" class="alert alert-success" style="display: none;">
                                    <!-- Se mostrar√° el resultado del ajuste -->
                                </div>
                            </div>
                        </div>

                        <!-- Carrusel de Sugerencias -->
                        <div class="card bg-light mt-4" id="sugerencias-container" style="display: none;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0"><i class="fa fa-magic me-2"></i>Sugerencias para Ti</h6>
                                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalConstructor">
                                        <i class="fa fa-tools me-1"></i>Constructor
                                    </button>
                                </div>
                                
                                <!-- Tabs para categor√≠as de sugerencias -->
                                <ul class="nav nav-pills mb-3" id="sugerencias-tabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="favoritos-tab" data-bs-toggle="pill" 
                                                data-bs-target="#favoritos-content" type="button">
                                            <i class="fa fa-star text-warning"></i> Favoritos
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="dinamicas-tab" data-bs-toggle="pill" 
                                                data-bs-target="#dinamicas-content" type="button">
                                            <i class="fa fa-lightbulb text-info"></i> Inteligentes
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="biblioteca-tab" data-bs-toggle="pill" 
                                                data-bs-target="#biblioteca-content" type="button">
                                            <i class="fa fa-book text-primary"></i> Biblioteca
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="recientes-tab" data-bs-toggle="pill" 
                                                data-bs-target="#recientes-content" type="button">
                                            <i class="fa fa-history text-secondary"></i> Recientes
                                        </button>
                                    </li>
                                </ul>

                                <!-- Contenido de tabs -->
                                <div class="tab-content" id="sugerencias-tab-content">
                                    <!-- Favoritos -->
                                    <div class="tab-pane fade show active" id="favoritos-content">
                                        <div class="row" id="sugerencias-favoritos-list">
                                            <div class="col-12 text-center text-muted py-4">
                                                <i class="fa fa-star fa-3x mb-2"></i>
                                                <p>A√∫n no tienes favoritos guardados</p>
                                                <small>Aplica una sugerencia y m√°rcala como favorita para verla aqu√≠</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Sugerencias Din√°micas -->
                                    <div class="tab-pane fade" id="dinamicas-content">
                                        <div class="row" id="sugerencias-dinamicas-list">
                                            <div class="col-12 text-center text-muted py-4">
                                                <i class="fa fa-spinner fa-spin fa-2x"></i>
                                                <p>Cargando sugerencias...</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Biblioteca Comunitaria -->
                                    <div class="tab-pane fade" id="biblioteca-content">
                                        <div class="row" id="biblioteca-list">
                                            <div class="col-12 text-center text-muted py-4">
                                                <i class="fa fa-spinner fa-spin fa-2x"></i>
                                                <p>Cargando recomendaciones...</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Ajustes Recientes -->
                                    <div class="tab-pane fade" id="recientes-content">
                                        <div class="row" id="sugerencias-recientes-list">
                                            <div class="col-12 text-center text-muted py-4">
                                                <i class="fa fa-clock fa-3x mb-2"></i>
                                                <p>No hay ajustes recientes</p>
                                                <small>Tus √∫ltimos ajustes aparecer√°n aqu√≠</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notas para el paciente -->
                        <div class="alert alert-light mt-4">
                            <h6><i class="fa fa-lightbulb me-2"></i>C√≥mo usar este sistema</h6>
                            <ul class="mb-0">
                                <li><strong>Memoriza tu patr√≥n:</strong> "Desayuno siempre 2P ¬∑ 1G ¬∑ 2C"</li>
                                <li><strong>Ejemplos de alimentos:</strong> 1P = 1 pechuga mediana, 1 lata de at√∫n, 4 claras...</li>
                                <li><strong>Ajustes simples:</strong> Si necesitas m√°s energ√≠a, suma "+1C en merienda"</li>
                                <li><strong>Flexibilidad:</strong> Intercambia alimentos del mismo grupo manteniendo los bloques</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de Lista de Compras -->
    <div id="panel-lista-compras" class="card border-0 shadow-sm" style="display: none;">
        <div class="card-header bg-gradient-info text-white py-3">
            <h4 class="card-title mb-0">
                <i class="fa fa-shopping-cart me-2"></i>Lista de Compras Generada
            </h4>
        </div>
        <div class="card-body">
            <div id="lista-compras-content">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>
    </div>
</div>

<!-- Modal Constructor de Combinaciones -->
<div class="modal fade" id="modalConstructor" tabindex="-1" aria-labelledby="modalConstructorLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalConstructorLabel">
                    <i class="fa fa-tools me-2"></i>Constructor de Combinaciones
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body">
                <!-- Selector de comida -->
                <div class="mb-3">
                    <label for="constructorComida" class="form-label fw-bold">Comida del d√≠a</label>
                    <select class="form-select" id="constructorComida">
                        <option value="">Seleccionar comida...</option>
                        <option value="desayuno">Desayuno</option>
                        <option value="media_manana">Media Ma√±ana</option>
                        <option value="almuerzo">Almuerzo</option>
                        <option value="merienda">Merienda</option>
                        <option value="media_tarde">Media Tarde</option>
                        <option value="cena">Cena</option>
                    </select>
                </div>
                
                <!-- Panel de objetivo -->
                <div class="card mb-3 border-info">
                    <div class="card-body bg-light">
                        <h6 class="card-title"><i class="fa fa-bullseye me-2"></i>Objetivo de la comida</h6>
                        <div class="row text-center" id="objetivoPanel">
                            <div class="col-4">
                                <div class="badge bg-danger fs-6 w-100 mb-1"><span id="objProteina">0.0</span>P</div>
                                <small class="text-muted"><span id="objProteinaGramos">0</span>g</small>
                            </div>
                            <div class="col-4">
                                <div class="badge bg-warning fs-6 w-100 mb-1"><span id="objGrasa">0.0</span>G</div>
                                <small class="text-muted"><span id="objGrasaGramos">0</span>g</small>
                            </div>
                            <div class="col-4">
                                <div class="badge bg-primary fs-6 w-100 mb-1"><span id="objCarbohidratos">0.0</span>C</div>
                                <small class="text-muted"><span id="objCarbohidratosGramos">0</span>g</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Panel de bloques acumulados -->
                <div class="card mb-3 border-2" id="panelAcumulado">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fa fa-calculator me-2"></i>Bloques Acumulados</h6>
                        <div class="row text-center mb-3">
                            <div class="col-4">
                                <h4 class="mb-0 text-danger"><span id="acumProteina">0.0</span>P</h4>
                                <div class="small" id="difProteina">Selecciona comida</div>
                            </div>
                            <div class="col-4">
                                <h4 class="mb-0 text-warning"><span id="acumGrasa">0.0</span>G</h4>
                                <div class="small" id="difGrasa">Selecciona comida</div>
                            </div>
                            <div class="col-4">
                                <h4 class="mb-0 text-primary"><span id="acumCarbohidratos">0.0</span>C</h4>
                                <div class="small" id="difCarbohidratos">Selecciona comida</div>
                            </div>
                        </div>
                        
                        <!-- Bot√≥n de sugerencia inteligente -->
                        <div class="text-center" id="sugerenciaInteligentePanel" style="display: none;">
                            <button class="btn btn-sm btn-info" onclick="completarConCarbohidratos()">
                                <i class="fa fa-magic me-1"></i>Completar con Carbohidratos
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Selector de alimentos -->
                <div class="mb-3">
                    <label class="form-label fw-bold"><i class="fa fa-plus-circle me-2"></i>Agregar alimento</label>
                    <div class="row g-2 mb-2">
                        <div class="col-md-4">
                            <select class="form-select form-select-sm" id="filtroMacro">
                                <option value="">Todos los macros</option>
                                <option value="P">Rico en Prote√≠na</option>
                                <option value="G">Rico en Grasa</option>
                                <option value="C">Rico en Carbohidratos</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select form-select-sm" id="selectAlimento">
                                <option value="">Primero selecciona comida...</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control form-control-sm" id="porciones" 
                                   min="1" max="5" value="1" placeholder="Porc.">
                        </div>
                    </div>
                    <button class="btn btn-success btn-sm w-100" onclick="agregarAlimentoConstructor()">
                        <i class="fa fa-plus me-1"></i>Agregar
                    </button>
                </div>
                
                <!-- Lista de alimentos agregados -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <strong><i class="fa fa-list me-2"></i>Alimentos en tu combinaci√≥n</strong>
                    </div>
                    <div class="list-group list-group-flush" id="listaAlimentosConstructor">
                        <div class="list-group-item text-muted text-center">
                            A√∫n no has agregado alimentos
                        </div>
                    </div>
                </div>
                
                <!-- Nombre de la combinaci√≥n -->
                <div class="mb-3">
                    <label for="aliasConstructor" class="form-label fw-bold">
                        <i class="fa fa-tag me-2"></i>Nombre de tu combinaci√≥n
                    </label>
                    <input type="text" class="form-control" id="aliasConstructor" 
                           placeholder="Ej: Mi Desayuno Proteico">
                </div>
                
                <!-- Opciones de guardado -->
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="enviarRevision">
                    <label class="form-check-label" for="enviarRevision">
                        <i class="fa fa-paper-plane me-1"></i>Enviar a nutricionista para revisi√≥n
                    </label>
                </div>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="publicarBiblioteca">
                    <label class="form-check-label" for="publicarBiblioteca">
                        <i class="fa fa-book me-1"></i>üìö Publicar en biblioteca comunitaria
                    </label>
                    <small class="form-text text-muted d-block ms-4">
                        Otros usuarios podr√°n ver y usar esta combinaci√≥n
                    </small>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fa fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="guardarCombinacionConstructor()">
                    <i class="fa fa-save me-1"></i>Guardar Combinaci√≥n
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Ocultar widget de ajustes r√°pidos */
#ajustes-rapidos-card {
    display: none !important;
}

.alert {
    border-radius: 10px;
}

.card {
    border-radius: 15px;
    overflow: hidden;
}

.card-header {
    border-radius: 15px 15px 0 0 !important;
}

.plan-selector {
    cursor: pointer;
    transition: all 0.3s ease;
}

.plan-selector:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.plan-selector.selected {
    border-color: var(--primary);
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.comida-card {
    border-left: 4px solid;
    overflow: visible !important;
}

.comida-card .card-body {
    overflow: visible !important;
}

.bg-light.rounded {
    overflow: visible !important;
}

.comida-desayuno { border-left-color: #ff6b6b; }
.comida-media-manana { border-left-color: #4ecdc4; }
.comida-almuerzo { border-left-color: #45b7d1; }
.comida-merienda { border-left-color: #f7b731; }
.comida-media-tarde { border-left-color: #5f27cd; }
.comida-cena { border-left-color: #00d2d3; }

.recipe-selector {
    max-height: 200px;
    overflow-y: auto;
}

/* Barra de calidad segmentada */
.quality-bar {
    display: flex;
    gap: 2px;
    height: 20px;
    background: #f0f0f0;
    border-radius: 10px;
    padding: 2px;
    overflow: hidden;
}

.quality-segment {
    flex: 1;
    border-radius: 3px;
    transition: all 0.3s ease;
    background: #e0e0e0;
}

.quality-segment.active {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Colores graduales para los segmentos */
.quality-segment.active.q-1, .quality-segment.active.q-2 { background: #ff4444; } /* Rojo */
.quality-segment.active.q-3, .quality-segment.active.q-4 { background: #ff8800; } /* Naranja */
.quality-segment.active.q-5, .quality-segment.active.q-6 { background: #ffbb00; } /* Amarillo */
.quality-segment.active.q-7, .quality-segment.active.q-8 { background: #88cc00; } /* Verde claro */
.quality-segment.active.q-9, .quality-segment.active.q-10 { background: #00cc44; } /* Verde */

/* Badges de m√©todos */
.badge-metodo {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: help;
    transition: all 0.2s ease;
}

.badge-metodo:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.badge-metodo-completo {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.badge-metodo-proteinas {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

.badge-metodo-calorias {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
}

/* Tooltip personalizado */
.info-tooltip {
    position: relative;
    display: inline-block;
    cursor: help;
}

.info-tooltip .tooltiptext {
    visibility: hidden;
    width: 300px;
    max-width: 90vw;
    background-color: #333;
    color: #fff;
    text-align: left;
    border-radius: 8px;
    padding: 10px 12px;
    position: absolute;
    z-index: 10000;
    top: calc(100% + 10px);
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    transition: opacity 0.3s, visibility 0.3s;
    font-size: 0.85rem;
    line-height: 1.4;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    white-space: normal;
}

.info-tooltip .tooltiptext::after {
    content: "";
    position: absolute;
    bottom: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: transparent transparent #333 transparent;
}

.info-tooltip:hover .tooltiptext {
    visibility: visible;
    opacity: 1;
}

/* Headers personalizados con gradiente */
.bg-gradient-primary,
.bg-gradient-success {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
}

.bg-gradient-primary h4,
.bg-gradient-primary .card-title,
.bg-gradient-success h4,
.bg-gradient-success .card-title {
    color: white !important;
    font-weight: 600;
}

.card-header.bg-gradient-primary,
.card-header.bg-gradient-success {
    border-bottom: 3px solid rgba(255, 255, 255, 0.2);
}
</style>

<script>
// Variable global para almacenar bloques
let allFoodBlocks = [];
let currentFilter = 'all';

// Funci√≥n para cargar bloques desde GRUPOSALIMENTOS (datos reales)
async function loadFoodBlocks() {
    try {
        const res = await fetch('/api/grupos-alimentos');
        const data = await res.json();
        
        if (!data.success || !data.alimentos) {
            console.error('Error cargando grupos de alimentos');
            return [];
        }
        
        // Mapear emojis para momentos del d√≠a
        const momentoEmojis = {
            'desayuno': 'üåÖ',
            'media_manana': '‚òï',
            'almuerzo': 'üçΩÔ∏è',
            'merienda': 'üßâ',
            'media_tarde': 'ü•ú',
            'cena': 'üåô'
        };
        
        const momentoNombres = {
            'desayuno': 'Desayuno',
            'media_manana': 'Media Ma√±ana',
            'almuerzo': 'Almuerzo',
            'merienda': 'Merienda',
            'media_tarde': 'Media Tarde',
            'cena': 'Cena'
        };
        
        return data.alimentos.map(a => ({
            group: a.categoria,
            portion: `${a.descripcion} (${Math.round(a.porcion_gramos)}g)`,
            blocks: {
                P: a.bloques_unitarios.proteina,  // Ya vienen redondeados a 0.5 del backend
                G: a.bloques_unitarios.grasa,
                C: a.bloques_unitarios.carbohidratos
            },
            blocks_exact: a.bloques_exactos ? {  // Valores exactos para tooltips
                P: a.bloques_exactos.proteina,
                G: a.bloques_exactos.grasa,
                C: a.bloques_exactos.carbohidratos
            } : null,
            momento: a.momentos.length 
                ? a.momentos.map(m => `${momentoEmojis[m] || ''} ${momentoNombres[m] || m}`).join(', ')
                : '‚Äî',
            macro_dominante: a.macro_dominante,
            macros_fuertes: a.macros_fuertes || [a.macro_dominante]
        }));
    } catch (error) {
        console.error('Error al cargar bloques de alimentos:', error);
        return [];
    }
}

// Funci√≥n para filtrar bloques por macro
function filterFoodBlocks(filter) {
    currentFilter = filter;
    
    let filtered = allFoodBlocks;
    if (filter !== 'all') {
        filtered = allFoodBlocks.filter(item => item.macros_fuertes.includes(filter));
    }
    
    renderFoodBlocksTable(filtered);
    
    // Actualizar botones activos
    document.querySelectorAll('[data-filter]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
    });
}

// Funci√≥n para actualizar header de tabla seg√∫n modo
function actualizarHeaderTabla() {
    const thead = document.querySelector('#foodBlocksTable thead tr');
    if (!thead) return;
    
    const mode = window.complexityMode || 'completo';
    
    if (mode === 'completo') {
        thead.innerHTML = `
            <th>Grupo Alimentario</th>
            <th>Porci√≥n de Referencia</th>
            <th class="text-center text-danger">P</th>
            <th class="text-center text-warning">G</th>
            <th class="text-center text-primary">C</th>
            <th class="text-center">Momento</th>
        `;
    } else if (mode === 'proteina') {
        thead.innerHTML = `
            <th>Grupo Alimentario</th>
            <th>Porci√≥n de Referencia</th>
            <th class="text-center text-danger">P</th>
            <th class="text-center text-success">E<small>(G+C)</small></th>
            <th class="text-center">Momento</th>
        `;
    } else {
        thead.innerHTML = `
            <th>Grupo Alimentario</th>
            <th>Porci√≥n de Referencia</th>
            <th class="text-center text-success">E<small>(Total)</small></th>
            <th class="text-center">Momento</th>
        `;
    }
}

// Funci√≥n para renderizar la tabla de bloques
function renderFoodBlocksTable(foodBlocks) {
    const tbody = document.getElementById('foodBlocksTableBody');
    if (!tbody) return;
    
    const mode = window.complexityMode || 'completo';
    const colspan = mode === 'completo' ? 6 : mode === 'proteina' ? 5 : 4;
    
    if (foodBlocks.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="${colspan}" class="text-center text-muted py-4">
                    <i class="fa fa-info-circle me-2"></i>
                    ${currentFilter === 'all' 
                        ? 'No se pudieron cargar los alimentos. Intenta recargar la p√°gina.' 
                        : `No hay alimentos con macro dominante "${currentFilter}"`}
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = foodBlocks.map(item => {
        // Calcular bloques de energ√≠a si hay datos
        let bloqueE_total = 0, bloqueE_gc = 0;
        if (item.blocks_exact) {
            const kcalTotal = (item.blocks_exact.P * 20 * 4) + (item.blocks_exact.G * 10 * 9) + (item.blocks_exact.C * 25 * 4);
            const kcalGC = (item.blocks_exact.G * 10 * 9) + (item.blocks_exact.C * 25 * 4);
            bloqueE_total = Math.round((kcalTotal / 100) * 2) / 2; // Redondear a 0.5
            bloqueE_gc = Math.round((kcalGC / 100) * 2) / 2;
        }
        
        // Crear tooltip con valores exactos si existen
        const tooltipP = item.blocks_exact 
            ? `title="Exacto: ${item.blocks_exact.P.toFixed(2)}" data-bs-toggle="tooltip"` 
            : '';
        const tooltipG = item.blocks_exact 
            ? `title="Exacto: ${item.blocks_exact.G.toFixed(2)}" data-bs-toggle="tooltip"` 
            : '';
        const tooltipC = item.blocks_exact 
            ? `title="Exacto: ${item.blocks_exact.C.toFixed(2)}" data-bs-toggle="tooltip"` 
            : '';
        const tooltipE = bloqueE_total > 0
            ? `title="Total: ${bloqueE_total.toFixed(1)}E" data-bs-toggle="tooltip"`
            : '';
        
        // Badge de macro dominante
        const macroBadge = {
            'P': '<span class="badge bg-danger badge-sm ms-2">P</span>',
            'G': '<span class="badge bg-warning badge-sm ms-2">G</span>',
            'C': '<span class="badge bg-primary badge-sm ms-2">C</span>'
        }[item.macro_dominante] || '';
        
        // Construir columnas seg√∫n modo
        let columnasNutricionales = '';
        if (mode === 'completo') {
            // Modo completo: P, G, C
            columnasNutricionales = `
                <td class="text-center">
                    <span class="badge ${item.blocks.P > 0 ? 'bg-danger' : 'bg-secondary'}" ${tooltipP}>
                        ${item.blocks.P > 0 ? item.blocks.P : '-'}
                    </span>
                </td>
                <td class="text-center">
                    <span class="badge ${item.blocks.G > 0 ? 'bg-warning text-dark' : 'bg-secondary'}" ${tooltipG}>
                        ${item.blocks.G > 0 ? item.blocks.G : '-'}
                    </span>
                </td>
                <td class="text-center">
                    <span class="badge ${item.blocks.C > 0 ? 'bg-primary' : 'bg-secondary'}" ${tooltipC}>
                        ${item.blocks.C > 0 ? item.blocks.C : '-'}
                    </span>
                </td>
            `;
        } else if (mode === 'proteina') {
            // Modo prote√≠na: P y E_gc
            columnasNutricionales = `
                <td class="text-center">
                    <span class="badge ${item.blocks.P > 0 ? 'bg-danger' : 'bg-secondary'}" ${tooltipP}>
                        ${item.blocks.P > 0 ? item.blocks.P : '-'}
                    </span>
                </td>
                <td class="text-center">
                    <span class="badge ${bloqueE_gc > 0 ? 'bg-success' : 'bg-secondary'}" ${tooltipE}>
                        ${bloqueE_gc > 0 ? bloqueE_gc.toFixed(1) : '-'}
                    </span>
                </td>
            `;
        } else {
            // Modo calor√≠as: solo E_total
            columnasNutricionales = `
                <td class="text-center">
                    <span class="badge ${bloqueE_total > 0 ? 'bg-success' : 'bg-secondary'}" ${tooltipE}>
                        ${bloqueE_total > 0 ? bloqueE_total.toFixed(1) : '-'}
                    </span>
                </td>
            `;
        }
        
        return `
            <tr>
                <td><strong>${item.group}</strong>${macroBadge}</td>
                <td class="text-muted small">${item.portion}</td>
                ${columnasNutricionales}
                <td class="text-center small text-muted">${item.momento}</td>
            </tr>
        `;
    }).join('');
    
    // Inicializar tooltips de Bootstrap
    if (typeof bootstrap !== 'undefined') {
        const tooltipTriggerList = tbody.querySelectorAll('[data-bs-toggle="tooltip"]');
        [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));
    }
}

function actualizarVistaPorModo() {
    const mode = window.complexityMode || 'completo';
    
    console.log('=== actualizarVistaPorModo ===');
    console.log('Modo actual:', mode);
    console.log('window.planData:', window.planData);
    console.log('window.sugerenciasData:', window.sugerenciasData);
    
    // Actualizar badges de informaci√≥n
    const badgeP = document.getElementById('badgeProteina');
    const badgeG = document.getElementById('badgeGrasa');
    const badgeC = document.getElementById('badgeCarbohidratos');
    const badgeE = document.getElementById('badgeEnergia');
    
    if (mode === 'completo') {
        // Mostrar P, G, C - Ocultar E
        if (badgeP) badgeP.style.display = 'block';
        if (badgeG) badgeG.style.display = 'block';
        if (badgeC) badgeC.style.display = 'block';
        if (badgeE) badgeE.style.display = 'none';
        
        // Actualizar descripci√≥n
        document.getElementById('bloquesDescripcion').textContent = 
            'Memoriza tu plan usando bloques simples de Prote√≠na, Grasa y Carbohidratos:';
            
    } else if (mode === 'proteina') {
        // Mostrar P y E - Ocultar G, C
        if (badgeP) badgeP.style.display = 'block';
        if (badgeG) badgeG.style.display = 'none';
        if (badgeC) badgeC.style.display = 'none';
        if (badgeE) badgeE.style.display = 'block';
        
        // Actualizar descripci√≥n
        document.getElementById('bloquesDescripcion').textContent = 
            'Controla tu prote√≠na y energ√≠a restante (grasas + carbohidratos):';
            
    } else if (mode === 'calorias') {
        // Solo mostrar E - Ocultar P, G, C
        if (badgeP) badgeP.style.display = 'none';
        if (badgeG) badgeG.style.display = 'none';
        if (badgeC) badgeC.style.display = 'none';
        if (badgeE) badgeE.style.display = 'block';
        
        // Actualizar descripci√≥n
        document.getElementById('bloquesDescripcion').textContent = 
            'Enfoque simplificado: solo controla tu energ√≠a total (calor√≠as):';
    }
    
    // Actualizar header y tabla de referencia
    actualizarHeaderTabla();
    renderFoodBlocksTable(allFoodBlocks);
    
    // Si hay datos de plan cargados, actualizarlos (verificar que funciones existan)
    console.log('Verificando si re-renderizar comidas...');
    console.log('window.planData existe:', !!window.planData);
    console.log('window.planData.comidas existe:', !!(window.planData && window.planData.comidas));
    console.log('mostrarBloquesComidas es funci√≥n:', typeof mostrarBloquesComidas === 'function');
    
    if (window.planData && window.planData.comidas && typeof mostrarBloquesComidas === 'function') {
        console.log('‚úì Re-renderizando comidas con modo:', mode);
        // Re-renderizar el panel de comidas con el nuevo modo
        mostrarBloquesComidas(window.planData.comidas, window.planData.bloquesConfig);
    } else {
        console.log('‚úó NO se puede re-renderizar comidas');
    }
    
    // Recargar sugerencias para actualizar formato (verificar que funciones existan)
    if (window.sugerenciasData) {
        // Re-renderizar cada tipo de sugerencia
        if (window.sugerenciasData.favoritos && typeof renderizarSugerenciasFavoritas === 'function') {
            renderizarSugerenciasFavoritas(window.sugerenciasData.favoritos);
        }
        if (window.sugerenciasData.dinamicas && typeof renderizarSugerenciasDinamicas === 'function') {
            renderizarSugerenciasDinamicas(window.sugerenciasData.dinamicas);
        }
        if (window.sugerenciasData.recientes && typeof renderizarSugerenciasRecientes === 'function') {
            renderizarSugerenciasRecientes(window.sugerenciasData.recientes);
        }
    }
}

document.addEventListener('DOMContentLoaded', async function() {
    // Variable global para modo de complejidad
    window.complexityMode = 'completo'; // completo | proteina | calorias
    
    // Cargar y renderizar tabla de bloques desde datos reales
    allFoodBlocks = await loadFoodBlocks();
    renderFoodBlocksTable(allFoodBlocks);
    
    // Event listeners para filtros de tabla de bloques
    document.querySelectorAll('[data-filter]').forEach(btn => {
        btn.addEventListener('click', function() {
            filterFoodBlocks(this.dataset.filter);
        });
    });
    
    // Event listeners para cambio de modo de complejidad
    document.querySelectorAll('input[name="complexityMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            window.complexityMode = this.value;
            actualizarVistaPorModo();
        });
    });
    
    // CARGAR PLAN GUARDADO AUTOM√ÅTICAMENTE AL INICIO
    verificarPlanGuardado();
    
    // Selectores de plan
    const planSelectors = document.querySelectorAll('.plan-selector');
    const planPanels = document.querySelectorAll('.plan-panel');
    
    // Variable global para almacenar el plan actual
    let planActualGuardado = null;
    
    // DELEGACI√ìN DE EVENTOS GLOBAL para botones de eliminar recetas
    // Esto maneja TODOS los botones, incluso los cargados din√°micamente
    document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-remove-recipe')) {
            e.preventDefault();
            e.stopPropagation();
            const btn = e.target.closest('.btn-remove-recipe');
            const recetaItem = btn.closest('.receta-item');
            if (recetaItem) {
                recetaItem.remove();
            }
        }
    });
    
    // Bot√≥n modificar plan
    document.getElementById('modificar-plan-btn').addEventListener('click', function() {
        document.getElementById('panel-plan-guardado').style.display = 'none';
        document.getElementById('panel-recetas').style.display = 'block';
        document.getElementById('cancelar-modificacion-btn').style.display = 'inline-block';
        document.querySelector('.row.mb-4').style.display = 'none'; // Ocultar selector de tipo
        
        // CARGAR PLAN ACTUAL PARA MODIFICAR
        cargarPlanParaModificar();
    });
    
    // Bot√≥n cancelar modificaci√≥n
    document.getElementById('cancelar-modificacion-btn').addEventListener('click', function() {
        document.getElementById('panel-recetas').style.display = 'none';
        document.getElementById('panel-plan-guardado').style.display = 'block';
        this.style.display = 'none';
        document.querySelector('.row.mb-4').style.display = 'block';
    });
    
    planSelectors.forEach(selector => {
        selector.addEventListener('click', function() {
            const planType = this.dataset.plan;
            
            // Remover selecci√≥n anterior
            planSelectors.forEach(s => s.classList.remove('selected'));
            planPanels.forEach(p => p.style.display = 'none');
            
            // Seleccionar nuevo plan
            this.classList.add('selected');
            document.getElementById(`panel-${planType}`).style.display = 'block';
            
            // Cargar datos espec√≠ficos del plan
            if (planType === 'recetas') {
                cargarPlanRecetas();
            } else if (planType === 'simplificado') {
                cargarPlanSimplificado();
            }
        });
    });
    
    // Funci√≥n para verificar si existe un plan guardado
    function verificarPlanGuardado() {
        fetch(apiUrl('/api/plan-alimentario/plan-guardado'))
            .then(response => response.json())
            .then(data => {
                if (data.success && data.recetas_calculadas) {
                    // GUARDAR PLAN COMPLETO para uso posterior
                    planActualGuardado = data;
                    
                    // HAY PLAN GUARDADO - Mostrarlo
                    mostrarPlanGuardadoCompleto(data.recetas_calculadas);
                    document.getElementById('panel-plan-guardado').style.display = 'block';
                    document.querySelector('.row.mb-4').style.display = 'none'; // Ocultar selector de tipo
                } else {
                    // NO HAY PLAN - Mostrar selector de tipo
                    planActualGuardado = null;
                    document.querySelector('.row.mb-4').style.display = 'block';
                }
            })
            .catch(error => {
                console.log('No hay plan guardado o error:', error);
                planActualGuardado = null;
                // Mostrar selector de tipo
                document.querySelector('.row.mb-4').style.display = 'block';
            });
    }
    
    // Funci√≥n para cargar el plan actual en modo edici√≥n
    function cargarPlanParaModificar() {
        // Primero cargar la estructura b√°sica
        fetch(apiUrl('/api/plan-alimentario/info'))
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarInfoPlan(data.plan);
                    mostrarComidasDisponibles(data.comidas);
                    cargarRecetasDisponibles();
                    
                    // Esperar un poco para que se carguen los selectores
                    setTimeout(() => {
                        precargarRecetasDelPlan();
                    }, 500);
                }
            })
            .catch(error => {
                console.error('Error cargando plan:', error);
            });
    }
    
    // Funci√≥n para precargar las recetas del plan guardado
    function precargarRecetasDelPlan() {
        if (!planActualGuardado || !planActualGuardado.recetas_calculadas) {
            return;
        }
        
        // Recorrer cada comida del plan guardado
        Object.keys(planActualGuardado.recetas_calculadas).forEach(comidaId => {
            const comida = planActualGuardado.recetas_calculadas[comidaId];
            
            if (comida.recetas && comida.recetas.length > 0) {
                // Para cada receta en esta comida
                comida.recetas.forEach(receta => {
                    // Agregar la receta a la interfaz
                    agregarRecetaAComida(comidaId, receta.id, receta.nombre);
                });
            }
        });
        
        // Mostrar mensaje informativo
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show';
        alert.innerHTML = `
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            <i class="fa fa-info-circle me-2"></i>
            <strong>Plan cargado:</strong> Puedes agregar o eliminar recetas seg√∫n necesites.
        `;
        document.getElementById('plan-info').insertAdjacentElement('afterend', alert);
        
        // Auto-cerrar despu√©s de 5 segundos
        setTimeout(() => {
            alert.remove();
        }, 5000);
    }
    
    function mostrarPlanGuardadoCompleto(recetasCalculadas) {
        const container = document.getElementById('plan-guardado-content');
        
        // Nota explicativa sobre c√≥mo leer las cantidades
        let html = `
            <div class="alert alert-info mb-4">
                <h6><i class="fa fa-info-circle me-2"></i>C√≥mo medir los alimentos</h6>
                <p class="mb-1 small">Cada alimento muestra dos formas de medirlo:</p>
                <ul class="mb-0 small">
                    <li><strong>Con b√°scula (recomendado):</strong> Peso en gramos en <strong>negrita</strong></li>
                    <li><strong>Sin b√°scula:</strong> Multiplicar las porciones por la medida casera <span class="text-muted">(entre par√©ntesis)</span></li>
                </ul>
                <p class="mb-0 mt-2 small"><strong>Ejemplo:</strong> "Avena: <strong>37.32g</strong> <span class="text-muted">(1.38 √ó 1/3 taza)</span>" significa pesar 37.32g O usar aproximadamente 1.38 veces un tercio de taza.</p>
            </div>
            <div class="row">
        `;
        
        // ORDENAR las comidas por el campo 'orden' o por orden predefinido
        const ordenComidas = ['desayuno', 'media_manana', 'almuerzo', 'merienda', 'media_tarde', 'cena'];
        const comidasOrdenadas = ordenComidas.filter(comidaId => recetasCalculadas[comidaId]);
        
        comidasOrdenadas.forEach(comidaId => {
            const comida = recetasCalculadas[comidaId];
            const config = getComidasConfig()[comidaId];
            
            html += `
                <div class="col-12 mb-4">
                    <div class="card comida-card ${config.class}">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fa ${config.icon} me-2"></i>${comida.nombre_comida}
                            </h5>
                            <small class="text-muted">
                                Objetivo: P: ${comida.macros_objetivo.proteina}g | G: ${comida.macros_objetivo.grasa}g | C: ${comida.macros_objetivo.carbohidratos}g
                            </small>
                        </div>
                        <div class="card-body">
            `;
            
            comida.recetas.forEach(receta => {
                html += `
                    <div class="mb-3 p-3 bg-light rounded">
                        <h6 class="text-primary"><i class="fa fa-utensils me-2"></i>${receta.nombre}</h6>
                `;
                
                if (receta.calculo && receta.calculo.status === 'success') {
                    html += `
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="row align-items-center">
                                    <div class="col-md-4">
                                        <p class="mb-1"><strong>M√©todo:</strong></p>
                                        ${generarBadgeMetodo(receta.calculo.metodo)}
                                    </div>
                                    <div class="col-md-4">
                                        <p class="mb-1"><strong>Calor√≠as:</strong></p>
                                        <span class="badge bg-info text-dark">${receta.calculo.calorias_totales} kcal</span>
                                    </div>
                                    <div class="col-md-4">
                                        ${receta.calculo.calidad ? `
                                            <p class="mb-1"><strong>Calidad:</strong></p>
                                            ${generarBarraCalidad(receta.calculo.calidad)}
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <p class="mb-2"><strong>Alimentos:</strong></p>
                                <ul class="list-unstyled mb-0">
                    `;
                    
                    if (receta.calculo.alimentos_variables) {
                        receta.calculo.alimentos_variables.forEach(alimento => {
                            // Formatear de forma m√°s clara: PESO primero, luego medida casera
                            const pesoInfo = `<strong>${alimento.total_gramos}g</strong>`;
                            // Redondear porciones al entero m√°s cercano para facilitar la medici√≥n
                            const porcionesRedondeadas = Math.round(alimento.porciones);
                            const medidaInfo = `<span class="text-muted">(‚âà${porcionesRedondeadas} √ó ${alimento.medida})</span>`;
                            html += `<li class="small mb-1">
                                <i class="fa fa-check text-success me-1"></i>
                                ${alimento.nombre}: ${pesoInfo} ${medidaInfo}
                            </li>`;
                        });
                    }
                    
                    if (receta.calculo.alimentos_fijos) {
                        receta.calculo.alimentos_fijos.forEach(alimento => {
                            const pesoInfo = `<strong>${alimento.total_gramos}g</strong>`;
                            // Redondear porciones al entero m√°s cercano para facilitar la medici√≥n
                            const porcionesRedondeadas = Math.round(alimento.porciones);
                            const medidaInfo = `<span class="text-muted">(‚âà${porcionesRedondeadas} √ó ${alimento.medida})</span>`;
                            html += `<li class="small mb-1">
                                <i class="fa fa-check text-success me-1"></i>
                                ${alimento.nombre}: ${pesoInfo} ${medidaInfo}
                            </li>`;
                        });
                    }
                    
                    html += `
                                </ul>
                            </div>
                        </div>
                    `;
                } else {
                    html += `<p class="text-danger">Error al calcular: ${receta.calculo ? receta.calculo.message : 'Desconocido'}</p>`;
                }
                
                html += `</div>`;
            });
            
            html += `
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
        
        // Inicializar tooltips de Bootstrap despu√©s de renderizar el HTML
        setTimeout(() => {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }, 100);
    }
    
    // ========== FUNCIONES DE UTILIDAD (DEBEN ESTAR PRIMERO) ==========
    
    function getComidasConfig() {
        return {
            'desayuno': { nombre: 'Desayuno', icon: 'fa-coffee', class: 'comida-desayuno' },
            'media_manana': { nombre: 'Media Ma√±ana', icon: 'fa-apple-alt', class: 'comida-media-manana' },
            'almuerzo': { nombre: 'Almuerzo', icon: 'fa-utensils', class: 'comida-almuerzo' },
            'merienda': { nombre: 'Merienda', icon: 'fa-cookie-bite', class: 'comida-merienda' },
            'media_tarde': { nombre: 'Media Tarde', icon: 'fa-tea', class: 'comida-media-tarde' },
            'cena': { nombre: 'Cena', icon: 'fa-moon', class: 'comida-cena' }
        };
    }
    
    // Funci√≥n para generar badge de m√©todo con Bootstrap tooltip
    function generarBadgeMetodo(metodo) {
        const metodos = {
            'Completo': {
                class: 'badge-metodo-completo',
                tooltip: 'M√©todo Completo: Se cumplen todas las restricciones de prote√≠nas, grasas y carbohidratos. Este es el resultado ideal.'
            },
            'Prote√≠nas': {
                class: 'badge-metodo-proteinas',
                tooltip: 'M√©todo Prote√≠nas: Se priorizan las prote√≠nas y calor√≠as totales cuando no es posible cumplir todas las restricciones.'
            },
            'Calor√≠as': {
                class: 'badge-metodo-calorias',
                tooltip: 'M√©todo Calor√≠as: Se optimiza para alcanzar las calor√≠as objetivo cuando las restricciones de macros son muy estrictas.'
            }
        };
        
        const config = metodos[metodo] || { class: 'badge-secondary', tooltip: metodo };
        
        return `<span class="badge-metodo ${config.class}" data-bs-toggle="tooltip" data-bs-placement="bottom" title="${config.tooltip}">${metodo}</span>`;
    }
    
    // Funci√≥n para generar indicador de calidad simple con Bootstrap tooltip
    function generarBarraCalidad(calidad) {
        if (!calidad && calidad !== 0) return '<span class="text-muted">N/A</span>';
        
        // Asegurar que est√© entre 0 y 10
        const calidadLimitada = Math.max(0, Math.min(10, calidad));
        
        // Determinar color y categor√≠a seg√∫n la calidad
        let bgColor, textColor, categoria;
        if (calidadLimitada <= 3) {
            bgColor = '#dc3545'; // Rojo
            textColor = 'white';
            categoria = 'Baja';
        } else if (calidadLimitada <= 5) {
            bgColor = '#ffc107'; // Amarillo
            textColor = 'black';
            categoria = 'Regular';
        } else if (calidadLimitada <= 7) {
            bgColor = '#fd7e14'; // Naranja
            textColor = 'white';
            categoria = 'Buena';
        } else {
            bgColor = '#28a745'; // Verde
            textColor = 'white';
            categoria = 'Excelente';
        }
        
        const tooltipText = `Calidad ${categoria}: ${calidadLimitada.toFixed(1)}/10. Indica qu√© tan bien la receta cumple con los objetivos de macronutrientes.`;
        
        return `
            <div class="d-inline-block" style="min-width: 80px;">
                <span class="badge" style="background-color: ${bgColor}; color: ${textColor}; font-size: 0.9rem; padding: 6px 12px; cursor: help;" 
                      data-bs-toggle="tooltip" data-bs-placement="bottom" title="${tooltipText}">
                    ${calidadLimitada.toFixed(1)}/10
                </span>
                <small class="d-block text-muted mt-1" style="font-size: 0.75rem;">${categoria}</small>
            </div>
        `;
    }
    
    // ========== FIN FUNCIONES DE UTILIDAD ==========
    
    // Funci√≥n para cargar el plan de recetas
    function cargarPlanRecetas() {
        // Obtener informaci√≥n del plan nutricional del usuario
        fetch(apiUrl('/api/plan-alimentario/info'))
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarInfoPlan(data.plan);
                    mostrarComidasDisponibles(data.comidas);
                    cargarRecetasDisponibles();
                }
            })
            .catch(error => {
                console.error('Error cargando plan:', error);
                document.getElementById('plan-details').innerHTML = 
                    '<p class="text-danger">Error cargando informaci√≥n del plan. Aseg√∫rate de tener configurado tu plan nutricional.</p>';
            });
    }
    
    function mostrarInfoPlan(plan) {
        const planDetails = document.getElementById('plan-details');
        planDetails.innerHTML = `
            <div class="row">
                <div class="col-md-3">
                    <strong>Usuario:</strong> ${plan.usuario || 'No definido'}
                </div>
                <div class="col-md-3">
                    <strong>Calor√≠as Totales:</strong> ${plan.calorias || 'No definidas'} kcal
                </div>
                <div class="col-md-3">
                    <strong>Comidas Activas:</strong> ${plan.comidas_activas || 0}
                </div>
                <div class="col-md-3">
                    <strong>Libertad:</strong> ${plan.libertad || 0}%
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-4">
                    <small><strong>Prote√≠na Total:</strong> ${plan.proteina_total || 0}g</small>
                </div>
                <div class="col-md-4">
                    <small><strong>Grasa Total:</strong> ${plan.grasa_total || 0}g</small>
                </div>
                <div class="col-md-4">
                    <small><strong>Carbohidratos Total:</strong> ${plan.carbohidratos_total || 0}g</small>
                </div>
            </div>
        `;
    }
    
    function mostrarComidasDisponibles(comidas) {
        const container = document.getElementById('comidas-container');
        container.innerHTML = '';
        
        const comidasConfig = {
            'desayuno': { nombre: 'Desayuno', icon: 'fa-coffee', class: 'comida-desayuno' },
            'media_manana': { nombre: 'Media Ma√±ana', icon: 'fa-apple-alt', class: 'comida-media-manana' },
            'almuerzo': { nombre: 'Almuerzo', icon: 'fa-utensils', class: 'comida-almuerzo' },
            'merienda': { nombre: 'Merienda', icon: 'fa-cookie-bite', class: 'comida-merienda' },
            'media_tarde': { nombre: 'Media Tarde', icon: 'fa-tea', class: 'comida-media-tarde' },
            'cena': { nombre: 'Cena', icon: 'fa-moon', class: 'comida-cena' }
        };
        
        // ORDENAR las comidas seg√∫n el campo 'orden' del backend
        // Convertir objeto a array de [id, data] y ordenar por campo 'orden'
        const comidasOrdenadas = Object.entries(comidas)
            .filter(([_, comida]) => comida.activa)
            .sort((a, b) => (a[1].orden || 0) - (b[1].orden || 0));
        
        // Iterar sobre las comidas ya ordenadas
        comidasOrdenadas.forEach(([comidaId, comida]) => {
            const config = comidasConfig[comidaId];
                
                const comidaHtml = `
                    <div class="col-lg-6 mb-4">
                        <div class="card comida-card ${config.class}">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fa ${config.icon} me-2"></i>${config.nombre}
                                </h6>
                                <small class="text-muted">
                                    P: ${comida.proteina}g | G: ${comida.grasa}g | C: ${comida.carbohidratos}g
                                </small>
                            </div>
                            <div class="card-body">
                                <div class="recetas-container" data-comida="${comidaId}">
                                    <div class="receta-selector mb-2">
                                        <div class="input-group">
                                            <select class="form-select recipe-select" data-comida="${comidaId}">
                                                <option value="">Seleccionar receta...</option>
                                            </select>
                                            <button class="btn btn-primary btn-add-recipe" data-comida="${comidaId}">
                                                <i class="fa fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="recetas-seleccionadas" id="recetas-${comidaId}">
                                        <!-- Las recetas seleccionadas aparecer√°n aqu√≠ -->
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-info">
                                        <i class="fa fa-info-circle me-1"></i>
                                        Puedes seleccionar entre 1-7 recetas por comida
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += comidaHtml;
        });
        
        // Agregar event listeners para los botones de agregar receta
        document.querySelectorAll('.btn-add-recipe').forEach(btn => {
            btn.addEventListener('click', function() {
                const comidaId = this.dataset.comida;
                const select = this.parentElement.querySelector('.recipe-select');
                const recetaId = select.value;
                const recetaNombre = select.options[select.selectedIndex].text;
                
                if (!recetaId) {
                    alert('Por favor selecciona una receta primero');
                    return;
                }
                
                // Verificar l√≠mites (1-7 recetas)
                const recetasContainer = document.getElementById(`recetas-${comidaId}`);
                const recetasActuales = recetasContainer.querySelectorAll('.receta-item').length;
                
                if (recetasActuales >= 7) {
                    alert('M√°ximo 7 recetas por comida');
                    return;
                }
                
                // Verificar que no est√© duplicada
                const recetasExistentes = Array.from(recetasContainer.querySelectorAll('.receta-item'))
                    .map(item => item.dataset.recetaId);
                
                if (recetasExistentes.includes(recetaId)) {
                    alert('Esta receta ya est√° agregada');
                    return;
                }
                
                // Agregar receta
                agregarRecetaAComida(comidaId, recetaId, recetaNombre);
                
                // Limpiar selector
                select.value = '';
            });
        });
    }
    
    function agregarRecetaAComida(comidaId, recetaId, recetaNombre) {
        const container = document.getElementById(`recetas-${comidaId}`);
        
        const recetaHtml = `
            <div class="receta-item d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded" 
                 data-receta-id="${recetaId}">
                <div>
                    <i class="fa fa-utensils text-primary me-2"></i>
                    <span class="fw-bold">${recetaNombre}</span>
                </div>
                <button class="btn btn-sm btn-outline-danger btn-remove-recipe" 
                        data-comida="${comidaId}" data-receta-id="${recetaId}">
                    <i class="fa fa-times"></i>
                </button>
            </div>
        `;
        
        container.innerHTML += recetaHtml;
        
        // No necesitamos agregar event listeners aqu√≠
        // La delegaci√≥n de eventos global (l√≠nea 408) maneja todos los botones
    }
    
    function cargarRecetasDisponibles() {
        fetch('/api/plan-alimentario/recetas')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const selects = document.querySelectorAll('.recipe-select');
                    selects.forEach(select => {
                        data.recetas.forEach(receta => {
                            const option = document.createElement('option');
                            option.value = receta.id;
                            option.textContent = receta.nombre;
                            select.appendChild(option);
                        });
                    });
                }
            });
    }
    
    // Guardar plan de recetas
    document.getElementById('guardar-plan-recetas').addEventListener('click', function() {
        const planData = {
            tipo: 'recetas',
            comidas: {}
        };
        
        // Recopilar todas las recetas seleccionadas por comida
        document.querySelectorAll('.recetas-container').forEach(container => {
            const comidaId = container.dataset.comida;
            const recetasItems = container.querySelectorAll('.receta-item');
            
            if (recetasItems.length > 0) {
                const recetasIds = Array.from(recetasItems).map(item => item.dataset.recetaId);
                planData.comidas[comidaId] = recetasIds;
            }
        });
        
        // Validar que haya al menos una comida con recetas
        if (Object.keys(planData.comidas).length === 0) {
            alert('Por favor selecciona al menos una receta para una comida antes de guardar.');
            return;
        }
        
        // Validar que cada comida tenga entre 1-7 recetas
        for (const [comida, recetas] of Object.entries(planData.comidas)) {
            if (recetas.length < 1) {
                alert(`La comida ${comida.replace('_', ' ')} necesita al menos 1 receta (actual: ${recetas.length})`);
                return;
            }
            if (recetas.length > 7) {
                alert(`La comida ${comida.replace('_', ' ')} no puede tener m√°s de 7 recetas (actual: ${recetas.length})`);
                return;
            }
        }
        
        // Mostrar confirmaci√≥n con resumen
        const totalRecetas = Object.values(planData.comidas).reduce((sum, recetas) => sum + recetas.length, 0);
        const confirmMessage = `¬øGuardar plan con ${totalRecetas} recetas en ${Object.keys(planData.comidas).length} comidas?`;
        
        if (!confirm(confirmMessage)) {
            return;
        }
        
        fetch('/api/plan-alimentario/guardar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
            },
            body: JSON.stringify(planData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`¬°Plan guardado exitosamente!\n${data.message}`);
                // RECARGAR VISTA DEL PLAN GUARDADO
                document.getElementById('panel-recetas').style.display = 'none';
                document.getElementById('cancelar-modificacion-btn').style.display = 'none';
                verificarPlanGuardado();
            } else {
                alert('Error guardando el plan: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexi√≥n al guardar el plan');
        });
    });
    
    function mostrarBotonVerPlanCalculado() {
        const container = document.querySelector('.row.mt-4');
        if (!document.getElementById('ver-plan-calculado')) {
            const btnHtml = `
                <div class="col-md-12 mt-2">
                    <button class="btn btn-success btn-block" id="ver-plan-calculado">
                        <i class="fa fa-calculator me-2"></i>Ver Plan Calculado Autom√°ticamente
                    </button>
                </div>
            `;
            container.innerHTML += btnHtml;
            
            // Agregar event listener
            document.getElementById('ver-plan-calculado').addEventListener('click', function() {
                cargarPlanCalculado();
            });
        }
    }
    
    function cargarPlanCalculado() {
        fetch(apiUrl('/api/plan-alimentario/plan-guardado'))
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarPlanCalculado(data.recetas_calculadas);
                } else {
                    alert('Error cargando plan calculado: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error de conexi√≥n al cargar plan calculado');
            });
    }
    
    function mostrarPlanCalculado(recetasCalculadas) {
        // Crear modal o secci√≥n para mostrar el plan calculado
        let html = `
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fa fa-calculator me-2"></i>Plan Alimentario Calculado
                            </h5>
                        </div>
                        <div class="card-body">
        `;
        
        Object.keys(recetasCalculadas).forEach(comidaId => {
            const comida = recetasCalculadas[comidaId];
            html += `
                <div class="mb-4">
                    <h6 class="text-success">${comida.nombre_comida}</h6>
                    <div class="row">
            `;
            
            comida.recetas.forEach(receta => {
                html += `
                    <div class="col-md-6 mb-2">
                        <div class="card">
                            <div class="card-body py-2">
                                <h6 class="card-title mb-1">${receta.nombre}</h6>
                                <small class="text-muted">
                                    ${receta.calculo ? receta.calculo.status : 'Calculando...'}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        });
        
        html += `
                    </div>
                </div>
            </div>
        </div>
        `;
        
        // Insertar despu√©s del panel de recetas
        const panelRecetas = document.getElementById('panel-recetas');
        panelRecetas.innerHTML += html;
        
        // Scroll to the calculated plan
        panelRecetas.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }
    
    // Generar lista de compras
    document.getElementById('generar-lista-compras').addEventListener('click', function() {
        const comidasSeleccionadas = {};
        document.querySelectorAll('.recipe-select').forEach(select => {
            if (select.value) {
                comidasSeleccionadas[select.dataset.comida] = select.value;
            }
        });
        
        if (Object.keys(comidasSeleccionadas).length === 0) {
            alert('Selecciona recetas antes de generar la lista de compras.');
            return;
        }
        
        fetch('/api/plan-alimentario/lista-compras', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ comidas: comidasSeleccionadas })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarListaCompras(data.lista);
            }
        });
    });
    
    function mostrarListaCompras(lista) {
        const panel = document.getElementById('panel-lista-compras');
        const content = document.getElementById('lista-compras-content');
        
        let html = '<div class="row">';
        Object.keys(lista).forEach(categoria => {
            html += `
                <div class="col-md-6 mb-3">
                    <h6><i class="fa fa-list-ul me-2"></i>${categoria}</h6>
                    <ul class="list-unstyled">
            `;
            lista[categoria].forEach(item => {
                html += `<li><i class="fa fa-check-circle text-success me-2"></i>${item.nombre} (${item.cantidad})</li>`;
            });
            html += '</ul></div>';
        });
        html += '</div>';
        
        content.innerHTML = html;
        panel.style.display = 'block';
        panel.scrollIntoView({ behavior: 'smooth' });
    }
    
    // ========== FUNCIONES PARA PLAN SIMPLIFICADO CON BLOQUES ==========
    
    function cargarPlanSimplificado() {
        fetch(apiUrl('/api/plan-alimentario/info'))
            .then(response => response.json())
            .then(data => {
                if (data.success && data.comidas) {
                    mostrarBloquesComidas(data.comidas, data.bloques_config);
                    poblarSelectorComidas(data.comidas);
                    
                    // Cargar sugerencias autom√°ticamente
                    cargarSugerencias();
                } else {
                    alert('Error cargando plan simplificado: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error cargando plan simplificado:', error);
            });
    }
    
    function mostrarBloquesComidas(comidas, bloquesConfig) {
        const container = document.getElementById('bloques-comidas-container');
        let html = '';
        const mode = window.complexityMode || 'completo';
        
        console.log('mostrarBloquesComidas - modo:', mode);
        console.log('mostrarBloquesComidas - comidas:', comidas);
        
        const ordenComidas = ['desayuno', 'media_manana', 'almuerzo', 'merienda', 'media_tarde', 'cena'];
        const comidasOrdenadas = ordenComidas.filter(comidaId => comidas[comidaId]);
        
        comidasOrdenadas.forEach(comidaId => {
            const comida = comidas[comidaId];
            const config = getComidasConfig()[comidaId];
            
            console.log(`Procesando ${comidaId}:`, {
                proteina: comida.proteina,
                grasa: comida.grasa,
                carbohidratos: comida.carbohidratos,
                energia: comida.energia,
                bloques: comida.bloques
            });
            
            // Generar resumen seg√∫n modo
            let resumen = '';
            let columnasHTML = '';
            let infoGramos = '';
            
            // Calcular energ√≠a con fallback si no viene del backend
            const calcularEnergiaFallback = (c) => {
                if (c.energia) {
                    console.log(`${comidaId} - usando energia del backend:`, c.energia);
                    return c.energia;
                }
                const p = parseFloat(c.proteina) || 0;
                const g = parseFloat(c.grasa) || 0;
                const ch = parseFloat(c.carbohidratos) || 0;
                const kcal_total = (p * 4) + (g * 9) + (ch * 4);
                const kcal_gc = (g * 9) + (ch * 4);
                const toBloques = v => Math.round((v / 100) * 2) / 2;
                console.log(`${comidaId} - calculando energia fallback:`, {p, g, ch, kcal_total, kcal_gc});
                return {
                    kcal_total,
                    kcal_gc,
                    bloques_total: toBloques(kcal_total),
                    bloques_gc: toBloques(kcal_gc),
                    bloque_kcal: 100
                };
            };
            
            if (mode === 'completo') {
                // Modo completo: P ¬∑ G ¬∑ C
                resumen = comida.bloques.resumen;
                columnasHTML = `
                    <div class="col-4">
                        <div class="badge bg-danger w-100 mb-1">${comida.bloques.proteina.bloques}P</div>
                        <div class="text-muted">${comida.bloques.proteina.gramos_objetivo}g</div>
                    </div>
                    <div class="col-4">
                        <div class="badge bg-warning w-100 mb-1">${comida.bloques.grasa.bloques}G</div>
                        <div class="text-muted">${comida.bloques.grasa.gramos_objetivo}g</div>
                    </div>
                    <div class="col-4">
                        <div class="badge bg-primary w-100 mb-1">${comida.bloques.carbohidratos.bloques}C</div>
                        <div class="text-muted">${comida.bloques.carbohidratos.gramos_objetivo}g</div>
                    </div>
                `;
                infoGramos = `P:${comida.proteina}g ¬∑ G:${comida.grasa}g ¬∑ C:${comida.carbohidratos}g`;
                
            } else if (mode === 'proteina') {
                // Modo prote√≠na: P y E_gc
                const energia = calcularEnergiaFallback(comida);
                resumen = `${comida.bloques.proteina.bloques}P ¬∑ ${energia.bloques_gc.toFixed(1)}E`;
                columnasHTML = `
                    <div class="col-6">
                        <div class="badge bg-danger w-100 mb-1">${comida.bloques.proteina.bloques}P</div>
                        <div class="text-muted">${comida.bloques.proteina.gramos_objetivo}g prote√≠na</div>
                    </div>
                    <div class="col-6">
                        <div class="badge bg-success w-100 mb-1">${energia.bloques_gc.toFixed(1)}E</div>
                        <div class="text-muted">${Math.round(energia.kcal_gc)} kcal (G+C)</div>
                    </div>
                `;
                infoGramos = `${comida.proteina}g P ¬∑ ${Math.round((comida.grasa || 0) + (comida.carbohidratos || 0))}g (G+C)`;
                
            } else {
                // Modo calor√≠as: solo E_total
                const energia = calcularEnergiaFallback(comida);
                resumen = `${energia.bloques_total.toFixed(1)}E`;
                columnasHTML = `
                    <div class="col-12">
                        <div class="badge bg-success w-100 mb-1">${energia.bloques_total.toFixed(1)}E</div>
                        <div class="text-muted">${Math.round(energia.kcal_total)} kcal totales</div>
                    </div>
                `;
                infoGramos = `${Math.round(energia.kcal_total)} kcal totales`;
            }
            
            html += `
                <div class="col-md-6 mb-4">
                    <div class="card comida-card ${config.class} h-100">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fa ${config.icon} me-2"></i>${comida.nombre}
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-3">
                                <h3 class="mb-0">${resumen}</h3>
                                <small class="text-muted">Bloques diarios</small>
                            </div>
                            <hr>
                            <div class="row text-center small">
                                ${columnasHTML}
                            </div>
                            <div class="mt-3 p-2 bg-light rounded">
                                <small class="text-muted">
                                    <i class="fa fa-info-circle me-1"></i>
                                    ${infoGramos}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Guardar referencia para re-renderizado
        window.planData = {comidas, bloquesConfig};
    }
    
    // Exponer funci√≥n en scope global para que actualizarVistaPorModo() pueda llamarla
    window.mostrarBloquesComidas = mostrarBloquesComidas;
    
    function poblarSelectorComidas(comidas) {
        const select = document.getElementById('ajuste-comida-select');
        let html = '<option value="">Selecciona una comida...</option>';
        
        const ordenComidas = ['desayuno', 'media_manana', 'almuerzo', 'merienda', 'media_tarde', 'cena'];
        const comidasOrdenadas = ordenComidas.filter(comidaId => comidas[comidaId]);
        
        comidasOrdenadas.forEach(comidaId => {
            const comida = comidas[comidaId];
            html += `<option value="${comidaId}">${comida.nombre}</option>`;
        });
        
        select.innerHTML = html;
    }
    
    // Manejar ajustes de bloques
    document.querySelectorAll('[data-ajuste]').forEach(btn => {
        btn.addEventListener('click', function() {
            const comidaSelect = document.getElementById('ajuste-comida-select');
            const comida = comidaSelect.value;
            
            if (!comida) {
                alert('Selecciona una comida primero');
                return;
            }
            
            const ajuste = this.dataset.ajuste;
            const valor = parseInt(this.dataset.valor);
            
            aplicarAjuste(comida, ajuste, valor);
        });
    });
    
    function aplicarAjuste(comida, tipoAjuste, valor) {
        const ajustes = {};
        ajustes[tipoAjuste] = valor;
        
        fetch('/api/plan-alimentario/bloques/ajustar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                comida: comida,
                ajustes: ajustes
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarResultadoAjuste(data);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error aplicando ajuste:', error);
            alert('Error al aplicar ajuste');
        });
    }
    
    function mostrarResultadoAjuste(data) {
        const resultadoDiv = document.getElementById('ajuste-resultado');
        const comidasConfig = getComidasConfig();
        const comidaNombre = comidasConfig[data.comida].nombre;
        
        let html = `
            <h6><i class="fa fa-check-circle me-2"></i>Ajuste aplicado a ${comidaNombre}</h6>
            <div class="row text-center mb-3">
                <div class="col-12">
                    <h4 class="mb-0">${data.resultado.bloques.resumen}</h4>
                    <small class="text-muted">Nueva distribuci√≥n de bloques</small>
                </div>
            </div>
            <div class="row text-center small">
                <div class="col-4">
                    <div class="badge bg-danger w-100 mb-1">${data.resultado.bloques.proteina}P</div>
                    <div class="text-muted">${data.resultado.gramos.proteina}g</div>
                </div>
                <div class="col-4">
                    <div class="badge bg-warning w-100 mb-1">${data.resultado.bloques.grasa}G</div>
                    <div class="text-muted">${data.resultado.gramos.grasa}g</div>
                </div>
                <div class="col-4">
                    <div class="badge bg-primary w-100 mb-1">${data.resultado.bloques.carbohidratos}C</div>
                    <div class="text-muted">${data.resultado.gramos.carbohidratos}g</div>
                </div>
            </div>
            <div class="alert alert-warning mt-3 mb-0 small">
                <i class="fa fa-exclamation-triangle me-1"></i>
                ${data.nota}
            </div>
        `;
        
        resultadoDiv.innerHTML = html;
        resultadoDiv.style.display = 'block';
        
        // Auto-ocultar despu√©s de 10 segundos
        setTimeout(() => {
            resultadoDiv.style.display = 'none';
        }, 10000);
        
        // Recargar sugerencias despu√©s de aplicar un ajuste
        cargarSugerencias();
    }
    
    // ========== FUNCIONES PARA CARRUSEL DE SUGERENCIAS ==========
    
    function cargarSugerencias(comidaFiltro = null) {
        const url = comidaFiltro 
            ? `/api/plan-alimentario/bloques/sugerencias?comida=${comidaFiltro}`
            : '/api/plan-alimentario/bloques/sugerencias';
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderizarSugerencias(data.sugerencias);
                    document.getElementById('sugerencias-container').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error cargando sugerencias:', error);
            });
    }
    
    function renderizarSugerencias(sugerencias) {
        // Guardar en variable global para re-renderizado
        window.sugerenciasData = window.sugerenciasData || {};
        window.sugerenciasData.favoritos = sugerencias.favoritos_usuario;
        window.sugerenciasData.dinamicas = sugerencias.sugerencias_dinamicas;
        window.sugerenciasData.recientes = sugerencias.ajustes_recientes;
        
        // Renderizar cada categor√≠a
        renderizarSugerenciasFavoritas(sugerencias.favoritos_usuario);
        renderizarSugerenciasDinamicas(sugerencias.sugerencias_dinamicas);
        cargarBiblioteca(); // Cargar biblioteca en lugar de presets globales
        renderizarSugerenciasRecientes(sugerencias.ajustes_recientes);
    }
    
    function renderizarSugerenciasFavoritas(favoritos) {
        const container = document.getElementById('sugerencias-favoritos-list');
        
        if (!favoritos || favoritos.length === 0) {
            container.innerHTML = `
                <div class="col-12 text-center text-muted py-4">
                    <i class="fa fa-star fa-3x mb-2"></i>
                    <p>A√∫n no tienes favoritos guardados</p>
                    <small>Aplica una sugerencia y m√°rcala como favorita para verla aqu√≠</small>
                </div>
            `;
            return;
        }
        
        let html = '';
        favoritos.forEach(sugerencia => {
            html += crearCardSugerencia(sugerencia, true);
        });
        container.innerHTML = html;
    }
    
    // Exponer en scope global
    window.renderizarSugerenciasFavoritas = renderizarSugerenciasFavoritas;
    
    function renderizarSugerenciasDinamicas(dinamicas) {
        const container = document.getElementById('sugerencias-dinamicas-list');
        
        if (!dinamicas || dinamicas.length === 0) {
            container.innerHTML = `
                <div class="col-12 text-center text-muted py-4">
                    <i class="fa fa-info-circle fa-3x mb-2"></i>
                    <p>No hay sugerencias disponibles</p>
                    <small>Las sugerencias se generan seg√∫n tu plan actual</small>
                </div>
            `;
            return;
        }
        
        let html = '';
        dinamicas.forEach(sugerencia => {
            html += crearCardSugerencia(sugerencia, false);
        });
        container.innerHTML = html;
    }
    
    // Exponer en scope global
    window.renderizarSugerenciasDinamicas = renderizarSugerenciasDinamicas;
    
    function cargarBiblioteca() {
        fetch('/api/plan-alimentario/biblioteca')
            .then(r => r.json())
            .then(data => {
                const container = document.getElementById('biblioteca-list');
                if (!data.success || !data.biblioteca || data.biblioteca.length === 0) {
                    container.innerHTML = `
                        <div class="col-12 text-center text-muted py-4">
                            <i class="fa fa-book fa-3x mb-2"></i>
                            <p>No hay combinaciones p√∫blicas a√∫n</p>
                            <small>Crea combinaciones y marca "Publicar en biblioteca"</small>
                        </div>`;
                    return;
                }
                container.innerHTML = data.biblioteca.map(item => crearCardBiblioteca(item)).join('');
            })
            .catch(err => console.error('Error biblioteca:', err));
    }
    
    function crearCardBiblioteca(item) {
        return `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100 border-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0">${item.alias}</h6>
                            <span class="badge bg-light text-dark">
                                <i class="fa fa-user"></i> ${item.creador_username}
                            </span>
                        </div>
                        <div class="text-center mb-2">
                            <h4 class="mb-0">${item.bloques.resumen}</h4>
                            <small class="text-muted">
                                ${Math.round(item.gramos.proteina)}g P ¬∑ 
                                ${Math.round(item.gramos.grasa)}g G ¬∑ 
                                ${Math.round(item.gramos.carbohidratos)}g C
                            </small>
                        </div>
                        <p class="text-muted small mb-2">${item.descripcion || ''}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="marcarFavorito(${item.id}, true)">
                                <i class="fa fa-heart"></i> ${item.favoritos_total || 0}
                            </button>
                            <button class="btn btn-sm btn-success btn-aplicar-sugerencia"
                                    data-sugerencia='${JSON.stringify(item).replace(/'/g,"&apos;")}'>
                                <i class="fa fa-check"></i> Aplicar
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
    }
    
    function marcarFavorito(id, add) {
        fetch('/api/plan-alimentario/favoritos/' + id, { 
            method: add ? 'POST' : 'DELETE' 
        })
        .then(r => r.json())
        .then(() => {
            cargarBiblioteca();
            console.log('Favorito actualizado');
        })
        .catch(err => console.error('Error favorito:', err));
    }
    
    function renderizarPresets(presets) {
        const container = document.getElementById('sugerencias-presets-list');
        
        if (!presets || presets.length === 0) {
            container.innerHTML = `
                <div class="col-12 text-center text-muted py-4">
                    <i class="fa fa-book fa-3x mb-2"></i>
                    <p>No hay presets disponibles</p>
                </div>
            `;
            return;
        }
        
        // Agrupar por comida
        const porComida = {};
        presets.forEach(preset => {
            if (!porComida[preset.comida]) {
                porComida[preset.comida] = [];
            }
            porComida[preset.comida].push(preset);
        });
        
        let html = '';
        Object.keys(porComida).forEach(comida => {
            const comidasConfig = getComidasConfig();
            const config = comidasConfig[comida];
            
            html += `
                <div class="col-12 mb-3">
                    <h6 class="text-muted mb-2">
                        <i class="fa ${config.icon} me-2"></i>${config.nombre}
                    </h6>
                    <div class="row">
            `;
            
            porComida[comida].forEach(preset => {
                html += crearCardSugerencia(preset, false);
            });
            
            html += `
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function renderizarSugerenciasRecientes(recientes) {
        const container = document.getElementById('sugerencias-recientes-list');
        
        if (!recientes || recientes.length === 0) {
            container.innerHTML = `
                <div class="col-12 text-center text-muted py-4">
                    <i class="fa fa-clock fa-3x mb-2"></i>
                    <p>No hay ajustes recientes</p>
                    <small>Tus √∫ltimos ajustes aparecer√°n aqu√≠</small>
                </div>
            `;
            return;
        }
        
        let html = '';
        recientes.forEach(reciente => {
            html += crearCardSugerencia(reciente, false, true);
        });
        container.innerHTML = html;
    }
    
    // Exponer en scope global
    window.renderizarSugerenciasRecientes = renderizarSugerenciasRecientes;
    
    function crearCardSugerencia(sugerencia, esFavorito = false, esReciente = false) {
        const badgeColor = {
            'preset_global': 'primary',
            'favorito': 'warning',
            'dinamica': 'info',
            'grupos': 'success',
            'reciente': 'secondary'
        }[sugerencia.tipo] || 'secondary';
        
        const mode = window.complexityMode || 'completo';
        
        // Construir detalle de alimentos si es tipo 'grupos'
        let alimentosDetalle = '';
        if (sugerencia.tipo === 'grupos' && sugerencia.alimentos && sugerencia.alimentos.length > 0) {
            alimentosDetalle = '<div class="mt-2 p-2 bg-light rounded"><small>';
            sugerencia.alimentos.forEach(alimento => {
                const porciones = alimento.porciones || 1;
                const gramos = alimento.gramos_estimados || Math.round(alimento.porcion_base * porciones);
                alimentosDetalle += `<div class="mb-1"><i class="fa fa-utensils me-1"></i><strong>${alimento.categoria}</strong> (${alimento.descripcion})`;
                if (porciones > 1) {
                    alimentosDetalle += ` √ó ${porciones}`;
                }
                alimentosDetalle += ` ‚âà ${gramos}g</div>`;
            });
            alimentosDetalle += '</small></div>';
        }
        
        // Generar resumen seg√∫n modo
        let resumenBloques = '';
        let detalleGramos = '';
        
        if (mode === 'completo') {
            resumenBloques = sugerencia.bloques.resumen;
            detalleGramos = `${Math.round(sugerencia.gramos.proteina)}g P ¬∑ ${Math.round(sugerencia.gramos.grasa)}g G ¬∑ ${Math.round(sugerencia.gramos.carbohidratos)}g C`;
        } else if (mode === 'proteina') {
            // Calcular E_gc
            const kcalGC = (sugerencia.gramos.grasa * 9) + (sugerencia.gramos.carbohidratos * 4);
            const bloquesEGC = Math.round((kcalGC / 100) * 2) / 2;
            resumenBloques = `${sugerencia.bloques.proteina.toFixed(2)}P ¬∑ ${bloquesEGC.toFixed(1)}E`;
            detalleGramos = `${Math.round(sugerencia.gramos.proteina)}g P ¬∑ ${Math.round(kcalGC)} kcal (G+C)`;
        } else {
            // Calcular E_total
            const kcalTotal = (sugerencia.gramos.proteina * 4) + (sugerencia.gramos.grasa * 9) + (sugerencia.gramos.carbohidratos * 4);
            const bloquesETotal = Math.round((kcalTotal / 100) * 2) / 2;
            resumenBloques = `${bloquesETotal.toFixed(1)}E`;
            detalleGramos = `${Math.round(kcalTotal)} kcal totales`;
        }
        
        return `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100 border-${badgeColor}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">${sugerencia.alias}</h6>
                            ${esFavorito ? '<i class="fa fa-star text-warning"></i>' : ''}
                            ${sugerencia.tipo === 'grupos' ? '<span class="badge bg-success badge-sm ms-1">üçΩÔ∏è</span>' : ''}
                        </div>
                        <p class="card-text small text-muted">${sugerencia.descripcion || ''}</p>
                        
                        <div class="text-center mb-2">
                            <h4 class="mb-0">${resumenBloques}</h4>
                            <small class="text-muted">
                                ${detalleGramos}
                            </small>
                            ${sugerencia.diff_display && sugerencia.diff_display !== 'Exacto' ? 
                                `<div class="badge bg-info mt-1">${sugerencia.diff_display} vs objetivo</div>` : 
                                sugerencia.diff_display === 'Exacto' ? '<div class="badge bg-success mt-1">‚úì Exacto</div>' : ''}
                            ${sugerencia.requiere_validacion ? '<div class="badge bg-warning mt-1"><i class="fa fa-exclamation-triangle"></i> Validar con nutricionista</div>' : ''}
                        </div>
                        
                        ${alimentosDetalle}
                        
                        ${sugerencia.comida_nombre ? `<div class="badge bg-light text-dark mb-2 mt-2">${sugerencia.comida_nombre}</div>` : ''}
                        ${esReciente ? `<div class="badge bg-secondary mb-2"><i class="fa fa-clock"></i> ${new Date(sugerencia.timestamp).toLocaleDateString()}</div>` : ''}
                        
                        <div class="btn-group w-100 mt-2" role="group">
                            <button class="btn btn-sm btn-outline-${badgeColor} btn-aplicar-sugerencia"
                                    data-sugerencia='${JSON.stringify(sugerencia).replace(/'/g, "&apos;")}'>
                                <i class="fa fa-check"></i> Aplicar
                            </button>
                            ${!esFavorito && !esReciente ? `
                                <button class="btn btn-sm btn-outline-warning btn-guardar-favorito"
                                        data-sugerencia='${JSON.stringify(sugerencia).replace(/'/g, "&apos;")}'>
                                    <i class="fa fa-star"></i> Favorito
                                </button>
                            ` : ''}
                            ${esFavorito ? `
                                <button class="btn btn-sm btn-outline-danger btn-eliminar-favorito"
                                        data-favorito-id="${sugerencia.id}">
                                    <i class="fa fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Event delegation para botones de sugerencias
    document.addEventListener('click', function(e) {
        // Aplicar sugerencia
        if (e.target.closest('.btn-aplicar-sugerencia')) {
            const btn = e.target.closest('.btn-aplicar-sugerencia');
            const sugerencia = JSON.parse(btn.dataset.sugerencia);
            aplicarSugerencia(sugerencia);
        }
        
        // Guardar como favorito
        if (e.target.closest('.btn-guardar-favorito')) {
            const btn = e.target.closest('.btn-guardar-favorito');
            const sugerencia = JSON.parse(btn.dataset.sugerencia);
            guardarComoFavorito(sugerencia);
        }
        
        // Eliminar favorito
        if (e.target.closest('.btn-eliminar-favorito')) {
            const btn = e.target.closest('.btn-eliminar-favorito');
            const favoritoId = btn.dataset.favoritoId;
            eliminarFavorito(favoritoId);
        }
    });
    
    function aplicarSugerencia(sugerencia) {
        // Calcular el ajuste necesario desde el estado actual
        // Por simplicidad, aplicamos directamente los bloques de la sugerencia
        
        // Mostrar en el √°rea de resultados
        const resultadoDiv = document.getElementById('ajuste-resultado');
        const comidasConfig = getComidasConfig();
        const comidaNombre = sugerencia.comida_nombre || comidasConfig[sugerencia.comida]?.nombre || 'Comida';
        
        resultadoDiv.innerHTML = `
            <h6><i class="fa fa-magic me-2"></i>Sugerencia aplicada: ${sugerencia.alias}</h6>
            <p class="mb-2">${sugerencia.descripcion}</p>
            <div class="text-center mb-2">
                <h4 class="mb-0">${sugerencia.bloques.resumen}</h4>
                <small class="text-muted">Para ${comidaNombre}</small>
            </div>
            <div class="row text-center small">
                <div class="col-4">
                    <div class="badge bg-danger w-100">${sugerencia.bloques.proteina}P</div>
                    <div class="text-muted">${Math.round(sugerencia.gramos.proteina)}g</div>
                </div>
                <div class="col-4">
                    <div class="badge bg-warning w-100">${sugerencia.bloques.grasa}G</div>
                    <div class="text-muted">${Math.round(sugerencia.gramos.grasa)}g</div>
                </div>
                <div class="col-4">
                    <div class="badge bg-primary w-100">${sugerencia.bloques.carbohidratos}C</div>
                    <div class="text-muted">${Math.round(sugerencia.gramos.carbohidratos)}g</div>
                </div>
            </div>
            <div class="alert alert-info mt-3 mb-0 small">
                <i class="fa fa-info-circle me-1"></i>
                Esta es una vista previa. Para guardar permanentemente, actualiza tu plan nutricional.
            </div>
        `;
        
        resultadoDiv.style.display = 'block';
        resultadoDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Si la sugerencia tiene ID (preset o favorito), marcar como usada
        if (sugerencia.id) {
            fetch(`/api/plan-alimentario/bloques/sugerencias/${sugerencia.id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ marcar_usada: true })
            }).catch(err => console.error('Error marcando como usada:', err));
        }
    }
    
    function guardarComoFavorito(sugerencia) {
        const alias = prompt('Nombre para este favorito:', sugerencia.alias || sugerencia.bloques.resumen);
        if (!alias) return;
        
        fetch('/api/plan-alimentario/bloques/sugerencias', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                comida: sugerencia.comida,
                proteina: sugerencia.bloques.proteina,
                grasa: sugerencia.bloques.grasa,
                carbohidratos: sugerencia.bloques.carbohidratos,
                alias: alias,
                descripcion: sugerencia.descripcion || 'Mi combinaci√≥n favorita'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úì Guardado como favorito');
                cargarSugerencias(); // Recargar para mostrar el nuevo favorito
                
                // Cambiar al tab de favoritos
                document.getElementById('favoritos-tab').click();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error guardando favorito:', error);
            alert('Error al guardar favorito');
        });
    }
    
    function eliminarFavorito(favoritoId) {
        if (!confirm('¬øEliminar este favorito?')) return;
        
        fetch(`/api/plan-alimentario/bloques/sugerencias/${favoritoId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úì Favorito eliminado');
                cargarSugerencias(); // Recargar sugerencias
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error eliminando favorito:', error);
            alert('Error al eliminar favorito');
        });
    }
    
    // ========== CONSTRUCTOR DE COMBINACIONES ==========
    
    let alimentosConstructor = []; // [{categoria, descripcion, porciones, bloques}, ...]
    let objetivoComida = {proteina: 0, grasa: 0, carbohidratos: 0};
    let alimentosDisponibles = []; // Cache de alimentos para el constructor
    
    // Al cambiar la comida, cargar objetivo desde el plan
    document.getElementById('constructorComida').addEventListener('change', function() {
        const comida = this.value;
        if (comida) {
            cargarObjetivoComida(comida);
            cargarAlimentosDisponibles('', comida);
        }
    });
    
    // Al cambiar filtro de macro, recargar alimentos
    document.getElementById('filtroMacro').addEventListener('change', function() {
        const macro = this.value;
        const momento = document.getElementById('constructorComida').value;
        if (momento) {
            cargarAlimentosDisponibles(macro, momento);
        }
    });
    
    function cargarObjetivoComida(comida) {
        fetch(apiUrl('/api/plan-alimentario/info'))
            .then(r => r.json())
            .then(data => {
                if (data.success && data.comidas && data.comidas[comida]) {
                    const comidaData = data.comidas[comida];
                    
                    // Usar bloques enteros (igual que en el panel)
                    objetivoComida = {
                        proteina: comidaData.bloques.proteina.bloques || 0,
                        grasa: comidaData.bloques.grasa.bloques || 0,
                        carbohidratos: comidaData.bloques.carbohidratos.bloques || 0
                    };
                    
                    document.getElementById('objProteina').textContent = objetivoComida.proteina.toFixed(0);
                    document.getElementById('objGrasa').textContent = objetivoComida.grasa.toFixed(0);
                    document.getElementById('objCarbohidratos').textContent = objetivoComida.carbohidratos.toFixed(0);
                    
                    document.getElementById('objProteinaGramos').textContent = Number(comidaData.bloques.proteina.gramos_objetivo || 0).toFixed(2);
                    document.getElementById('objGrasaGramos').textContent = Number(comidaData.bloques.grasa.gramos_objetivo || 0).toFixed(2);
                    document.getElementById('objCarbohidratosGramos').textContent = Number(comidaData.bloques.carbohidratos.gramos_objetivo || 0).toFixed(2);
                    
                    // Limpiar construcci√≥n anterior al cambiar de comida
                    alimentosConstructor = [];
                    renderizarListaAlimentos();
                    recalcularAcumulado();
                } else {
                    // Comida no configurada o sin bloques
                    console.warn(`Comida ${comida} no tiene bloques configurados`);
                    objetivoComida = {proteina: 0, grasa: 0, carbohidratos: 0};
                    
                    document.getElementById('objProteina').textContent = '0';
                    document.getElementById('objGrasa').textContent = '0';
                    document.getElementById('objCarbohidratos').textContent = '0';
                    document.getElementById('objProteinaGramos').textContent = '0.00';
                    document.getElementById('objGrasaGramos').textContent = '0.00';
                    document.getElementById('objCarbohidratosGramos').textContent = '0.00';
                    
                    // Limpiar alimentos si hab√≠a
                    alimentosConstructor = [];
                    renderizarListaAlimentos();
                    recalcularAcumulado();
                    
                    alert('Esta comida no tiene bloques configurados en tu plan.');
                }
            })
            .catch(error => {
                console.error('Error cargando objetivo:', error);
                objetivoComida = {proteina: 0, grasa: 0, carbohidratos: 0};
                recalcularAcumulado();
            });
    }
    
    function cargarAlimentosDisponibles(macro, momento) {
        let url = '/api/grupos-alimentos?';
        if (macro) url += `macro=${macro}&`;
        if (momento) url += `momento=${momento}`;
        
        fetch(url)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alimentosDisponibles = data.alimentos;
                    const select = document.getElementById('selectAlimento');
                    select.innerHTML = '<option value="">Seleccionar alimento...</option>';
                    
                    data.alimentos.forEach((a, idx) => {
                        const bloques = `${a.bloques_unitarios.proteina.toFixed(1)}P¬∑${a.bloques_unitarios.grasa.toFixed(1)}G¬∑${a.bloques_unitarios.carbohidratos.toFixed(1)}C`;
                        const option = document.createElement('option');
                        option.value = idx;
                        option.textContent = `${a.categoria} (${a.descripcion}) - ${bloques}`;
                        select.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Error cargando alimentos:', error));
    }
    
    function agregarAlimentoConstructor() {
        const alimentoIdx = document.getElementById('selectAlimento').value;
        if (!alimentoIdx) {
            alert('Por favor selecciona un alimento');
            return;
        }
        
        const alimento = alimentosDisponibles[parseInt(alimentoIdx)];
        const porciones = parseInt(document.getElementById('porciones').value) || 1;
        
        // Agregar a lista
        alimentosConstructor.push({
            categoria: alimento.categoria,
            descripcion: alimento.descripcion,
            porciones: porciones,
            bloques: {
                proteina: alimento.bloques_unitarios.proteina * porciones,
                grasa: alimento.bloques_unitarios.grasa * porciones,
                carbohidratos: alimento.bloques_unitarios.carbohidratos * porciones
            },
            porcion_gramos: alimento.porcion_gramos
        });
        
        renderizarListaAlimentos();
        recalcularAcumulado();
        
        // Reset selector
        document.getElementById('selectAlimento').value = '';
        document.getElementById('porciones').value = 1;
    }
    
    function renderizarListaAlimentos() {
        const lista = document.getElementById('listaAlimentosConstructor');
        lista.innerHTML = '';
        
        if (alimentosConstructor.length === 0) {
            lista.innerHTML = '<div class="list-group-item text-muted text-center">A√∫n no has agregado alimentos</div>';
            return;
        }
        
        alimentosConstructor.forEach((a, index) => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            item.innerHTML = `
                <div>
                    <strong>${a.categoria}</strong> (${a.descripcion})
                    ${a.porciones > 1 ? ` √ó ${a.porciones}` : ''}
                    <br>
                    <small class="text-muted">
                        ${a.bloques.proteina.toFixed(1)}P ¬∑ 
                        ${a.bloques.grasa.toFixed(1)}G ¬∑ 
                        ${a.bloques.carbohidratos.toFixed(1)}C
                    </small>
                </div>
                <button class="btn btn-sm btn-danger" onclick="eliminarAlimentoConstructor(${index})">
                    <i class="fa fa-times"></i>
                </button>
            `;
            lista.appendChild(item);
        });
    }
    
    function eliminarAlimentoConstructor(index) {
        alimentosConstructor.splice(index, 1);
        renderizarListaAlimentos();
        recalcularAcumulado();
    }
    
    function recalcularAcumulado() {
        let totalP = 0, totalG = 0, totalC = 0;
        
        alimentosConstructor.forEach(a => {
            totalP += a.bloques.proteina;
            totalG += a.bloques.grasa;
            totalC += a.bloques.carbohidratos;
        });
        
        // Actualizar acumulado
        document.getElementById('acumProteina').textContent = totalP.toFixed(1);
        document.getElementById('acumGrasa').textContent = totalG.toFixed(1);
        document.getElementById('acumCarbohidratos').textContent = totalC.toFixed(1);
        
        // Calcular diferencias
        const diffP = objetivoComida.proteina - totalP;
        const diffG = objetivoComida.grasa - totalG;
        const diffC = objetivoComida.carbohidratos - totalC;
        
        // Mostrar falta/sobra con color
        mostrarDiferencia('difProteina', diffP, 'P');
        mostrarDiferencia('difGrasa', diffG, 'G');
        mostrarDiferencia('difCarbohidratos', diffC, 'C');
        
        // Cambiar color del panel seg√∫n precisi√≥n
        const margen = 0.3;
        const dentroDeMargen = Math.abs(diffP) <= margen && 
                              Math.abs(diffG) <= margen && 
                              Math.abs(diffC) <= margen;
        
        const panel = document.getElementById('panelAcumulado');
        panel.classList.remove('border-success', 'border-warning', 'border-danger');
        
        if (dentroDeMargen) {
            panel.classList.add('border-success');
        } else if (Math.abs(diffP) > 1 || Math.abs(diffG) > 1 || Math.abs(diffC) > 1) {
            panel.classList.add('border-danger');
        } else {
            panel.classList.add('border-warning');
        }
        
        // Mostrar/ocultar bot√≥n de sugerencia inteligente
        const sugerenciaPanel = document.getElementById('sugerenciaInteligentePanel');
        if (diffC > 0.5 && alimentosConstructor.length > 0) {
            sugerenciaPanel.style.display = 'block';
        } else {
            sugerenciaPanel.style.display = 'none';
        }
    }
    
    function mostrarDiferencia(elemId, diff, macro) {
        const elem = document.getElementById(elemId);
        elem.className = 'small';
        
        if (Math.abs(diff) < 0.1) {
            elem.innerHTML = '<i class="fa fa-check text-success"></i> Exacto';
            elem.classList.add('text-success');
        } else if (diff > 0) {
            elem.textContent = `Falta: ${diff.toFixed(1)}${macro}`;
            elem.classList.add('text-warning');
        } else {
            elem.textContent = `Sobra: ${Math.abs(diff).toFixed(1)}${macro}`;
            elem.classList.add('text-danger');
        }
    }
    
    function completarConCarbohidratos() {
        const diffC = objetivoComida.carbohidratos - 
                     alimentosConstructor.reduce((sum, a) => sum + a.bloques.carbohidratos, 0);
        
        if (diffC <= 0) {
            alert('Ya tienes suficientes carbohidratos');
            return;
        }
        
        // Obtener alimentos ricos en C que NO est√©n en la combinaci√≥n
        const categoriasYaUsadas = alimentosConstructor.map(a => a.categoria);
        const momento = document.getElementById('constructorComida').value;
        
        fetch(`/api/grupos-alimentos?macro=C&momento=${momento}`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Filtrar los que NO est√°n ya
                    const disponibles = data.alimentos.filter(a => !categoriasYaUsadas.includes(a.categoria));
                    
                    if (disponibles.length === 0) {
                        alert('No hay m√°s alimentos disponibles ricos en carbohidratos');
                        return;
                    }
                    
                    // Buscar el que m√°s se acerque
                    let mejorAlimento = null;
                    let menorError = 999;
                    let mejorPorciones = 1;
                    
                    disponibles.forEach(alimento => {
                        for (let porciones = 1; porciones <= 4; porciones++) {
                            const bloquesC = alimento.bloques_unitarios.carbohidratos * porciones;
                            const error = Math.abs(diffC - bloquesC);
                            
                            if (error < menorError) {
                                menorError = error;
                                mejorAlimento = alimento;
                                mejorPorciones = porciones;
                            }
                        }
                    });
                    
                    if (mejorAlimento) {
                        // Agregar autom√°ticamente
                        alimentosConstructor.push({
                            categoria: mejorAlimento.categoria,
                            descripcion: mejorAlimento.descripcion,
                            porciones: mejorPorciones,
                            bloques: {
                                proteina: mejorAlimento.bloques_unitarios.proteina * mejorPorciones,
                                grasa: mejorAlimento.bloques_unitarios.grasa * mejorPorciones,
                                carbohidratos: mejorAlimento.bloques_unitarios.carbohidratos * mejorPorciones
                            },
                            porcion_gramos: mejorAlimento.porcion_gramos
                        });
                        
                        renderizarListaAlimentos();
                        recalcularAcumulado();
                        
                        alert(`‚úì Agregado: ${mejorAlimento.categoria} √ó ${mejorPorciones}`);
                    }
                }
            })
            .catch(error => console.error('Error completando carbohidratos:', error));
    }
    
    function guardarCombinacionConstructor() {
        const comida = document.getElementById('constructorComida').value;
        const alias = document.getElementById('aliasConstructor').value.trim();
        const enviarRevision = document.getElementById('enviarRevision').checked;
        const publicar = document.getElementById('publicarBiblioteca')?.checked || false;
        
        if (!comida) {
            alert('Por favor selecciona una comida');
            return;
        }
        
        if (!alias) {
            alert('Por favor ingresa un nombre para tu combinaci√≥n');
            return;
        }
        
        if (alimentosConstructor.length === 0) {
            alert('Agrega al menos un alimento');
            return;
        }
        
        const datos = {
            comida: comida,
            alimentos: alimentosConstructor.map(a => ({
                categoria: a.categoria,
                descripcion: a.descripcion,
                porciones: a.porciones
            })),
            alias: alias,
            enviar_revision: enviarRevision,
            es_publica: publicar
        };
        
        fetch('/api/plan-alimentario/bloques/constructor', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(datos)
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert(`‚úì ${data.message}\n\nBloques totales:\n${data.bloques_total.proteina}P ¬∑ ${data.bloques_total.grasa}G ¬∑ ${data.bloques_total.carbohidratos}C`);
                
                // Cerrar modal (compatible con diferentes versiones de Bootstrap)
                const modalEl = document.getElementById('modalConstructor');
                if (window.bootstrap && bootstrap.Modal) {
                    const modal = bootstrap.Modal.getOrCreateInstance 
                        ? bootstrap.Modal.getOrCreateInstance(modalEl)
                        : new bootstrap.Modal(modalEl);
                    modal.hide();
                } else if (window.jQuery) {
                    window.jQuery(modalEl).modal('hide');
                } else {
                    modalEl.dispatchEvent(new Event('hide.bs.modal'));
                }
                
                // Limpiar constructor
                alimentosConstructor = [];
                renderizarListaAlimentos();
                recalcularAcumulado();
                document.getElementById('aliasConstructor').value = '';
                document.getElementById('enviarRevision').checked = false;
                document.getElementById('publicarBiblioteca').checked = false;
                document.getElementById('constructorComida').value = '';
                
                // Recargar sugerencias para mostrar el nuevo favorito
                cargarSugerencias();
                
                // Cambiar al tab de favoritos
                document.getElementById('favoritos-tab').click();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error guardando combinaci√≥n:', error);
            alert('Error al guardar combinaci√≥n');
        });
    }
    
    // Exponer funciones al scope global para onclick
    window.agregarAlimentoConstructor = agregarAlimentoConstructor;
    window.guardarCombinacionConstructor = guardarCombinacionConstructor;
    window.eliminarAlimentoConstructor = eliminarAlimentoConstructor;
    window.completarConCarbohidratos = completarConCarbohidratos;
    window.completarCarbohidratosAuto = completarConCarbohidratos; // Alias
    window.marcarFavorito = marcarFavorito;
    
    // Resetear modal constructor al abrirse
    const modalConstructorEl = document.getElementById('modalConstructor');
    if (modalConstructorEl) {
        modalConstructorEl.addEventListener('show.bs.modal', () => {
            const sel = document.getElementById('constructorComida');
            if (sel) sel.value = '';
            
            // Resetear estado del constructor
            alimentosConstructor = [];
            objetivoComida = { proteina: 0, grasa: 0, carbohidratos: 0 };
            
            // Refrescar UI
            renderizarListaAlimentos();
            ['Proteina','Grasa','Carbohidratos'].forEach(k => {
                document.getElementById('obj'+k).textContent = '0';
                document.getElementById('obj'+k+'Gramos').textContent = '0.00';
            });
            recalcularAcumulado();
        });
    }
});
</script>
<script src="/static/js/complexity_mode.js?v=1"></script>
{% endblock %}
