{% extends "base/base.html" %}

{% block extra_head %}
<style>
    .telemed-dropzone {
        border: 2px dashed rgba(92, 128, 209, 0.6);
        border-radius: 0.75rem;
        padding: 2.5rem 1rem;
        text-align: center;
        transition: all .2s ease;
        cursor: pointer;
        background: rgba(92, 128, 209, 0.04);
    }
    .telemed-dropzone.dragover {
        border-color: #5c80d1;
        background: rgba(92, 128, 209, 0.12);
        box-shadow: inset 0 0 10px rgba(92, 128, 209, 0.15);
    }
    .telemed-dropzone.disabled {
        opacity: .5;
        cursor: not-allowed;
    }
    .paciente-listado {
        max-height: 420px;
        overflow-y: auto;
    }
    .paciente-detalle-meta dt {
        width: 45%;
        font-weight: 600;
    }
    .paciente-detalle-meta dd {
        width: 55%;
        margin-bottom: .25rem;
    }
    @media (max-width: 575.98px) {
        .paciente-detalle-meta dt,
        .paciente-detalle-meta dd {
            width: 100%;
        }
    }
    .telemed-upload-item {
        border: 1px solid rgba(0,0,0,0.08);
        border-radius: .5rem;
        padding: .75rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: .9rem;
    }
    .telemed-upload-item + .telemed-upload-item {
        margin-top: .5rem;
    }
    .telemed-upload-status {
        font-size: .8rem;
        text-transform: uppercase;
        letter-spacing: .08em;
    }
</style>
{% endblock %}

{% block title %}Telemedicina{% endblock %}
{% block herotitle %}Telemedicina Integral{% endblock %}
{% block herosubtitle %}Coordina turnos, fichas clínicas y documentación en un solo lugar{% endblock %}

{% block content %}
<div class="container-fluid py-4 telemed-container">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
        <a href="/dashboard" class="btn btn-outline-primary mb-2">
            <i class="fa fa-arrow-left mr-2"></i>Volver al Dashboard
        </a>
        <div class="d-flex flex-wrap">
            {% for link in enlaces_rapidos %}
            <a class="badge badge-pill border mr-2 mb-2 py-2 px-3 text-body d-flex align-items-center"
               href="{{ link.url }}" target="_blank" rel="noopener">
                <i class="fa {{ link.icono }} text-primary mr-2"></i>
                <span class="font-w600">{{ link.nombre }}</span>
                <span class="badge badge-primary ml-2">{{ link.descripcion }}</span>
            </a>
            {% endfor %}
        </div>
    </div>

    <div id="telemed-alerts"></div>

    {% if secciones_menu %}
    <div class="btn-group btn-group-toggle mb-4" data-toggle="buttons">
        {% for seccion in secciones_menu %}
        <a class="btn btn-outline-primary{% if active_section == seccion.id %} active{% endif %}"
           href="{{ url_for(seccion.endpoint) }}">
            <i class="fa {{ seccion.icono }} mr-2"></i>{{ seccion.titulo }}
        </a>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Datos personales -->
    {% if active_section == 'pacientes' %}
    <div class="row">
        <div class="col-lg-7 order-lg-1 order-2">
            <div class="block block-rounded mb-4">
                <div class="block-header block-header-default d-flex justify-content-between align-items-center">
                    <h3 class="block-title mb-0">
                        <i class="fa fa-users mr-2 text-primary"></i>Lista de pacientes
                    </h3>
                    <button type="button" class="btn btn-sm btn-primary" id="btn-toggle-paciente-form">
                        <i class="fa fa-user-plus mr-1"></i>Nuevo paciente
                    </button>
                </div>
                <div class="block-content">
                    <div class="input-group input-group-sm mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fa fa-search"></i></span>
                        </div>
                        <input type="text" id="pacientes-search" class="form-control" placeholder="Buscar por nombre o documento">
                    </div>
                    <div class="paciente-listado list-group" id="pacientes-list-panel">
                        <div id="pacientes-empty-panel" class="text-muted text-center py-4 border rounded w-100">Sin registros cargados todavía.</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-5 order-lg-2 order-1">
            <div class="block block-rounded">
                <div class="block-header block-header-default d-flex justify-content-between align-items-center">
                    <h3 class="block-title mb-0">
                        <i class="fa fa-user-md mr-2 text-muted"></i>Detalle del paciente
                    </h3>
                    <span class="badge badge-pill badge-secondary" id="paciente-detalle-ultima-actualizacion">—</span>
                </div>
                <div class="block-content" id="paciente-detalle-panel">
                    <div id="paciente-detalle-placeholder" class="text-muted text-center py-3">
                        Selecciona un paciente de la lista para ver sus datos.
                    </div>
                    <div id="paciente-detalle-info" class="d-none">
                        <h4 class="font-w600 mb-1" id="paciente-detalle-nombre"></h4>
                        <p class="text-muted mb-3" id="paciente-detalle-identificador"></p>
                        <dl class="row paciente-detalle-meta small" id="paciente-detalle-metadata"></dl>
                        <hr>
                        <div class="mb-3">
                            <h6 class="text-uppercase text-muted small mb-2">Accesos rápidos</h6>
                            <div class="d-flex flex-column flex-sm-row">
                                <a id="detalle-ver-situaciones" class="btn btn-sm btn-outline-primary mb-2 mr-sm-2" data-base-url="{{ url_for('telemedicina_situacion') }}" href="{{ url_for('telemedicina_situacion') }}">
                                    <i class="fa fa-notes-medical mr-1"></i>Ver registros
                                </a>
                                <a id="detalle-ver-documentos" class="btn btn-sm btn-outline-info mb-2" data-base-url="{{ url_for('telemedicina_documentos') }}" href="{{ url_for('telemedicina_documentos') }}">
                                    <i class="fa fa-folder-open mr-1"></i>Ver estudios
                                </a>
                            </div>
                        </div>
                        <div class="mb-3">
                            <h6 class="text-uppercase text-muted small mb-2">Registros recientes</h6>
                            <div class="mb-3">
                                <span class="font-w600 d-block mb-1">Documentos</span>
                                <div class="small" id="paciente-detalle-registros-documentos">Selecciona un paciente para ver los documentos.</div>
                            </div>
                            <div>
                                <span class="font-w600 d-block mb-1">Situación clínica</span>
                                <div class="small" id="paciente-detalle-registros-situaciones">Selecciona un paciente para ver la situación actual.</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end flex-wrap">
                            <button type="button" class="btn btn-sm btn-outline-secondary mr-sm-2 mb-2" id="paciente-detalle-editar-btn">
                                <i class="fa fa-edit mr-1"></i>Editar ficha
                            </button>
                            <a class="btn btn-sm btn-primary mb-2" href="{{ url_for('telemedicina_documentos') }}" data-base-url="{{ url_for('telemedicina_documentos') }}" id="paciente-detalle-documentos-btn">
                                <i class="fa fa-folder-open mr-1"></i>Abrir documentos
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="paciente-form-container" class="block block-rounded block-themed mb-4 d-none">
        <div class="block-header bg-primary-dark d-flex justify-content-between align-items-center">
            <h3 class="block-title mb-0">
                <i class="fa fa-id-card-alt mr-2"></i>Ficha del paciente
            </h3>
            <button type="button" class="btn btn-sm btn-light" id="btn-close-paciente-form">
                <i class="fa fa-times mr-1"></i>Ocultar
            </button>
        </div>
        <div class="block-content">
            <p class="text-muted mb-4">
                Registra la ficha básica del paciente para tener a mano los datos clínicos relevantes antes de cada consulta.
            </p>
            <form id="form-datos-paciente" class="mb-4">
                <input type="hidden" name="id" id="paciente-id">
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label class="font-w600">Nombre *</label>
                        <input type="text" name="nombre" class="form-control" required placeholder="Ej. Juan">
                    </div>
                    <div class="form-group col-md-6">
                        <label class="font-w600">Apellido *</label>
                        <input type="text" name="apellido" class="form-control" required placeholder="Ej. Pérez">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label class="font-w600">Fecha de nacimiento</label>
                        <input type="date" name="fecha_nacimiento" class="form-control">
                    </div>
                    <div class="form-group col-md-4">
                        <label class="font-w600">Tipo de documento</label>
                        <select name="documento_tipo" class="form-control">
                            <option value="">Seleccionar...</option>
                            <option value="DNI">DNI</option>
                            <option value="Pasaporte">Pasaporte</option>
                            <option value="CUIL/CUIT">CUIL / CUIT</option>
                            <option value="Documento extranjero">Documento extranjero</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <div class="form-group col-md-4">
                        <label class="font-w600">Número de documento</label>
                        <input type="text" name="paciente_dni" class="form-control" placeholder="Ej. 30123456">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label class="font-w600">Documento alternativo</label>
                        <input type="text" name="documento" class="form-control" placeholder="Pasaporte, carnet, etc.">
                    </div>
                    <div class="form-group col-md-4">
                        <label class="font-w600">Teléfono de contacto</label>
                        <input type="text" name="telefono" class="form-control" placeholder="+54 9 362 XXX XXXX">
                    </div>
                    <div class="form-group col-md-2">
                        <label class="font-w600">Altura (cm)</label>
                        <input type="number" step="0.1" min="0" name="altura_cm" class="form-control" placeholder="Ej. 175">
                    </div>
                    <div class="form-group col-md-2">
                        <label class="font-w600">Peso (kg)</label>
                        <input type="number" step="0.1" min="0" name="peso_kg" class="form-control" placeholder="Ej. 72.5">
                    </div>
                </div>
                <div class="form-group">
                    <label class="font-w600">Alergias</label>
                    <textarea name="alergias" rows="2" class="form-control auto-grow" placeholder="Medicamentos, alimentos, etc."></textarea>
                </div>
                <div class="form-group">
                        <label class="font-w600">Patologías previas</label>
                        <textarea name="patologias_previas" rows="2" class="form-control auto-grow" placeholder="Diagnósticos relevantes"></textarea>
                </div>
                <div class="form-group">
                        <label class="font-w600">Antecedentes familiares</label>
                        <textarea name="antecedentes" rows="2" class="form-control auto-grow" placeholder="Enfermedades hereditarias o eventos importantes"></textarea>
                </div>
                <div class="form-group">
                        <label class="font-w600">Notas adicionales</label>
                        <textarea name="notas" rows="2" class="form-control auto-grow" placeholder="Observaciones rápidas"></textarea>
                </div>
                <div class="form-group d-flex flex-wrap align-items-center">
                    <div class="custom-control custom-switch mr-4 mb-2">
                        <input type="checkbox" class="custom-control-input" id="es_fumador" name="es_fumador">
                        <label class="custom-control-label" for="es_fumador">Fumador</label>
                    </div>
                    <div class="custom-control custom-switch mr-4 mb-2">
                        <input type="checkbox" class="custom-control-input" id="activo_sexualmente" name="activo_sexualmente">
                        <label class="custom-control-label" for="activo_sexualmente">Activo sexualmente</label>
                    </div>
                    <div class="custom-control custom-switch mb-2">
                        <input type="checkbox" class="custom-control-input" id="embarazo" name="embarazo">
                        <label class="custom-control-label" for="embarazo">Embarazo en curso</label>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap">
                    <button type="button" id="cancelar-edicion-paciente" class="btn btn-outline-secondary btn-sm d-none mb-2">
                        <i class="fa fa-times mr-1"></i>Cancelar edición
                    </button>
                    <div class="mb-2">
                        <button type="button" class="btn btn-outline-light mr-2" id="btn-hide-paciente-form">
                            <i class="fa fa-eye-slash mr-1"></i>Ocultar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-save mr-2"></i><span id="paciente-submit-label">Guardar ficha</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

{% elif active_section == 'situacion' %}
    <div class="block block-rounded mb-4">
        <div class="block-header block-header-default d-flex justify-content-between align-items-center">
            <div>
                <h3 class="block-title mb-0">
                    <i class="fa fa-stethoscope mr-2 text-success"></i>Registros clínicos y diagnóstico CIE-10
                </h3>
                <p class="text-muted mb-0 small">Explorá todos los registros cargados y filtrá por paciente, fecha o código.</p>
            </div>
            <div class="d-flex align-items-center">
                <a href="https://chatgpt.com/share/691628eb-6688-800e-9e69-d99b59febd7b" target="_blank" rel="noopener" class="btn btn-sm btn-outline-success mr-2">
                    <i class="fa fa-external-link-alt mr-1"></i>Guía situación actual
                </a>
                <a href="https://chatgpt.com/c/691629ba-92d0-8332-b530-d3f9d517e8b8" target="_blank" rel="noopener" class="btn btn-sm btn-outline-primary mr-3">
                    <i class="fa fa-external-link-alt mr-1"></i>Plantilla dimisión
                </a>
                <button type="button" class="btn btn-sm btn-success" id="btn-toggle-situacion-form">
                    <i class="fa fa-plus mr-1"></i>Nuevo registro
                </button>
            </div>
        </div>
        <div class="block-content">
            <form id="situacion-filtros-form" class="form-row align-items-end mb-4">
                <div class="form-group col-md-4">
                    <label class="font-w600">Paciente</label>
                    <select id="situacion-filtro-paciente" class="form-control">
                        <option value="">Todos los pacientes</option>
                    </select>
                </div>
                <div class="form-group col-md-3">
                    <label class="font-w600">Fecha desde</label>
                    <input type="date" id="situacion-filtro-desde" class="form-control">
                </div>
                <div class="form-group col-md-3">
                    <label class="font-w600">Fecha hasta</label>
                    <input type="date" id="situacion-filtro-hasta" class="form-control">
                </div>
                <div class="form-group col-md-4">
                    <label class="font-w600">Código o diagnóstico CIE-10</label>
                    <input type="text" id="situacion-filtro-cie10" class="form-control" placeholder="Ej. I10, diabetes">
                </div>
                <div class="form-group col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-outline-primary btn-block">
                        <i class="fa fa-filter mr-1"></i>Aplicar
                    </button>
                </div>
                <div class="form-group col-md-2 d-flex align-items-end">
                    <button type="button" id="situacion-filtros-reset" class="btn btn-outline-secondary btn-block">
                        <i class="fa fa-undo mr-1"></i>Limpiar
                    </button>
                </div>
            </form>

            <div id="situaciones-lista" class="row">
                <div class="col-12">
                    <div class="text-center text-muted py-4 border rounded">
                        Aún no registraste la situación clínica de este paciente.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="situacion-form-wrapper" class="block block-rounded mb-4 d-none">
        <div class="block-header block-header-default d-flex justify-content-between align-items-center">
            <h3 class="block-title mb-0">
                <i class="fa fa-notes-medical mr-2"></i>Registrar nueva situación clínica
            </h3>
            <button type="button" class="btn btn-sm btn-light" id="btn-close-situacion-form">
                <i class="fa fa-times mr-1"></i>Ocultar formulario
            </button>
        </div>
        <div class="block-content">
            <p class="text-muted">Resume el motivo de consulta, hallazgos, diagnóstico codificado y las indicaciones entregadas al paciente.</p>
            <form id="form-situacion" class="mb-4">
                <input type="hidden" id="situacion-id">
                <div class="form-group">
                    <label class="font-w600">Paciente *</label>
                    <select id="situacion-paciente" class="form-control" name="paciente_nombre" required>
                        <option value="" selected disabled>Selecciona o registra primero un paciente</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="font-w600">Tipo de consulta *</label>
                    <select id="situacion-tipo-consulta" name="tipo_consulta" class="form-control" required>
                        <option value="">Seleccionar...</option>
                        <option value="control">Control</option>
                        <option value="primera_consulta">Primera consulta</option>
                        <option value="seguimiento">Seguimiento</option>
                        <option value="teleconsulta">Teleconsulta</option>
                        <option value="urgencia">Urgencia</option>
                        <option value="otro">Otro</option>
                    </select>
                    <input type="text" id="tipo-consulta-personalizado" name="tipo_consulta_personalizada" class="form-control mt-2 d-none" placeholder="Describe el tipo de consulta">
                </div>

                <div class="mb-3">
                    <ul class="nav nav-pills nav-fill" id="situacion-form-tabs" role="tablist">
                        <li class="nav-item">
                            <button type="button" class="nav-link active" data-tab-target="form-tab-situacion">
                                <i class="fa fa-stethoscope mr-1"></i>Situación actual
                            </button>
                        </li>
                        <li class="nav-item">
                            <button type="button" class="nav-link" data-tab-target="form-tab-dimision">
                                <i class="fa fa-notes-medical mr-1"></i>Indicaciones & Dimisión
                            </button>
                        </li>
                    </ul>
                </div>

                <div class="tab-content border rounded p-3 mb-3">
                    <div id="form-tab-situacion" class="situacion-form-pane">
                        <div class="form-group">
                            <label class="font-w600">Motivo de consulta / Informe asociado</label>
                            <textarea name="motivo_consulta" rows="3" class="form-control auto-grow" placeholder="Ej. Control post laboratorio, seguimiento de síntomas, etc."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="font-w600">Historia de enfermedad actual</label>
                            <textarea name="historia_enfermedad_actual" rows="4" class="form-control auto-grow" placeholder="Secuencia cronológica de síntomas, tratamientos previos, respuestas y factores desencadenantes relevantes."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="font-w600">Antecedentes personales relevantes</label>
                            <textarea name="antecedentes_personales" rows="3" class="form-control auto-grow" placeholder="Comorbilidades, cirugías, hábitos, medicación crónica o eventos previos relacionados."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="font-w600 d-block">Agregar datos complementarios</label>
                            <div class="btn-group btn-group-sm mb-3" role="group" id="complementos-toggle">
                                <button type="button" class="btn btn-outline-secondary complemento-toggle" data-complemento="laboratorios">
                                    <i class="fa fa-vial mr-1"></i>Laboratorios
                                </button>
                                <button type="button" class="btn btn-outline-secondary complemento-toggle" data-complemento="estudios_complementarios">
                                    <i class="fa fa-microscope mr-1"></i>Estudios complementarios
                                </button>
                                <button type="button" class="btn btn-outline-secondary complemento-toggle" data-complemento="interconsultas">
                                    <i class="fa fa-user-md mr-1"></i>Interconsultas
                                </button>
                            </div>
                            <div class="complemento-section d-none" data-complemento-section="laboratorios">
                                <label class="font-w600">Laboratorios relevantes</label>
                                <textarea name="laboratorios" rows="3" class="form-control auto-grow" placeholder="Últimos resultados, fechas y hallazgos clave."></textarea>
                            </div>
                            <div class="complemento-section d-none" data-complemento-section="estudios_complementarios">
                                <label class="font-w600">Estudios complementarios / imágenes</label>
                                <textarea name="estudios_complementarios" rows="3" class="form-control auto-grow" placeholder="Imágenes, pruebas funcionales, etc."></textarea>
                            </div>
                            <div class="complemento-section d-none" data-complemento-section="interconsultas">
                                <label class="font-w600">Interconsultas</label>
                                <textarea name="interconsultas" rows="3" class="form-control auto-grow" placeholder="Especialidades consultadas, recomendaciones recibidas y fechas."></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="font-w600">Resumen de situación actual</label>
                            <textarea name="situacion_actual" rows="4" class="form-control auto-grow" placeholder="Hallazgos relevantes, resumen de informes y evolución"></textarea>
                        </div>
                                <div class="form-group">
                                    <label class="font-w600">Diagnósticos (CIE-10)</label>
                                    <div class="cie10-wrapper border rounded p-2">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small class="text-muted">Seleccioná uno o más diagnósticos y marcá con ⭐ el principal.</small>
                                            <small class="text-muted">Enter agrega el texto escrito.</small>
                                        </div>
                                        <div id="cie10-tags" class="mb-2"></div>
                                        <input type="text" id="cie10-input" class="form-control" placeholder="Buscar por código o diagnóstico...">
                                        <div id="cie10-suggestions" class="list-group mt-2 d-none"></div>
                                    </div>
                                </div>
                    </div>

                    <div id="form-tab-dimision" class="situacion-form-pane d-none">
                        <div class="form-group">
                            <label class="font-w600">Informe de dimisión / epicrisis</label>
                            <textarea name="informe_dimision" rows="3" class="form-control auto-grow" placeholder="Resumen que se entrega al alta o derivación"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="font-w600">Tratamiento farmacológico</label>
                            <textarea name="tratamiento_farmacologico" rows="3" class="form-control auto-grow" placeholder="Dosis, frecuencia, ajustes y consideraciones especiales."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="font-w600">Medidas no farmacológicas y cambios de estilo de vida</label>
                            <textarea name="medidas_estilo_vida" rows="3" class="form-control auto-grow" placeholder="Actividad física, alimentación, salud mental, control del estrés, descanso, etc."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="font-w600">Signos de alarma</label>
                            <textarea name="signos_alarma" rows="3" class="form-control auto-grow" placeholder="Situaciones que requieren consulta urgente y cómo proceder."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="font-w600">Próximos controles y seguimiento</label>
                            <textarea name="proximos_controles" rows="3" class="form-control auto-grow" placeholder="Fechas tentativas, especialidades involucradas, modalidades (presencial, telemedicina) y objetivos."></textarea>
                        </div>
                    </div>
                </div>

                <div class="text-right">
                    <button type="button" id="cancelar-edicion-situacion" class="btn btn-outline-secondary mr-2 d-none">
                        Cancelar edición
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fa fa-clipboard-check mr-2"></i>Guardar situación
                    </button>
                </div>
            </form>
        </div>
    </div>

{% elif active_section == 'documentos' %}
    <div class="block block-rounded mb-4">
        <div class="block-header block-header-default d-flex justify-content-between align-items-center">
            <div>
                <h3 class="block-title mb-0">
                    <i class="fa fa-folder-plus mr-2 text-info"></i>Documentos y archivos clínicos
                </h3>
                <p class="text-muted mb-0 small">Arrastrá los estudios o informes para guardarlos en Google Drive y encontrarlos por paciente, fecha o tipo.</p>
            </div>
            <div class="d-flex align-items-center">
                <button type="button" class="btn btn-sm btn-light mr-2" id="documentos-refresh-btn">
                    <i class="fa fa-sync mr-1"></i>Actualizar lista
                </button>
                <button type="button" class="btn btn-sm btn-info" id="btn-toggle-documento-form">
                    <i class="fa fa-cloud-upload-alt mr-1"></i>Nuevo estudio
                </button>
            </div>
        </div>
        <div class="block-content">
            <p class="text-muted">Organiza estudios, laboratorios e informes compartidos desde Google Drive. Usa los filtros para encontrar documentos específicos.</p>
            {% if not drive_ready %}
            <div class="alert alert-warning d-flex align-items-center">
                <i class="fa fa-exclamation-triangle mr-2"></i>
                <div>Falta configurar las credenciales de Google Drive. Guarda el archivo de servicio en <code>config/google-service-account.json</code> o define <code>GOOGLE_APPLICATION_CREDENTIALS</code> para habilitar las subidas automáticas.</div>
            </div>
            {% endif %}
            <form id="documentos-filtros-form" class="form-row align-items-end mb-4">
                <div class="form-group col-md-3">
                    <label class="font-w600">Paciente</label>
                    <select id="documentos-filtro-paciente" class="form-control">
                        <option value="">Todos los pacientes</option>
                    </select>
                </div>
                <div class="form-group col-md-2">
                    <label class="font-w600">Tipo</label>
                    <select id="documentos-filtro-tipo" class="form-control">
                        <option value="">Todos los tipos</option>
                        <option value="laboratorio">Laboratorio</option>
                        <option value="imagen">Estudios de imágenes</option>
                        <option value="informe">Informes</option>
                        <option value="receta">Recetas / Prescripciones</option>
                        <option value="otros">Otros</option>
                    </select>
                </div>
                <div class="form-group col-md-2">
                    <label class="font-w600">Fecha desde</label>
                    <input type="date" id="documentos-filtro-desde" class="form-control">
                </div>
                <div class="form-group col-md-2">
                    <label class="font-w600">Fecha hasta</label>
                    <input type="date" id="documentos-filtro-hasta" class="form-control">
                </div>
                <div class="form-group col-md-3">
                    <label class="font-w600">Buscar</label>
                    <input type="text" id="documentos-filtro-search" class="form-control" placeholder="Descripción, etiqueta o paciente">
                </div>
                <div class="form-group col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-outline-info btn-block">
                        <i class="fa fa-filter mr-1"></i>Aplicar
                    </button>
                </div>
                <div class="form-group col-md-2 d-flex align-items-end">
                    <button type="button" id="documentos-filtros-reset" class="btn btn-outline-secondary btn-block">
                        <i class="fa fa-undo mr-1"></i>Limpiar
                    </button>
                </div>
            </form>
            <div id="documentos-grid" class="row">
                <div class="col-12">
                    <div class="text-center text-muted py-4 border rounded">
                        Todavía no hay archivos registrados para este paciente.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="documentos-form-wrapper" class="block block-rounded mb-5 d-none">
        <div class="block-header block-header-default d-flex justify-content-between align-items-center">
            <h3 class="block-title mb-0">
                <i class="fa fa-cloud-upload-alt mr-2 text-info"></i>Nueva carga de documentos
            </h3>
            <button type="button" class="btn btn-sm btn-light" id="btn-close-documento-form">
                <i class="fa fa-times mr-1"></i>Ocultar formulario
            </button>
        </div>
        <div class="block-content">
            <div class="row">
                <div class="col-lg-4">
                    <div class="form-group">
                        <label class="font-w600">Paciente *</label>
                        <select name="paciente_nombre" id="documento-paciente" class="form-control" required>
                            <option value="" selected disabled>Selecciona un paciente registrado</option>
                        </select>
                        <small class="form-text text-muted">Necesitamos saber a quién pertenece el documento.</small>
                    </div>
                    <div class="form-group">
                        <label class="font-w600">Tipo *</label>
                        <select name="tipo_documento" id="documento-tipo" class="form-control" required>
                            <option value="laboratorio">Laboratorio</option>
                            <option value="imagen">Estudio de imágenes</option>
                            <option value="informe">Informe extra</option>
                            <option value="receta">Receta / Prescripción</option>
                            <option value="otros">Otros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="font-w600">Fecha del estudio</label>
                        <input type="date" name="fecha_documento" id="documento-fecha" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="font-w600">Descripción breve</label>
                        <input type="text" name="descripcion" id="documento-descripcion" class="form-control" placeholder="Perfil lipídico, RX tórax...">
                    </div>
                    <div class="form-group">
                        <label class="font-w600">Etiquetas</label>
                        <input type="text" name="etiquetas" id="documento-etiquetas" class="form-control" placeholder="Ej. control, RX, cardio">
                        <small class="form-text text-muted">Separalas con coma para agrupar rápido.</small>
                    </div>
                    <div class="form-group">
                        <label class="font-w600">Notas internas</label>
                        <textarea id="documento-notas" class="form-control auto-grow" rows="2" placeholder="Indicaciones, recordatorios, etc."></textarea>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div id="documentos-dropzone" class="telemed-dropzone{% if not drive_ready %} disabled{% endif %}" data-drive-ready="{{ 'true' if drive_ready else 'false' }}">
                        <i class="fa fa-cloud-upload-alt fa-2x text-info mb-2"></i>
                        <p class="font-w600 mb-1">Arrastrá y soltá los archivos aquí</p>
                        <p class="text-muted mb-3">Aceptamos PDF, imágenes y otros formatos habituales. También podés hacer clic para buscarlos manualmente.</p>
                        <button type="button" class="btn btn-outline-info btn-sm" id="documentos-browse-btn">
                            <i class="fa fa-folder-open mr-1"></i>Seleccionar archivos
                        </button>
                        <input type="file" id="documentos-file-input" multiple class="d-none" accept="*/*">
                    </div>
                    <div id="documentos-upload-list" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

{% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
const TELEMED_PACIENTES_BASE = {{ lista_pacientes | tojson }};
const ACTIVE_SECTION = '{{ active_section }}';
const PACIENTE_INICIAL = {{ paciente_preseleccionado | tojson }};
const DRIVE_READY = {{ drive_ready | tojson }};
const INITIAL_FILTERS = {{ filtros_iniciales | tojson }};

const fichaForm = document.getElementById('form-datos-paciente');
const pacienteIdInput = document.getElementById('paciente-id');
const cancelarEdicionBtn = document.getElementById('cancelar-edicion-paciente');
const pacienteSubmitLabel = document.getElementById('paciente-submit-label');
const situacionForm = document.getElementById('form-situacion');
const situacionIdInput = document.getElementById('situacion-id');
const cancelarEdicionSituacionBtn = document.getElementById('cancelar-edicion-situacion');
const tipoConsultaSelect = document.getElementById('situacion-tipo-consulta');
const tipoConsultaPersonalizado = document.getElementById('tipo-consulta-personalizado');
const cie10Input = document.getElementById('cie10-input');
const cie10Suggestions = document.getElementById('cie10-suggestions');
const cie10Tags = document.getElementById('cie10-tags');
const situacionSubmitBtn = situacionForm ? situacionForm.querySelector('button[type="submit"]') : null;
const situacionFormTabButtons = document.querySelectorAll('#situacion-form-tabs button[data-tab-target]');
const situacionFormTabPanels = {};
situacionFormTabButtons.forEach(btn => {
    const targetId = btn.dataset.tabTarget;
    const panel = document.getElementById(targetId);
    if (panel) situacionFormTabPanels[targetId] = panel;
});
const pacienteSearchInput = document.getElementById('pacientes-search');
const pacienteListPanel = document.getElementById('pacientes-list-panel');
const pacienteListEmpty = document.getElementById('pacientes-empty-panel');
const pacienteDetallePlaceholder = document.getElementById('paciente-detalle-placeholder');
const pacienteDetalleInfo = document.getElementById('paciente-detalle-info');
const pacienteDetalleNombre = document.getElementById('paciente-detalle-nombre');
const pacienteDetalleIdentificador = document.getElementById('paciente-detalle-identificador');
const pacienteDetalleMetadata = document.getElementById('paciente-detalle-metadata');
const pacienteDetalleDocs = document.getElementById('paciente-detalle-registros-documentos');
const pacienteDetalleSituaciones = document.getElementById('paciente-detalle-registros-situaciones');
const pacienteDetalleUltima = document.getElementById('paciente-detalle-ultima-actualizacion');
const pacienteDetalleEditarBtn = document.getElementById('paciente-detalle-editar-btn');
const pacienteDetalleDocumentosBtn = document.getElementById('paciente-detalle-documentos-btn');
const pacienteDetalleVerDocs = document.getElementById('detalle-ver-documentos');
const pacienteDetalleVerSituacion = document.getElementById('detalle-ver-situaciones');
const documentoPacienteSelect = document.getElementById('documento-paciente');
const documentoTipoSelect = document.getElementById('documento-tipo');
const documentoFechaInput = document.getElementById('documento-fecha');
const documentoDescripcionInput = document.getElementById('documento-descripcion');
const documentoEtiquetasInput = document.getElementById('documento-etiquetas');
const documentoNotasInput = document.getElementById('documento-notas');
const pacienteFormContainer = document.getElementById('paciente-form-container');
const btnTogglePacienteForm = document.getElementById('btn-toggle-paciente-form');
const btnClosePacienteForm = document.getElementById('btn-close-paciente-form');
const btnHidePacienteForm = document.getElementById('btn-hide-paciente-form');
const situacionFormWrapper = document.getElementById('situacion-form-wrapper');
const btnToggleSituacionForm = document.getElementById('btn-toggle-situacion-form');
const btnCloseSituacionForm = document.getElementById('btn-close-situacion-form');
const situacionFiltrosForm = document.getElementById('situacion-filtros-form');
const situacionFiltrosReset = document.getElementById('situacion-filtros-reset');
const situacionFiltroPaciente = document.getElementById('situacion-filtro-paciente');
const situacionFiltroDesde = document.getElementById('situacion-filtro-desde');
const situacionFiltroHasta = document.getElementById('situacion-filtro-hasta');
const situacionFiltroCie10 = document.getElementById('situacion-filtro-cie10');
const documentosDropzone = document.getElementById('documentos-dropzone');
const documentosFileInput = document.getElementById('documentos-file-input');
const documentosBrowseBtn = document.getElementById('documentos-browse-btn');
const documentosUploadList = document.getElementById('documentos-upload-list');
const documentosRefreshBtn = document.getElementById('documentos-refresh-btn');
const documentosFormWrapper = document.getElementById('documentos-form-wrapper');
const btnToggleDocumentoForm = document.getElementById('btn-toggle-documento-form');
const btnCloseDocumentoForm = document.getElementById('btn-close-documento-form');
const documentosFiltrosForm = document.getElementById('documentos-filtros-form');
const documentosFiltrosReset = document.getElementById('documentos-filtros-reset');
const documentosFiltroPaciente = document.getElementById('documentos-filtro-paciente');
const documentosFiltroTipo = document.getElementById('documentos-filtro-tipo');
const documentosFiltroDesde = document.getElementById('documentos-filtro-desde');
const documentosFiltroHasta = document.getElementById('documentos-filtro-hasta');
const documentosFiltroSearch = document.getElementById('documentos-filtro-search');
const COMPLEMENTO_FIELDS = ['laboratorios', 'estudios_complementarios', 'interconsultas'];

const CIE10_DATA_URL = 'https://raw.githubusercontent.com/cayasso/cie10/master/cie10-array.json';
let cie10CatalogPromise = null;
let cie10Catalogo = [];

const TELEMED_STATE = {
    pacientes: [],
    situaciones: [],
    documentos: [],
    pacienteActivo: PACIENTE_INICIAL || '',
    cie10Diagnosticos: [],
    editingPacienteId: null,
    editingSituacionId: null
};

const PACIENTE_REGISTROS_CACHE = {
    documentos: new Map(),
    situaciones: new Map()
};

let pacienteSearchTerm = '';
const SITUACION_FILTROS_INICIALES = (INITIAL_FILTERS && INITIAL_FILTERS.situacion) ? INITIAL_FILTERS.situacion : {};
const DOCUMENTOS_FILTROS_INICIALES = (INITIAL_FILTERS && INITIAL_FILTERS.documentos) ? INITIAL_FILTERS.documentos : {};
const SITUACION_FILTROS = {
    paciente: (SITUACION_FILTROS_INICIALES.paciente || PACIENTE_INICIAL || '').trim(),
    desde: SITUACION_FILTROS_INICIALES.desde || '',
    hasta: SITUACION_FILTROS_INICIALES.hasta || '',
    cie10: SITUACION_FILTROS_INICIALES.cie10 || ''
};
const DOCUMENTOS_FILTROS = {
    paciente: (DOCUMENTOS_FILTROS_INICIALES.paciente || PACIENTE_INICIAL || '').trim(),
    desde: DOCUMENTOS_FILTROS_INICIALES.desde || '',
    hasta: DOCUMENTOS_FILTROS_INICIALES.hasta || '',
    tipo: (DOCUMENTOS_FILTROS_INICIALES.tipo || '').toLowerCase(),
    search: DOCUMENTOS_FILTROS_INICIALES.search || ''
};
const DOCUMENT_UPLOAD_ITEMS = new Map();

let cie10SearchTimeout = null;

function normalizarTexto(value) {
    return (value || '')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .trim();
}

async function cargarCatalogoCIE10() {
    if (cie10Catalogo.length) return cie10Catalogo;
    if (!cie10CatalogPromise) {
        cie10CatalogPromise = fetch(CIE10_DATA_URL, { cache: 'force-cache' })
            .then(response => {
                if (!response.ok) throw new Error('Respuesta inválida del catálogo CIE-10');
                return response.json();
            })
            .then(data => {
                if (!Array.isArray(data)) return [];
                cie10Catalogo = data.map(entry => ({
                    code: entry.c,
                    name: entry.d,
                    normalized: normalizarTexto(`${entry.c} ${entry.d}`)
                }));
                return cie10Catalogo;
            })
            .catch(error => {
                console.warn('No se pudo cargar el catálogo CIE-10 en español', error);
                cie10Catalogo = [];
                return [];
            });
    }
    return cie10CatalogPromise;
}

async function buscarCIE10DesdeAPI(term) {
    const url = `https://clinicaltables.nlm.nih.gov/api/icd10cm/v3/search?sf=code,name&terms=${encodeURIComponent(term)}&maxList=20`;
    const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
    const data = await response.json();
    const detalles = Array.isArray(data)
        ? (Array.isArray(data[3]) ? data[3] : (Array.isArray(data[2]) ? data[2] : []))
        : [];
    return detalles
        .filter(entry => Array.isArray(entry) && entry.length >= 2)
        .map(entry => ({ code: entry[0], name: entry[1] }));
}

async function buscarCIE10(term) {
    const filtro = normalizarTexto(term);
    if (!filtro) return [];
    try {
        const catalogo = await cargarCatalogoCIE10();
        if (catalogo.length) {
            return catalogo
                .filter(entry => entry.normalized.includes(filtro))
                .slice(0, 20)
                .map(entry => ({ code: entry.code, name: entry.name }));
        }
    } catch (error) {
        console.warn('Búsqueda local de CIE-10 falló, usando API externa', error);
    }
    return buscarCIE10DesdeAPI(term);
}

function showTelemedAlert(type, message) {
    const wrapper = document.getElementById('telemed-alerts');
    if (!wrapper) return;
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        <span>${message}</span>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>`;
    wrapper.appendChild(alert);
    setTimeout(() => {
        alert.classList.remove('show');
        setTimeout(() => alert.remove(), 150);
    }, 6000);
}

function autoGrowTextarea(textarea) {
    if (!textarea) return;
    textarea.style.height = 'auto';
    textarea.style.height = `${textarea.scrollHeight}px`;
}

function refreshAutoGrow() {
    document.querySelectorAll('textarea.auto-grow').forEach(textarea => {
        const handler = () => autoGrowTextarea(textarea);
        textarea.removeEventListener('input', textarea.__autoGrowHandler || (() => {}));
        textarea.__autoGrowHandler = handler;
        textarea.addEventListener('input', handler);
        autoGrowTextarea(textarea);
    });
}

function formatDateTime(value) {
    if (!value) return '—';
    const parsed = new Date(value.replace(' ', 'T'));
    return Number.isNaN(parsed.getTime()) ? value : parsed.toLocaleString('es-AR');
}

function formatDateOnly(value) {
    if (!value) return '—';
    const parsed = new Date(value);
    return Number.isNaN(parsed.getTime()) ? value : parsed.toLocaleDateString('es-AR');
}

function formatFileSize(bytes) {
    if (bytes === null || bytes === undefined) return '—';
    let valor = Number(bytes);
    if (Number.isNaN(valor)) return '—';
    const unidades = ['B', 'KB', 'MB', 'GB', 'TB'];
    let idx = 0;
    while (valor >= 1024 && idx < unidades.length - 1) {
        valor /= 1024;
        idx += 1;
    }
    const decimales = idx === 0 ? 0 : 1;
    return `${valor.toFixed(decimales)} ${unidades[idx]}`;
}

function setPacienteFormVisible(visible) {
    if (!pacienteFormContainer) return;
    const show = Boolean(visible);
    pacienteFormContainer.classList.toggle('d-none', !show);
    if (btnTogglePacienteForm) {
        btnTogglePacienteForm.classList.toggle('btn-outline-primary', show);
        btnTogglePacienteForm.innerHTML = show
            ? '<i class="fa fa-eye-slash mr-1"></i>Ocultar formulario'
            : '<i class="fa fa-user-plus mr-1"></i>Nuevo paciente';
    }
}

function setSituacionFormVisible(visible) {
    if (!situacionFormWrapper) return;
    const show = Boolean(visible);
    situacionFormWrapper.classList.toggle('d-none', !show);
    if (btnToggleSituacionForm) {
        btnToggleSituacionForm.classList.toggle('btn-outline-success', show);
        btnToggleSituacionForm.innerHTML = show
            ? '<i class="fa fa-eye-slash mr-1"></i>Ocultar formulario'
            : '<i class="fa fa-plus mr-1"></i>Nuevo registro';
    }
    if (show && situacionForm) {
        situacionForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function setDocumentoFormVisible(visible) {
    if (!documentosFormWrapper) return;
    const show = Boolean(visible);
    documentosFormWrapper.classList.toggle('d-none', !show);
    if (btnToggleDocumentoForm) {
        btnToggleDocumentoForm.classList.toggle('btn-outline-info', show);
        btnToggleDocumentoForm.innerHTML = show
            ? '<i class="fa fa-eye-slash mr-1"></i>Ocultar formulario'
            : '<i class="fa fa-cloud-upload-alt mr-1"></i>Nuevo estudio';
    }
    if (show && documentosFormWrapper) {
        documentosFormWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function syncSituacionFilterInputs() {
    if (situacionFiltroPaciente) situacionFiltroPaciente.value = SITUACION_FILTROS.paciente || '';
    if (situacionFiltroDesde) situacionFiltroDesde.value = SITUACION_FILTROS.desde || '';
    if (situacionFiltroHasta) situacionFiltroHasta.value = SITUACION_FILTROS.hasta || '';
    if (situacionFiltroCie10) situacionFiltroCie10.value = SITUACION_FILTROS.cie10 || '';
}

function syncDocumentosFilterInputs() {
    if (documentosFiltroPaciente) documentosFiltroPaciente.value = DOCUMENTOS_FILTROS.paciente || '';
    if (documentosFiltroTipo) documentosFiltroTipo.value = DOCUMENTOS_FILTROS.tipo || '';
    if (documentosFiltroDesde) documentosFiltroDesde.value = DOCUMENTOS_FILTROS.desde || '';
    if (documentosFiltroHasta) documentosFiltroHasta.value = DOCUMENTOS_FILTROS.hasta || '';
    if (documentosFiltroSearch) documentosFiltroSearch.value = DOCUMENTOS_FILTROS.search || '';
}

function resolveEdad(paciente) {
    if (typeof paciente?.edad_calculada === 'number') return paciente.edad_calculada;
    if (typeof paciente?.edad === 'number') return paciente.edad;
    return null;
}

function formatDocumento(paciente) {
    const partes = [];
    if (paciente.documento_tipo) partes.push(paciente.documento_tipo);
    if (paciente.paciente_dni) partes.push(paciente.paciente_dni);
    else if (paciente.documento) partes.push(paciente.documento);
    return partes.length ? partes.join(' - ') : '—';
}

function nombreCompleto(paciente) {
    return obtenerNombrePaciente(paciente);
}

function uniquePacientes() {
    const nombres = new Set(TELEMED_PACIENTES_BASE || []);
    TELEMED_STATE.pacientes.forEach(p => {
        const fullName = nombreCompleto(p);
        if (fullName) nombres.add(fullName);
    });
    return Array.from(nombres).sort();
}

function resetPacienteForm() {
    if (!fichaForm) return;
    fichaForm.reset();
    if (pacienteIdInput) pacienteIdInput.value = '';
    TELEMED_STATE.editingPacienteId = null;
    if (pacienteSubmitLabel) pacienteSubmitLabel.textContent = 'Guardar ficha';
    if (cancelarEdicionBtn) cancelarEdicionBtn.classList.add('d-none');
    refreshAutoGrow();
}

function setSituacionFormTab(targetId) {
    if (!targetId) return;
    situacionFormTabButtons.forEach(btn => {
        if (btn.dataset.tabTarget === targetId) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    Object.entries(situacionFormTabPanels).forEach(([id, panel]) => {
        if (id === targetId) {
            panel.classList.remove('d-none');
        } else {
            panel.classList.add('d-none');
        }
    });
}

function getComplementoElements(field) {
    return {
        button: document.querySelector(`.complemento-toggle[data-complemento="${field}"]`),
        section: document.querySelector(`[data-complemento-section="${field}"]`)
    };
}

function setComplementoActive(field, active, { clear = false } = {}) {
    const { button, section } = getComplementoElements(field);
    if (!button || !section) return;
    if (active) {
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-secondary');
        section.classList.remove('d-none');
    } else {
        button.classList.add('btn-outline-secondary');
        button.classList.remove('btn-secondary');
        section.classList.add('d-none');
        if (clear) {
            const textarea = section.querySelector('textarea');
            if (textarea) textarea.value = '';
        }
    }
}

function isComplementoActive(field) {
    const { button } = getComplementoElements(field);
    return !!(button && button.classList.contains('btn-secondary'));
}

function resetComplementos() {
    COMPLEMENTO_FIELDS.forEach(field => setComplementoActive(field, false, { clear: true }));
}

function updateSituacionSubmitButton() {
    if (!situacionSubmitBtn) return;
    if (TELEMED_STATE.editingSituacionId) {
        situacionSubmitBtn.innerHTML = '<i class="fa fa-save mr-2"></i>Actualizar situación';
    } else {
        situacionSubmitBtn.innerHTML = '<i class="fa fa-clipboard-check mr-2"></i>Guardar situación';
    }
}

function resetSituacionForm(pacienteSeleccionado = '') {
    if (!situacionForm) return;
    situacionForm.reset();
    if (situacionIdInput) situacionIdInput.value = '';
    TELEMED_STATE.editingSituacionId = null;
    if (cancelarEdicionSituacionBtn) cancelarEdicionSituacionBtn.classList.add('d-none');
    if (tipoConsultaPersonalizado) {
        tipoConsultaPersonalizado.value = '';
        tipoConsultaPersonalizado.classList.add('d-none');
    }
    resetCIE10State();
    resetComplementos();
    refreshAutoGrow();
    updateSituacionSubmitButton();
    setSituacionFormTab('form-tab-situacion');
    if (pacienteSeleccionado && situacionForm.paciente_nombre) {
        situacionForm.paciente_nombre.value = pacienteSeleccionado;
    }
}

function getSituacionById(id) {
    if (!id) return null;
    const numericId = Number(id);
    return TELEMED_STATE.situaciones.find(item => Number(item.id) === numericId) || null;
}

function startSituacionEditing(situacion) {
    if (!situacionForm || !situacion) return;
    setSituacionFormVisible(true);
    TELEMED_STATE.editingSituacionId = situacion.id;
    TELEMED_STATE.pacienteActivo = situacion.paciente_nombre || TELEMED_STATE.pacienteActivo;
    if (situacionIdInput) situacionIdInput.value = situacion.id;
    if (cancelarEdicionSituacionBtn) cancelarEdicionSituacionBtn.classList.remove('d-none');

    if (situacionForm.paciente_nombre) {
        const value = situacion.paciente_nombre || '';
        if (value) {
            let option = Array.from(situacionForm.paciente_nombre.options).find(opt => opt.value === value);
            if (!option) {
                option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                situacionForm.paciente_nombre.appendChild(option);
            }
            situacionForm.paciente_nombre.value = value;
        }
    }

    if (tipoConsultaSelect) {
        tipoConsultaSelect.value = situacion.tipo_consulta || '';
        tipoConsultaSelect.dispatchEvent(new Event('change'));
    }
    if (tipoConsultaPersonalizado) {
        tipoConsultaPersonalizado.value = situacion.tipo_consulta_personalizada || '';
        if (tipoConsultaSelect && tipoConsultaSelect.value === 'otro') {
            tipoConsultaPersonalizado.classList.remove('d-none');
        }
    }

    const camposTexto = [
        'motivo_consulta',
        'historia_enfermedad_actual',
        'antecedentes_personales',
        'laboratorios',
        'estudios_complementarios',
        'interconsultas',
        'situacion_actual',
        'tratamiento_farmacologico',
        'medidas_estilo_vida',
        'signos_alarma',
        'proximos_controles',
        'informe_dimision'
    ];
    camposTexto.forEach(nombre => {
        if (situacionForm[nombre] !== undefined) {
            situacionForm[nombre].value = situacion[nombre] || '';
        }
        if (COMPLEMENTO_FIELDS.includes(nombre)) {
            const tieneValor = Boolean((situacion[nombre] || '').trim());
            setComplementoActive(nombre, tieneValor, { clear: !tieneValor });
        }
    });

    TELEMED_STATE.cie10Diagnosticos = normalizarDiagnosticosLista(situacion.diagnostico_cie10).map(item => ({
        code: item.code,
        name: item.name,
        principal: !!item.principal
    }));
    renderCIE10Tags();
    if (cie10Input) cie10Input.value = '';
    if (cie10Suggestions) cie10Suggestions.classList.add('d-none');
    refreshAutoGrow();
    updateSituacionSubmitButton();
    setSituacionFormTab('form-tab-situacion');
    showTelemedAlert('info', 'Editando la situación seleccionada.');
}

function startPacienteEditing(paciente) {
    if (!fichaForm) return;
    setPacienteFormVisible(true);
    fichaForm.nombre.value = paciente.nombre || '';
    fichaForm.apellido.value = paciente.apellido || '';
    if (fichaForm.fecha_nacimiento) {
        const fecha = (paciente.fecha_nacimiento || '').split('T')[0] || (paciente.fecha_nacimiento || '').split(' ')[0] || '';
        fichaForm.fecha_nacimiento.value = fecha;
    }
    if (fichaForm.documento_tipo) fichaForm.documento_tipo.value = paciente.documento_tipo || '';
    fichaForm.paciente_dni.value = paciente.paciente_dni || '';
    fichaForm.documento.value = paciente.documento || '';
    fichaForm.telefono.value = paciente.telefono || '';
    fichaForm.altura_cm.value = paciente.altura_cm ?? '';
    fichaForm.peso_kg.value = paciente.peso_kg ?? '';
    fichaForm.alergias.value = paciente.alergias || '';
    fichaForm.patologias_previas.value = paciente.patologias_previas || '';
    fichaForm.antecedentes.value = paciente.antecedentes || '';
    fichaForm.notas.value = paciente.notas || '';
    fichaForm.es_fumador.checked = Boolean(paciente.es_fumador);
    fichaForm.activo_sexualmente.checked = Boolean(paciente.activo_sexualmente);
    fichaForm.embarazo.checked = Boolean(paciente.embarazo);
    if (pacienteIdInput) pacienteIdInput.value = paciente.id || '';
    TELEMED_STATE.editingPacienteId = paciente.id || null;
    if (pacienteSubmitLabel) pacienteSubmitLabel.textContent = 'Actualizar ficha';
    if (cancelarEdicionBtn) cancelarEdicionBtn.classList.remove('d-none');
    const fullName = paciente.paciente_nombre || [paciente.nombre, paciente.apellido].filter(Boolean).join(' ');
    TELEMED_STATE.pacienteActivo = fullName;
    refreshAutoGrow();
    fichaForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function renderPacientesTable() {
    if (!pacienteListPanel) return;
    pacienteListPanel.innerHTML = '';
    const registros = filtrarPacientesPorBusqueda();
    if (!registros.length) {
        if (pacienteListEmpty) {
            pacienteListEmpty.classList.remove('d-none');
            pacienteListPanel.appendChild(pacienteListEmpty);
        }
        return;
    }

    if (pacienteListEmpty) {
        pacienteListEmpty.classList.add('d-none');
    }

    registros.forEach(paciente => {
        const item = document.createElement('button');
        item.type = 'button';
        item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
        const fullName = obtenerNombrePaciente(paciente);
        if (fullName && TELEMED_STATE.pacienteActivo === fullName) {
            item.classList.add('active');
        }
        const edad = resolveEdad(paciente);
        const edadTexto = typeof edad === 'number' ? `${edad} años` : '—';
        item.innerHTML = `
            <div>
                <div class="font-w600">${fullName || 'Paciente sin nombre'}</div>
                <small class="text-muted">${formatDocumento(paciente)}</small>
            </div>
            <div class="text-right">
                <div class="small">${edadTexto}</div>
                <small class="text-muted">${formatDateTime(paciente.fecha_registro)}</small>
            </div>
        `;
        item.addEventListener('click', () => seleccionarPaciente(fullName));
        pacienteListPanel.appendChild(item);
    });
}

function buildSectionUrl(basePath, pacienteNombre) {
    if (!basePath) return '#';
    try {
        const url = new URL(basePath, window.location.origin);
        if (pacienteNombre) {
            url.searchParams.set('paciente', pacienteNombre);
        }
        return `${url.pathname}${url.search}`;
    } catch (error) {
        return basePath;
    }
}

function renderDetalleMeta(label, value) {
    return `<dt>${label}</dt><dd>${value || '—'}</dd>`;
}

function renderPacienteDetalle(nombre) {
    if (!pacienteDetalleInfo || !pacienteDetallePlaceholder) return;
    const paciente = buscarPacientePorNombre(nombre);
    if (!paciente) {
        pacienteDetalleInfo.classList.add('d-none');
        pacienteDetallePlaceholder.classList.remove('d-none');
        if (pacienteDetalleDocs) pacienteDetalleDocs.textContent = 'Selecciona un paciente para ver los documentos.';
        if (pacienteDetalleSituaciones) pacienteDetalleSituaciones.textContent = 'Selecciona un paciente para ver la situación actual.';
        return;
    }

    pacienteDetallePlaceholder.classList.add('d-none');
    pacienteDetalleInfo.classList.remove('d-none');
    const fullName = obtenerNombrePaciente(paciente);
    if (fullName) {
        SITUACION_FILTROS.paciente = fullName;
        DOCUMENTOS_FILTROS.paciente = fullName;
        syncSituacionFilterInputs();
        syncDocumentosFilterInputs();
    }
    if (pacienteDetalleNombre) pacienteDetalleNombre.textContent = fullName || 'Paciente sin nombre';
    if (pacienteDetalleIdentificador) pacienteDetalleIdentificador.textContent = formatDocumento(paciente);
    if (pacienteDetalleUltima) pacienteDetalleUltima.textContent = formatDateTime(paciente.fecha_registro);
    if (pacienteDetalleMetadata) {
        const edadValor = resolveEdad(paciente);
        const edadTexto = typeof edadValor === 'number' ? `${edadValor} años` : '—';
        pacienteDetalleMetadata.innerHTML = [
            renderDetalleMeta('Fecha de nacimiento', formatDateOnly(paciente.fecha_nacimiento)),
            renderDetalleMeta('Edad', edadTexto),
            renderDetalleMeta('Teléfono', paciente.telefono || '—'),
            renderDetalleMeta('Peso', paciente.peso_kg ? `${paciente.peso_kg} kg` : '—'),
            renderDetalleMeta('Altura', paciente.altura_cm ? `${paciente.altura_cm} cm` : '—'),
            renderDetalleMeta('Alergias', paciente.alergias || '—')
        ].join('');
    }
    if (pacienteDetalleEditarBtn) {
        pacienteDetalleEditarBtn.onclick = () => startPacienteEditing(paciente);
    }
    if (pacienteDetalleDocumentosBtn) {
        const baseUrl = pacienteDetalleDocumentosBtn.dataset.baseUrl || pacienteDetalleDocumentosBtn.getAttribute('href');
        pacienteDetalleDocumentosBtn.setAttribute('href', buildSectionUrl(baseUrl, fullName));
    }
    if (pacienteDetalleVerDocs) {
        pacienteDetalleVerDocs.setAttribute('href', buildSectionUrl(pacienteDetalleVerDocs.dataset.baseUrl || pacienteDetalleVerDocs.getAttribute('href'), fullName));
    }
    if (pacienteDetalleVerSituacion) {
        pacienteDetalleVerSituacion.setAttribute('href', buildSectionUrl(pacienteDetalleVerSituacion.dataset.baseUrl || pacienteDetalleVerSituacion.getAttribute('href'), fullName));
    }
    renderPacienteDetalleRegistros(fullName);
}

function renderPacienteDetalleRegistros(nombre, options = {}) {
    if (!pacienteDetalleDocs || !pacienteDetalleSituaciones) return;
    if (!nombre) {
        pacienteDetalleDocs.textContent = 'Selecciona un paciente para ver los documentos.';
        pacienteDetalleSituaciones.textContent = 'Selecciona un paciente para ver la situación actual.';
        return;
    }

    if (options.loading) {
        pacienteDetalleDocs.innerHTML = '<span class="text-muted">Cargando documentos…</span>';
        pacienteDetalleSituaciones.innerHTML = '<span class="text-muted">Cargando registros…</span>';
        return;
    }

    const documentos = PACIENTE_REGISTROS_CACHE.documentos.get(nombre) || [];
    if (!documentos.length) {
        pacienteDetalleDocs.innerHTML = '<span class="text-muted">Sin documentos cargados aún.</span>';
    } else {
        pacienteDetalleDocs.innerHTML = documentos.slice(0, 3).map(doc => {
            const descripcion = doc.descripcion || doc.nombre_archivo || doc.tipo_documento;
            const fecha = doc.fecha_documento ? formatDateOnly(doc.fecha_documento) : formatDateTime(doc.fecha_registro);
            return `<div class="d-flex justify-content-between small mb-1"><span>${descripcion}</span><span class="text-muted">${fecha}</span></div>`;
        }).join('');
    }

    const situaciones = PACIENTE_REGISTROS_CACHE.situaciones.get(nombre) || [];
    if (!situaciones.length) {
        pacienteDetalleSituaciones.innerHTML = '<span class="text-muted">Sin situaciones registradas.</span>';
    } else {
        pacienteDetalleSituaciones.innerHTML = situaciones.slice(0, 2).map(item => {
            const resumen = (item.situacion_actual || item.motivo_consulta || 'Sin detalle').trim();
            const texto = resumen.length > 80 ? `${resumen.slice(0, 77)}…` : resumen;
            return `<div class="small mb-1"><span class="font-w600 mr-1">${formatDateTime(item.fecha_registro)}</span>${texto}</div>`;
        }).join('');
    }
}

function syncPacienteSelectors(nombre) {
    if (!nombre) return;
    const selectSituacion = document.getElementById('situacion-paciente');
    if (selectSituacion && Array.from(selectSituacion.options).some(opt => opt.value === nombre)) {
        selectSituacion.value = nombre;
    }
    if (documentoPacienteSelect && Array.from(documentoPacienteSelect.options).some(opt => opt.value === nombre)) {
        documentoPacienteSelect.value = nombre;
    }
}

async function seleccionarPaciente(nombre, options = {}) {
    if (!nombre) return;
    TELEMED_STATE.pacienteActivo = nombre;
    SITUACION_FILTROS.paciente = nombre;
    DOCUMENTOS_FILTROS.paciente = nombre;
    syncSituacionFilterInputs();
    syncDocumentosFilterInputs();
    syncPacienteSelectors(nombre);
    renderPacientesTable();
    renderPacienteDetalle(nombre);
    if (options.cargarRegistros === false) return;
    renderPacienteDetalleRegistros(nombre, { loading: true });
    await Promise.all([cargarSituaciones(nombre), cargarDocumentos(nombre)]);
    renderPacienteDetalleRegistros(nombre);
}

function refreshPacienteSelectors() {
    const listado = uniquePacientes();
    const selectSituacion = document.getElementById('situacion-paciente');
    if (selectSituacion) {
        const previo = selectSituacion.value;
        selectSituacion.innerHTML = '<option value="" disabled selected>Selecciona o registra primero un paciente</option>';
        listado.forEach(nombre => {
            const option = document.createElement('option');
            option.value = nombre;
            option.textContent = nombre;
            selectSituacion.appendChild(option);
        });
        if (previo && listado.includes(previo)) {
            selectSituacion.value = previo;
        } else if (TELEMED_STATE.pacienteActivo && listado.includes(TELEMED_STATE.pacienteActivo)) {
            selectSituacion.value = TELEMED_STATE.pacienteActivo;
        }
    }

    const selectDocumento = document.getElementById('documento-paciente');
    if (selectDocumento) {
        const previo = selectDocumento.value;
        selectDocumento.innerHTML = '<option value="" disabled selected>Selecciona un paciente registrado</option>';
        listado.forEach(nombre => {
            const option = document.createElement('option');
            option.value = nombre;
            option.textContent = nombre;
            selectDocumento.appendChild(option);
        });
        const preferido = DOCUMENTOS_FILTROS.paciente || TELEMED_STATE.pacienteActivo;
        if (preferido && listado.includes(preferido)) {
            selectDocumento.value = preferido;
        } else if (previo && listado.includes(previo)) {
            selectDocumento.value = previo;
        } else if (TELEMED_STATE.pacienteActivo && listado.includes(TELEMED_STATE.pacienteActivo)) {
            selectDocumento.value = TELEMED_STATE.pacienteActivo;
        }
    }

    if (situacionFiltroPaciente) {
        const previo = situacionFiltroPaciente.value;
        situacionFiltroPaciente.innerHTML = '<option value="">Todos los pacientes</option>';
        listado.forEach(nombre => {
            const option = document.createElement('option');
            option.value = nombre;
            option.textContent = nombre;
            situacionFiltroPaciente.appendChild(option);
        });
        if (SITUACION_FILTROS.paciente && listado.includes(SITUACION_FILTROS.paciente)) {
            situacionFiltroPaciente.value = SITUACION_FILTROS.paciente;
        } else if (previo && listado.includes(previo)) {
            situacionFiltroPaciente.value = previo;
        }
    }

    if (documentosFiltroPaciente) {
        const previo = documentosFiltroPaciente.value;
        documentosFiltroPaciente.innerHTML = '<option value="">Todos los pacientes</option>';
        listado.forEach(nombre => {
            const option = document.createElement('option');
            option.value = nombre;
            option.textContent = nombre;
            documentosFiltroPaciente.appendChild(option);
        });
        if (DOCUMENTOS_FILTROS.paciente && listado.includes(DOCUMENTOS_FILTROS.paciente)) {
            documentosFiltroPaciente.value = DOCUMENTOS_FILTROS.paciente;
        } else if (previo && listado.includes(previo)) {
            documentosFiltroPaciente.value = previo;
        }
    }
}

function renderSituaciones() {
    const container = document.getElementById('situaciones-lista');
    if (!container) return;
    container.innerHTML = '';
    if (!TELEMED_STATE.situaciones.length) {
        container.innerHTML = `
            <div class="col-12">
                <div class="text-center text-muted py-4 border rounded">
                    Aún no registraste la situación clínica de este paciente.
                </div>
            </div>`;
        return;
    }

    const listado = document.createElement('div');
    listado.className = 'col-12';

    TELEMED_STATE.situaciones.forEach((item, index) => {
        const detalleId = `situacion-detalle-${item.id || index}`;
        const card = document.createElement('div');
        card.className = 'situacion-item border rounded mb-3';
        const diagnosticosInfo = construirDiagnosticosInfo(item.diagnostico_cie10);
        const tipoConsulta = item.tipo_consulta_personalizada || item.tipo_consulta || 'Consulta';
        const resumenBase = (item.situacion_actual || item.motivo_consulta || 'Sin detalles').trim();
        const resumenTexto = resumenBase.length > 180 ? `${resumenBase.slice(0, 177)}…` : resumenBase;

        card.innerHTML = `
            <div class="situacion-header d-flex justify-content-between align-items-center p-3" data-detalle="${detalleId}">
                <div>
                    <div class="d-flex flex-wrap align-items-center mb-1">
                        <span class="badge badge-success mr-2">${diagnosticosInfo.principalTexto}</span>
                        <small class="text-muted">${formatDateTime(item.fecha_registro)}</small>
                    </div>
                    <div class="text-muted small">${tipoConsulta}</div>
                    <div class="font-w600">${resumenTexto}</div>
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary situacion-toggle" data-detalle="${detalleId}">
                    Ver detalles
                </button>
            </div>
            <div id="${detalleId}" class="situacion-detalle d-none border-top">
                <div class="p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                        <div class="mb-2 mb-sm-0">${diagnosticosInfo.listadoHtml}</div>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-primary mr-2 situacion-edit" data-id="${item.id}">Editar</button>
                            <button type="button" class="btn btn-sm btn-outline-danger situacion-delete" data-id="${item.id}">Eliminar</button>
                        </div>
                    </div>
                    <div class="btn-group btn-group-sm situacion-detail-tabs" role="group" data-base="${detalleId}">
                        <button type="button" class="btn btn-primary situacion-detail-tab active" data-target="${detalleId}-situacion-pane">Situación actual</button>
                        <button type="button" class="btn btn-outline-primary situacion-detail-tab" data-target="${detalleId}-dimision-pane">Indicaciones / Dimisión</button>
                    </div>
                    <div id="${detalleId}-situacion-pane" class="situacion-pane mt-3">
                        ${renderDetalleClinico('Motivo de consulta', item.motivo_consulta)}
                        ${renderDetalleClinico('Historia de enfermedad actual', item.historia_enfermedad_actual)}
                        ${renderDetalleClinico('Antecedentes personales relevantes', item.antecedentes_personales)}
                        ${renderDetalleClinico('Laboratorios relevantes', item.laboratorios)}
                        ${renderDetalleClinico('Estudios complementarios / imágenes', item.estudios_complementarios)}
                        ${renderDetalleClinico('Interconsultas', item.interconsultas)}
                        ${renderDetalleClinico('Resumen de situación actual', item.situacion_actual)}
                    </div>
                    <div id="${detalleId}-dimision-pane" class="situacion-pane mt-3 d-none">
                        ${renderDetalleClinico('Informe / Epicrisis', item.informe_dimision)}
                        ${renderDetalleClinico('Tratamiento farmacológico', item.tratamiento_farmacologico)}
                        ${renderDetalleClinico('Medidas no farmacológicas y cambios de estilo de vida', item.medidas_estilo_vida)}
                        ${renderDetalleClinico('Signos de alarma', item.signos_alarma)}
                        ${renderDetalleClinico('Próximos controles y seguimiento', item.proximos_controles)}
                    </div>
                </div>
            </div>
        `;
        listado.appendChild(card);
    });

    container.appendChild(listado);
    initSituacionToggles();
}

function renderDocumentos() {
    const container = document.getElementById('documentos-grid');
    if (!container) return;
    container.innerHTML = '';
    if (!TELEMED_STATE.documentos.length) {
        container.innerHTML = `
            <div class="col-12">
                <div class="text-center text-muted py-4 border rounded">
                    Todavía no hay archivos registrados para este paciente.
                </div>
            </div>`;
        return;
    }

    TELEMED_STATE.documentos.forEach(doc => {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4';
        const etiquetas = Array.isArray(doc.etiquetas)
            ? doc.etiquetas
            : (typeof doc.etiquetas === 'string' ? doc.etiquetas.split(',').map(tag => tag.trim()).filter(Boolean) : []);
        const etiquetasHtml = etiquetas.length
            ? etiquetas.map(et => `<span class="badge badge-info mr-1 mb-1">${et}</span>`).join('')
            : '<span class="text-muted small">Sin etiquetas</span>';
        const fechaTexto = doc.fecha_documento ? formatDateOnly(doc.fecha_documento) : formatDateTime(doc.fecha_registro);
        const descripcion = doc.descripcion || doc.nombre_archivo || 'Documento sin descripción';
        const archivoInfo = doc.nombre_archivo
            ? `${doc.nombre_archivo} • ${formatFileSize(doc.tamano_archivo)}`
            : 'Archivo disponible en Google Drive';
        col.innerHTML = `
            <div class="border rounded h-100 p-3 shadow-sm mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge badge-secondary text-uppercase">${(doc.tipo_documento || 'documento')}</span>
                    <small class="text-muted">${fechaTexto}</small>
                </div>
                <p class="font-w600 mb-1">${descripcion}</p>
                <p class="small text-muted mb-2">${archivoInfo}</p>
                <div class="mb-3">${etiquetasHtml}</div>
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">${doc.paciente_nombre || ''}</small>
                    <a href="${doc.drive_url}" class="btn btn-sm btn-outline-info" target="_blank" rel="noopener">
                        <i class="fa fa-external-link-alt mr-1"></i>Ver en Drive
                    </a>
                </div>
            </div>`;
        container.appendChild(col);
    });
}

function aplicarFiltrosSituacion(event) {
    if (event) event.preventDefault();
    SITUACION_FILTROS.paciente = (situacionFiltroPaciente && situacionFiltroPaciente.value) || '';
    SITUACION_FILTROS.desde = situacionFiltroDesde ? situacionFiltroDesde.value : '';
    SITUACION_FILTROS.hasta = situacionFiltroHasta ? situacionFiltroHasta.value : '';
    SITUACION_FILTROS.cie10 = situacionFiltroCie10 ? situacionFiltroCie10.value.trim() : '';
    cargarSituaciones();
}

function limpiarFiltrosSituacion() {
    SITUACION_FILTROS.paciente = '';
    SITUACION_FILTROS.desde = '';
    SITUACION_FILTROS.hasta = '';
    SITUACION_FILTROS.cie10 = '';
    syncSituacionFilterInputs();
    cargarSituaciones();
}

function aplicarFiltrosDocumentos(event) {
    if (event) event.preventDefault();
    DOCUMENTOS_FILTROS.paciente = (documentosFiltroPaciente && documentosFiltroPaciente.value) || '';
    DOCUMENTOS_FILTROS.tipo = (documentosFiltroTipo && documentosFiltroTipo.value) || '';
    DOCUMENTOS_FILTROS.desde = documentosFiltroDesde ? documentosFiltroDesde.value : '';
    DOCUMENTOS_FILTROS.hasta = documentosFiltroHasta ? documentosFiltroHasta.value : '';
    DOCUMENTOS_FILTROS.search = documentosFiltroSearch ? documentosFiltroSearch.value.trim() : '';
    cargarDocumentos();
}

function limpiarFiltrosDocumentos() {
    DOCUMENTOS_FILTROS.paciente = '';
    DOCUMENTOS_FILTROS.tipo = '';
    DOCUMENTOS_FILTROS.desde = '';
    DOCUMENTOS_FILTROS.hasta = '';
    DOCUMENTOS_FILTROS.search = '';
    syncDocumentosFilterInputs();
    cargarDocumentos();
}

function renderCIE10Tags() {
    if (!cie10Tags) return;
    const diagnosticos = TELEMED_STATE.cie10Diagnosticos;
    if (!diagnosticos.length) {
        cie10Tags.innerHTML = '<span class="text-muted small">Sin diagnósticos seleccionados.</span>';
        return;
    }

    cie10Tags.innerHTML = '';
    diagnosticos.forEach((item, index) => {
        const badge = document.createElement('span');
        badge.className = 'badge badge-pill badge-primary mr-2 mb-2 d-inline-flex align-items-center';
        const estrellaClass = item.principal ? 'text-warning' : 'text-white-50';
        badge.innerHTML = `
            <button type="button" class="btn btn-link btn-sm ${estrellaClass} p-0 mr-2" title="Marcar como diagnóstico principal">
                <i class="fa fa-star"></i>
            </button>
            <span>${item.code} • ${item.name}</span>
            <button type="button" class="btn btn-link btn-sm text-white ml-2 p-0">&times;</button>`;
        const [starBtn, removeBtn] = badge.querySelectorAll('button');
        starBtn.addEventListener('click', () => marcarDiagnosticoPrincipal(index));
        removeBtn.addEventListener('click', () => {
            TELEMED_STATE.cie10Diagnosticos.splice(index, 1);
            if (!TELEMED_STATE.cie10Diagnosticos.some(d => d.principal) && TELEMED_STATE.cie10Diagnosticos.length) {
                TELEMED_STATE.cie10Diagnosticos[0].principal = true;
            }
            renderCIE10Tags();
        });
        cie10Tags.appendChild(badge);
    });
}

function renderCIE10Suggestions(suggestions) {
    if (!cie10Suggestions) return;
    cie10Suggestions.innerHTML = '';
    if (!suggestions.length) {
        cie10Suggestions.innerHTML = `
            <div class="list-group-item small text-muted">
                Sin coincidencias. Presioná ENTER para agregar el diagnóstico manualmente.
            </div>`;
        cie10Suggestions.classList.remove('d-none');
        return;
    }

    suggestions.slice(0, 10).forEach(item => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'list-group-item list-group-item-action';
        button.textContent = `${item.code} • ${item.name}`;
        button.addEventListener('click', () => {
            agregarDiagnosticoCIE10(item);
            if (cie10Input) cie10Input.value = '';
            cie10Suggestions.classList.add('d-none');
        });
        cie10Suggestions.appendChild(button);
    });
    cie10Suggestions.classList.remove('d-none');
}

function agregarDiagnosticoCIE10(item) {
    if (!item || !item.code || !item.name) return;
    const exists = TELEMED_STATE.cie10Diagnosticos.some(
        d => d.code === item.code && d.name === item.name
    );
    if (!exists) {
        TELEMED_STATE.cie10Diagnosticos.push({
            code: item.code,
            name: item.name,
            principal: TELEMED_STATE.cie10Diagnosticos.length === 0
        });
        renderCIE10Tags();
    }
}

function agregarDiagnosticoManual() {
    if (!cie10Input) return;
    const valor = cie10Input.value.trim();
    if (!valor) return;
    const match = valor.match(/^[A-Za-z]\d{1,3}[A-Za-z0-9]?/);
    const code = match ? match[0].toUpperCase() : 'SN/CIE10';
    const descripcion = match ? valor.slice(match[0].length).trim() || valor : valor;
    agregarDiagnosticoCIE10({ code, name: descripcion });
    cie10Input.value = '';
    if (cie10Suggestions) cie10Suggestions.classList.add('d-none');
}

function marcarDiagnosticoPrincipal(index) {
    TELEMED_STATE.cie10Diagnosticos = TELEMED_STATE.cie10Diagnosticos.map((item, idx) => ({
        ...item,
        principal: idx === index
    }));
    renderCIE10Tags();
}

function collectDocumentoMeta() {
    return {
        paciente: (documentoPacienteSelect && documentoPacienteSelect.value) || DOCUMENTOS_FILTROS.paciente || TELEMED_STATE.pacienteActivo || '',
        tipo: documentoTipoSelect ? documentoTipoSelect.value : 'laboratorio',
        fecha: documentoFechaInput ? documentoFechaInput.value : '',
        descripcion: documentoDescripcionInput ? documentoDescripcionInput.value : '',
        etiquetas: documentoEtiquetasInput ? documentoEtiquetasInput.value : '',
        notas: documentoNotasInput ? documentoNotasInput.value : ''
    };
}

function createUploadItemElement(uploadId, file, meta) {
    const wrapper = document.createElement('div');
    wrapper.className = 'telemed-upload-item';
    wrapper.dataset.uploadId = uploadId;
    wrapper.innerHTML = `
        <div>
            <div class="font-w600">${file.name}</div>
            <small class="text-muted">${formatFileSize(file.size)} • ${meta.paciente}</small>
        </div>
        <div class="telemed-upload-status text-info">Pendiente</div>
    `;
    return wrapper;
}

function setUploadItemStatus(uploadId, status, message) {
    const info = DOCUMENT_UPLOAD_ITEMS.get(uploadId);
    if (!info) return;
    const statusElement = info.element.querySelector('.telemed-upload-status');
    if (!statusElement) return;
    statusElement.textContent = message || status;
    statusElement.classList.remove('text-info', 'text-success', 'text-danger');
    if (status === 'uploading') {
        statusElement.classList.add('text-info');
    } else if (status === 'success') {
        statusElement.classList.add('text-success');
    } else {
        statusElement.classList.add('text-danger');
    }
}

async function uploadDocumentoArchivo(uploadId) {
    const info = DOCUMENT_UPLOAD_ITEMS.get(uploadId);
    if (!info) return;
    setUploadItemStatus(uploadId, 'uploading', 'Subiendo…');
    const meta = info.meta;
    const formData = new FormData();
    formData.append('archivo', info.file);
    formData.append('paciente_nombre', meta.paciente);
    formData.append('tipo_documento', meta.tipo || 'laboratorio');
    if (meta.fecha) formData.append('fecha_documento', meta.fecha);
    formData.append('descripcion', meta.descripcion || info.file.name);
    if (meta.etiquetas) formData.append('etiquetas', meta.etiquetas);
    if (meta.notas) formData.append('notas', meta.notas);
    try {
        const response = await fetch('/api/telemed/documentos/upload', { method: 'POST', body: formData });
        const data = await response.json();
        if (!data.success) throw new Error(data.error || 'No se pudo subir el documento');
        setUploadItemStatus(uploadId, 'success', 'Completado');
        TELEMED_STATE.pacienteActivo = meta.paciente;
        syncPacienteSelectors(meta.paciente);
        renderPacientesTable();
        await cargarDocumentos(meta.paciente);
        renderPacienteDetalle(meta.paciente);
        setTimeout(() => removeUploadItem(uploadId), 3500);
    } catch (error) {
        setUploadItemStatus(uploadId, 'error', 'Error');
        showTelemedAlert('danger', error.message);
    }
}

function removeUploadItem(uploadId) {
    const info = DOCUMENT_UPLOAD_ITEMS.get(uploadId);
    if (!info) return;
    if (info.element && info.element.parentNode) {
        info.element.parentNode.removeChild(info.element);
    }
    DOCUMENT_UPLOAD_ITEMS.delete(uploadId);
}

function handleDocumentFiles(fileList) {
    if (!fileList || !fileList.length) return;
    if (!DRIVE_READY) {
        showTelemedAlert('warning', 'Configura las credenciales de Google Drive para habilitar las subidas automáticas.');
        return;
    }
    const meta = collectDocumentoMeta();
    if (!meta.paciente) {
        showTelemedAlert('warning', 'Seleccioná un paciente antes de subir los documentos.');
        return;
    }
    Array.from(fileList).forEach(file => {
        const uploadId = `upload-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
        const item = createUploadItemElement(uploadId, file, meta);
        DOCUMENT_UPLOAD_ITEMS.set(uploadId, { element: item, file, meta });
        if (documentosUploadList) {
            documentosUploadList.prepend(item);
        }
        uploadDocumentoArchivo(uploadId);
    });
}

function initDocumentUploadUI() {
    if (documentosDropzone) {
        documentosDropzone.addEventListener('click', () => {
            if (!DRIVE_READY) {
                showTelemedAlert('warning', 'Configura Google Drive antes de subir archivos.');
                return;
            }
            if (documentosFileInput) documentosFileInput.click();
        });
        ['dragover', 'dragenter'].forEach(eventName => {
            documentosDropzone.addEventListener(eventName, event => {
                event.preventDefault();
                if (!DRIVE_READY) return;
                documentosDropzone.classList.add('dragover');
            });
        });
        ['dragleave', 'drop'].forEach(eventName => {
            documentosDropzone.addEventListener(eventName, event => {
                event.preventDefault();
                documentosDropzone.classList.remove('dragover');
            });
        });
        documentosDropzone.addEventListener('drop', event => {
            if (!DRIVE_READY) {
                showTelemedAlert('warning', 'Configura Google Drive antes de subir archivos.');
                return;
            }
            handleDocumentFiles(event.dataTransfer.files);
        });
    }

    if (documentosBrowseBtn && documentosFileInput) {
        documentosBrowseBtn.addEventListener('click', () => {
            if (!DRIVE_READY) {
                showTelemedAlert('warning', 'Configura Google Drive antes de subir archivos.');
                return;
            }
            documentosFileInput.click();
        });
        documentosFileInput.addEventListener('change', event => {
            handleDocumentFiles(event.target.files);
            documentosFileInput.value = '';
        });
    }

    if (documentosRefreshBtn) {
        documentosRefreshBtn.addEventListener('click', async () => {
            await cargarDocumentos();
        });
    }
}

function initSituacionToggles() {
    const toggles = document.querySelectorAll('.situacion-toggle');
    toggles.forEach(btn => {
        btn.addEventListener('click', event => {
            event.stopPropagation();
            toggleSituacionDetalle(btn.dataset.detalle, btn);
        });
    });

    const headers = document.querySelectorAll('.situacion-header');
    headers.forEach(header => {
        header.addEventListener('click', event => {
            if (event.target.closest('.situacion-toggle')) return;
            const detalleId = header.dataset.detalle;
            const relatedBtn = header.querySelector('.situacion-toggle');
            toggleSituacionDetalle(detalleId, relatedBtn);
        });
    });

    document.querySelectorAll('.situacion-detail-tab').forEach(btn => {
        btn.addEventListener('click', event => {
            event.stopPropagation();
            setSituacionDetailTab(event.currentTarget);
        });
    });

    document.querySelectorAll('.situacion-edit').forEach(btn => {
        btn.addEventListener('click', event => {
            event.stopPropagation();
            const situacion = getSituacionById(btn.dataset.id);
            if (situacion) {
                startSituacionEditing(situacion);
            } else {
                showTelemedAlert('warning', 'No se pudo cargar la situación seleccionada.');
            }
        });
    });

    document.querySelectorAll('.situacion-delete').forEach(btn => {
        btn.addEventListener('click', event => {
            event.stopPropagation();
            handleSituacionDelete(btn.dataset.id);
        });
    });
}

function toggleSituacionDetalle(detalleId, button) {
    const panel = document.getElementById(detalleId);
    if (!panel) return;
    panel.classList.toggle('d-none');
    const abierto = !panel.classList.contains('d-none');
    if (button) {
        button.textContent = abierto ? 'Ocultar detalles' : 'Ver detalles';
    }
}

function setSituacionDetailTab(button) {
    if (!button) return;
    const group = button.closest('.situacion-detail-tabs');
    if (!group) return;
    const targetId = button.dataset.target;
    if (!targetId) return;
    const panel = document.getElementById(targetId);
    if (!panel) return;

    const base = group.dataset.base;
    group.querySelectorAll('.situacion-detail-tab').forEach(btn => {
        if (btn === button) {
            btn.classList.add('active');
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-primary');
        } else {
            btn.classList.remove('active');
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-primary');
        }
    });

    const panes = document.querySelectorAll(`#${base}-situacion-pane, #${base}-dimision-pane`);
    panes.forEach(p => {
        if (p.id === targetId) {
            p.classList.remove('d-none');
        } else {
            p.classList.add('d-none');
        }
    });
}

function normalizarDiagnosticosLista(raw) {
    if (!raw) return [];
    if (Array.isArray(raw)) {
        return raw
            .map(item => ({
                code: (item.code || item.c || '').toString().trim(),
                name: (item.name || item.d || '').toString().trim(),
                principal: Boolean(item.principal || item.main || item.principal === 'true')
            }))
            .filter(entry => entry.code || entry.name);
    }
    if (typeof raw === 'string') {
        return raw.split(';').map(fragmento => {
            const texto = fragmento.trim();
            if (!texto) return null;
            const partes = texto.split(' ');
            const code = (partes.shift() || '').trim();
            const name = partes.join(' ').trim();
            return {
                code: code || 'SN/CIE10',
                name: name || texto,
                principal: false
            };
        }).filter(Boolean);
    }
    return [];
}

function construirDiagnosticosInfo(raw) {
    const lista = normalizarDiagnosticosLista(raw);
    if (!lista.length) {
        return {
            principalHtml: '<span class="badge badge-light text-muted">Sin diagnósticos</span>',
            principalTexto: 'Sin diagnóstico',
            listadoHtml: '<span class="text-muted small">Agrega diagnósticos desde el formulario.</span>'
        };
    }
    const principal = lista.find(d => d.principal) || lista[0];
    const principalHtml = `
        <span class="badge badge-success text-uppercase d-inline-flex align-items-center">
            <i class="fa fa-star text-warning mr-1"></i>${principal.code} • ${principal.name}
        </span>`;
    const listadoHtml = lista.map(d => `
        <span class="badge ${d.principal ? 'badge-warning text-dark' : 'badge-primary'} mr-1 mb-1">
            ${d.code} • ${d.name}${d.principal ? ' ⭐' : ''}
        </span>
    `).join('');
    return {
        principalHtml,
        principalTexto: `${principal.code} • ${principal.name}`,
        listadoHtml
    };
}

function renderDetalleClinico(titulo, contenido, destacado = false) {
    const texto = (contenido && contenido.trim()) ? contenido : '—';
    const clase = destacado ? 'bg-primary-light' : 'bg-light';
    return `
        <div class="${clase} rounded p-2 mb-2">
            <small class="text-uppercase text-muted">${titulo}</small>
            <p class="mb-0">${texto}</p>
        </div>`;
}

function handleCIE10Input(event) {
    const term = event.target.value.trim();
    if (cie10SearchTimeout) clearTimeout(cie10SearchTimeout);
    if (!term || term.length < 2) {
        if (cie10Suggestions) cie10Suggestions.classList.add('d-none');
        return;
    }

    if (cie10Suggestions) {
        const mensaje = (cie10Catalogo.length || cie10CatalogPromise)
            ? 'Buscando coincidencias…'
            : 'Descargando catálogo CIE-10 en español…';
        cie10Suggestions.innerHTML = `<div class="list-group-item small text-muted">${mensaje}</div>`;
        cie10Suggestions.classList.remove('d-none');
    }

    cie10SearchTimeout = setTimeout(async () => {
        try {
            const suggestions = await buscarCIE10(term);
            renderCIE10Suggestions(suggestions);
        } catch (error) {
            renderCIE10Suggestions([]);
        }
    }, 250);
}

function resetCIE10State() {
    TELEMED_STATE.cie10Diagnosticos = [];
    if (cie10Input) cie10Input.value = '';
    renderCIE10Tags();
    if (cie10Suggestions) cie10Suggestions.classList.add('d-none');
}

async function cargarPacientes() {
    try {
        const response = await fetch('/api/telemed/pacientes');
        const data = await response.json();
        if (!data.success) throw new Error(data.error || 'No se pudo cargar la ficha de pacientes');
        TELEMED_STATE.pacientes = data.pacientes || [];
        if (!TELEMED_STATE.pacienteActivo && PACIENTE_INICIAL) {
            TELEMED_STATE.pacienteActivo = PACIENTE_INICIAL;
        }
        if (!TELEMED_STATE.pacienteActivo && TELEMED_STATE.pacientes.length) {
            TELEMED_STATE.pacienteActivo = obtenerNombrePaciente(TELEMED_STATE.pacientes[0]);
        }
        if (TELEMED_STATE.pacienteActivo) {
            const existe = buscarPacientePorNombre(TELEMED_STATE.pacienteActivo);
            if (!existe && TELEMED_STATE.pacientes.length) {
                TELEMED_STATE.pacienteActivo = obtenerNombrePaciente(TELEMED_STATE.pacientes[0]);
            }
        }
        renderPacientesTable();
        refreshPacienteSelectors();
        syncSituacionFilterInputs();
        syncDocumentosFilterInputs();
        renderPacienteDetalle(TELEMED_STATE.pacienteActivo);
    } catch (error) {
        showTelemedAlert('danger', error.message);
    }
}

async function cargarSituaciones(paciente) {
    if (paciente) {
        SITUACION_FILTROS.paciente = paciente;
        syncSituacionFilterInputs();
    }
    const params = new URLSearchParams();
    if (SITUACION_FILTROS.paciente) params.append('paciente', SITUACION_FILTROS.paciente);
    if (SITUACION_FILTROS.desde) params.append('fecha_desde', SITUACION_FILTROS.desde);
    if (SITUACION_FILTROS.hasta) params.append('fecha_hasta', SITUACION_FILTROS.hasta);
    if (SITUACION_FILTROS.cie10) params.append('cie10', SITUACION_FILTROS.cie10);
    let url = '/api/telemed/situacion';
    if (params.toString()) url += `?${params.toString()}`;
    try {
        const response = await fetch(url);
        const data = await response.json();
        if (!data.success) throw new Error(data.error || 'No se pudo cargar la situación actual');
        TELEMED_STATE.situaciones = data.situaciones || [];
        const key = SITUACION_FILTROS.paciente || '';
        if (key) {
            PACIENTE_REGISTROS_CACHE.situaciones.set(key, TELEMED_STATE.situaciones.slice());
            if (TELEMED_STATE.pacienteActivo === key) {
                renderPacienteDetalleRegistros(key);
            }
        }
        renderSituaciones();
    } catch (error) {
        showTelemedAlert('warning', error.message);
    }
}

async function cargarDocumentos(paciente) {
    if (paciente) {
        DOCUMENTOS_FILTROS.paciente = paciente;
        syncDocumentosFilterInputs();
    }
    const params = new URLSearchParams();
    if (DOCUMENTOS_FILTROS.paciente) params.append('paciente', DOCUMENTOS_FILTROS.paciente);
    if (DOCUMENTOS_FILTROS.tipo) params.append('tipo', DOCUMENTOS_FILTROS.tipo);
    if (DOCUMENTOS_FILTROS.desde) params.append('fecha_desde', DOCUMENTOS_FILTROS.desde);
    if (DOCUMENTOS_FILTROS.hasta) params.append('fecha_hasta', DOCUMENTOS_FILTROS.hasta);
    if (DOCUMENTOS_FILTROS.search) params.append('q', DOCUMENTOS_FILTROS.search);
    let url = '/api/telemed/documentos';
    if (params.toString()) url += `?${params.toString()}`;
    try {
        const response = await fetch(url);
        const data = await response.json();
        if (!data.success) throw new Error(data.error || 'No se pudieron cargar los documentos');
        TELEMED_STATE.documentos = data.documentos || [];
        const key = DOCUMENTOS_FILTROS.paciente || '';
        if (key) {
            PACIENTE_REGISTROS_CACHE.documentos.set(key, TELEMED_STATE.documentos.slice());
            if (TELEMED_STATE.pacienteActivo === key) {
                renderPacienteDetalleRegistros(key);
            }
        }
        renderDocumentos();
    } catch (error) {
        showTelemedAlert('warning', error.message);
    }
}

function buscarPacientePorNombre(nombre) {
    if (!nombre) return null;
    return TELEMED_STATE.pacientes.find(p => {
        const fullName = obtenerNombrePaciente(p);
        return fullName === nombre;
    }) || null;
}

function obtenerNombrePaciente(paciente) {
    if (!paciente) return '';
    const full = paciente.paciente_nombre || [paciente.nombre, paciente.apellido].filter(Boolean).join(' ');
    return full.trim();
}

function filtrarPacientesPorBusqueda() {
    if (!pacienteSearchTerm) return TELEMED_STATE.pacientes;
    const filtro = pacienteSearchTerm.toLowerCase();
    return TELEMED_STATE.pacientes.filter(paciente => {
        const fullName = obtenerNombrePaciente(paciente).toLowerCase();
        const documento = (paciente.paciente_dni || paciente.documento || '').toLowerCase();
        return fullName.includes(filtro) || documento.includes(filtro);
    });
}

function handlePacienteSubmit(event) {
    event.preventDefault();
    const formData = new FormData(fichaForm);
    const nombre = (formData.get('nombre') || '').trim();
    const apellido = (formData.get('apellido') || '').trim();
    const pacienteNombre = (formData.get('paciente_nombre') || '').trim() || [nombre, apellido].filter(Boolean).join(' ');
    if (!pacienteNombre) {
        showTelemedAlert('warning', 'Completá nombre y apellido del paciente.');
        return;
    }

    const payload = {
        id: TELEMED_STATE.editingPacienteId,
        nombre,
        apellido,
        paciente_nombre: pacienteNombre,
        fecha_nacimiento: formData.get('fecha_nacimiento'),
        documento_tipo: formData.get('documento_tipo'),
        paciente_dni: formData.get('paciente_dni'),
        documento: formData.get('documento'),
        telefono: formData.get('telefono'),
        altura_cm: formData.get('altura_cm'),
        peso_kg: formData.get('peso_kg'),
        alergias: formData.get('alergias'),
        patologias_previas: formData.get('patologias_previas'),
        antecedentes: formData.get('antecedentes'),
        notas: formData.get('notas'),
        es_fumador: fichaForm.es_fumador.checked,
        activo_sexualmente: fichaForm.activo_sexualmente.checked,
        embarazo: fichaForm.embarazo.checked
    };

    fetch('/api/telemed/pacientes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
        .then(res => res.json())
        .then(async data => {
            if (!data.success) throw new Error(data.error || 'No se pudo guardar la ficha');
            const mensaje = data.updated ? 'Ficha actualizada correctamente.' : 'Ficha guardada correctamente.';
            showTelemedAlert('success', mensaje);
            TELEMED_STATE.pacienteActivo = pacienteNombre;
            resetPacienteForm();
            await cargarPacientes();
            await cargarSituaciones(pacienteNombre);
            await cargarDocumentos(pacienteNombre);
        })
        .catch(error => showTelemedAlert('danger', error.message));
}

function handleSituacionSubmit(event) {
    event.preventDefault();
    const formData = new FormData(situacionForm);
    const pacienteNombre = formData.get('paciente_nombre');
    if (!pacienteNombre) {
        showTelemedAlert('warning', 'Selecciona un paciente para registrar la situación.');
        return;
    }
    const paciente = buscarPacientePorNombre(pacienteNombre);

    let tipoConsulta = formData.get('tipo_consulta');
    let tipoConsultaPersonalizado = null;
    if (tipoConsulta === 'otro') {
        tipoConsultaPersonalizado = (formData.get('tipo_consulta_personalizada') || '').trim();
        if (!tipoConsultaPersonalizado) {
            showTelemedAlert('warning', 'Describe el tipo de consulta personalizada.');
            return;
        }
    }
    const editando = Boolean(TELEMED_STATE.editingSituacionId);
    const situacionExistente = editando ? getSituacionById(TELEMED_STATE.editingSituacionId) : null;

    const diagnosticosPayload = TELEMED_STATE.cie10Diagnosticos.map(d => ({
        code: d.code,
        name: d.name,
        principal: !!d.principal
    }));
    const obtenerComplemento = campo => (isComplementoActive(campo) ? (formData.get(campo) || '') : '');

    const payload = {
        id: TELEMED_STATE.editingSituacionId,
        paciente_nombre: pacienteNombre,
        paciente_dni: paciente?.paciente_dni || paciente?.documento || situacionExistente?.paciente_dni || null,
        tipo_consulta: tipoConsulta,
        tipo_consulta_personalizada: tipoConsultaPersonalizado,
        motivo_consulta: formData.get('motivo_consulta'),
        historia_enfermedad_actual: formData.get('historia_enfermedad_actual'),
        antecedentes_personales: formData.get('antecedentes_personales'),
        laboratorios: obtenerComplemento('laboratorios'),
        situacion_actual: formData.get('situacion_actual'),
        estudios_complementarios: obtenerComplemento('estudios_complementarios'),
        interconsultas: obtenerComplemento('interconsultas'),
        tratamiento_farmacologico: formData.get('tratamiento_farmacologico'),
        medidas_estilo_vida: formData.get('medidas_estilo_vida'),
        signos_alarma: formData.get('signos_alarma'),
        proximos_controles: formData.get('proximos_controles'),
        diagnosticos: diagnosticosPayload,
        informe_dimision: formData.get('informe_dimision'),
        etiquetas: []
    };

    fetch('/api/telemed/situacion', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
        .then(res => res.json())
        .then(async data => {
            if (!data.success) throw new Error(data.error || 'No se pudo guardar la situación clínica');
            const mensaje = editando ? 'Situación clínica actualizada.' : 'Situación clínica registrada.';
            showTelemedAlert('success', mensaje);
            resetSituacionForm(pacienteNombre);
            TELEMED_STATE.pacienteActivo = pacienteNombre;
            await cargarSituaciones(pacienteNombre);
        })
        .catch(error => showTelemedAlert('danger', error.message));
}

async function handleSituacionDelete(id) {
    if (!id) return;
    const confirmar = window.confirm('¿Deseás eliminar este registro de situación clínica? Esta acción no se puede deshacer.');
    if (!confirmar) return;
    try {
        const response = await fetch('/api/telemed/situacion', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id })
        });
        const data = await response.json();
        if (!data.success) throw new Error(data.error || 'No se pudo eliminar la situación clínica');
        showTelemedAlert('success', 'Situación clínica eliminada.');
        if (Number(TELEMED_STATE.editingSituacionId) === Number(id)) {
            resetSituacionForm();
        }
        const paciente = TELEMED_STATE.pacienteActivo || situacionForm?.paciente_nombre?.value || '';
        await cargarSituaciones(paciente);
    } catch (error) {
        showTelemedAlert('danger', error.message);
    }
}


function initListeners() {
    refreshAutoGrow();
    updateSituacionSubmitButton();
    syncSituacionFilterInputs();
    syncDocumentosFilterInputs();

    if (fichaForm) {
        fichaForm.addEventListener('submit', handlePacienteSubmit);
    }

    if (cancelarEdicionBtn) {
        cancelarEdicionBtn.addEventListener('click', () => {
            resetPacienteForm();
            setPacienteFormVisible(false);
            showTelemedAlert('info', 'Modo edición cancelado.');
        });
    }

    if (cancelarEdicionSituacionBtn) {
        cancelarEdicionSituacionBtn.addEventListener('click', () => {
            const selected = situacionForm?.paciente_nombre?.value || '';
            resetSituacionForm(selected);
            showTelemedAlert('info', 'Edición de situación cancelada.');
        });
    }

    situacionFormTabButtons.forEach(btn => {
        btn.addEventListener('click', () => setSituacionFormTab(btn.dataset.tabTarget));
    });

    document.querySelectorAll('.complemento-toggle').forEach(btn => {
        btn.addEventListener('click', () => {
            const field = btn.dataset.complemento;
            if (!field) return;
            const isActive = btn.classList.contains('btn-secondary');
            setComplementoActive(field, !isActive, { clear: !isActive ? false : true });
        });
    });

    if (pacienteSearchInput) {
        pacienteSearchInput.addEventListener('input', event => {
            pacienteSearchTerm = event.target.value.trim().toLowerCase();
            renderPacientesTable();
        });
    }

    const selectSituacion = document.getElementById('situacion-paciente');
    if (selectSituacion) {
        selectSituacion.addEventListener('change', async event => {
            const value = event.target.value;
            TELEMED_STATE.pacienteActivo = value;
            SITUACION_FILTROS.paciente = value;
            syncSituacionFilterInputs();
            resetSituacionForm(value);
            await cargarSituaciones(value);
            await cargarDocumentos(value);
            renderPacientesTable();
            renderPacienteDetalle(value);
        });
    }

    if (documentoPacienteSelect) {
        documentoPacienteSelect.addEventListener('change', async event => {
            const value = event.target.value;
            TELEMED_STATE.pacienteActivo = value;
            DOCUMENTOS_FILTROS.paciente = value;
            syncDocumentosFilterInputs();
            renderPacientesTable();
            if (ACTIVE_SECTION === 'documentos') {
                await cargarDocumentos(value);
            }
            renderPacienteDetalle(value);
        });
    }

    if (tipoConsultaSelect && tipoConsultaPersonalizado) {
        tipoConsultaSelect.addEventListener('change', event => {
            if (event.target.value === 'otro') {
                tipoConsultaPersonalizado.classList.remove('d-none');
            } else {
                tipoConsultaPersonalizado.classList.add('d-none');
                tipoConsultaPersonalizado.value = '';
            }
        });
    }

    if (situacionForm) {
        situacionForm.addEventListener('submit', handleSituacionSubmit);
    }

    if (cie10Input) {
        cie10Input.addEventListener('input', handleCIE10Input);
        cie10Input.addEventListener('keydown', event => {
            if (event.key === 'Enter' && cie10Input.value.trim()) {
                event.preventDefault();
                agregarDiagnosticoManual();
            }
        });
        renderCIE10Tags();
    }

    if (btnTogglePacienteForm) {
        btnTogglePacienteForm.addEventListener('click', () => {
            const visible = pacienteFormContainer && !pacienteFormContainer.classList.contains('d-none');
            setPacienteFormVisible(!visible);
        });
    }
    if (btnClosePacienteForm) {
        btnClosePacienteForm.addEventListener('click', () => setPacienteFormVisible(false));
    }
    if (btnHidePacienteForm) {
        btnHidePacienteForm.addEventListener('click', () => setPacienteFormVisible(false));
    }

    if (btnToggleSituacionForm) {
        btnToggleSituacionForm.addEventListener('click', () => {
            const visible = situacionFormWrapper && !situacionFormWrapper.classList.contains('d-none');
            setSituacionFormVisible(!visible);
        });
    }
    if (btnCloseSituacionForm) {
        btnCloseSituacionForm.addEventListener('click', () => setSituacionFormVisible(false));
    }

    if (btnToggleDocumentoForm) {
        btnToggleDocumentoForm.addEventListener('click', () => {
            const visible = documentosFormWrapper && !documentosFormWrapper.classList.contains('d-none');
            setDocumentoFormVisible(!visible);
        });
    }
    if (btnCloseDocumentoForm) {
        btnCloseDocumentoForm.addEventListener('click', () => setDocumentoFormVisible(false));
    }

    if (situacionFiltrosForm) {
        situacionFiltrosForm.addEventListener('submit', aplicarFiltrosSituacion);
    }
    if (situacionFiltrosReset) {
        situacionFiltrosReset.addEventListener('click', limpiarFiltrosSituacion);
    }

    if (documentosFiltrosForm) {
        documentosFiltrosForm.addEventListener('submit', aplicarFiltrosDocumentos);
    }
    if (documentosFiltrosReset) {
        documentosFiltrosReset.addEventListener('click', limpiarFiltrosDocumentos);
    }

    initDocumentUploadUI();
}

document.addEventListener('DOMContentLoaded', async () => {
    initListeners();
    setSituacionFormTab('form-tab-situacion');
    await cargarPacientes();
    if (ACTIVE_SECTION === 'pacientes' && TELEMED_STATE.pacienteActivo) {
        renderPacienteDetalleRegistros(TELEMED_STATE.pacienteActivo, { loading: true });
        await Promise.all([
            cargarSituaciones(TELEMED_STATE.pacienteActivo),
            cargarDocumentos(TELEMED_STATE.pacienteActivo)
        ]);
    } else if (ACTIVE_SECTION === 'situacion') {
        await cargarSituaciones();
    } else if (ACTIVE_SECTION === 'documentos') {
        await cargarDocumentos();
    }
});
</script>
{% endblock %}
